let elements={loginExpiredModal:document.getElementById("loginExpiredModal"),deleteBracketModal:document.getElementById("deleteBracketModal"),deleteBracketModalBody:document.getElementById("deleteBracketModalBody"),deleteBracketButton:document.getElementById("deleteBracketButton"),quitBracketModal:document.getElementById("quitBracketModal"),tierlistEditorModal:document.getElementById("tierlistEditorModal"),tierlistEditor:document.getElementById("tierlistEditor"),previewModal:document.getElementById("previewModal"),previewModalBody:document.getElementById("previewModalBody"),generateChatModal:document.getElementById("generateChatModal"),playlist:document.getElementById("playlist"),generateModal:document.getElementById("generateModal"),generateBracketType:document.getElementById("generateBracketType"),spotifyplaylistSettings:document.getElementById("spotifyplaylistSettings"),tiermakerSettings:document.getElementById("tiermakerSettings"),clipsSettings:document.getElementById("clipsSettings"),emotesSettings:document.getElementById("emotesSettings"),uwufufuSettings:document.getElementById("uwufufuSettings"),ytchannelSettings:document.getElementById("ytchannelSettings"),ytplaylistSettings:document.getElementById("ytplaylistSettings"),publishedModal:document.getElementById("publishedModal"),bracketCode:document.getElementById("bracketCode"),bracketLink:document.getElementById("bracketLink"),spotifyPlaylistLink:document.getElementById("spotifyPlaylistLink"),spotifyPlaylistPreview:document.getElementById("spotifyPlaylistPreview"),tiermakerLink:document.getElementById("tiermakerLink"),tiermakerPreview:document.getElementById("tiermakerPreview"),clipsChannel:document.getElementById("clipsChannel"),clipsPreview:document.getElementById("clipsPreview"),emotesChannel:document.getElementById("emotesChannel"),emotesPreview:document.getElementById("emotesPreview"),uwufufuLink:document.getElementById("uwufufuLink"),uwufufuPreview:document.getElementById("uwufufuPreview"),ytchannelLink:document.getElementById("ytchannelLink"),ytchannelPreview:document.getElementById("ytchannelPreview"),ytplaylistLink:document.getElementById("ytplaylistLink"),ytplaylistPreview:document.getElementById("ytplaylistPreview"),communityModal:document.getElementById("communityModal"),communityModalBody:document.getElementById("communityModalBody"),shareCode:document.getElementById("shareCode"),importModal:document.getElementById("importModal"),importModalBody:document.getElementById("importModalBody"),myBracketsModal:document.getElementById("myBracketsModal"),myBracketsModalBody:document.getElementById("myBracketsModalBody"),startModal:document.getElementById("startModal"),formatSelect:document.getElementById("formatSelect"),optionLimit:document.getElementById("optionLimit"),bracketSettings:document.getElementById("bracketSettings"),tierlistSettings:document.getElementById("tierlistSettings"),changeCommand:document.getElementById("changeCommand"),highestTier:document.getElementById("highestTier"),averageTier:document.getElementById("averageTier"),keepVotingEnabled:document.getElementById("keepVotingEnabled"),disableAnimations:document.getElementById("disableAnimations"),spotifyWarning:document.getElementById("spotifyWarning"),vtsLink:document.getElementById("vtsLink"),status:document.getElementById("status"),topRight:document.getElementById("topRight"),loginButton:document.getElementById("loginButton"),channelName:document.getElementById("channelName"),darkTheme:document.getElementById("darkTheme"),myBrackets:document.getElementById("myBrackets"),importBracket:document.getElementById("importBracket"),bracketEditor:document.getElementById("bracketEditor"),bracketEditorHeader:document.getElementById("bracketEditorHeader"),bracketTitle:document.getElementById("bracketTitle"),bracketDescription:document.getElementById("bracketDescription"),optionContainer:document.getElementById("optionContainer"),addOption:document.getElementById("addOption"),toastContainer:document.getElementById("toastContainer"),bracket:document.getElementById("bracket"),brackets_editor:document.getElementById("brackets_editor"),centerTitle:document.getElementById("centerTitle"),title:document.getElementById("title"),round:document.getElementById("round"),winnerTitle:document.getElementById("winnerTitle"),winner:document.getElementById("winner"),left_container:document.getElementById("left_container"),right_container:document.getElementById("right_container"),left_title:document.getElementById("left_title"),right_title:document.getElementById("right_title"),left_card:document.getElementById("left_card"),left_card_header:document.getElementById("left_card_header"),right_card:document.getElementById("right_card"),right_card_header:document.getElementById("right_card_header"),left_card_zoom_icon:document.getElementById("left_card_zoom_icon"),right_card_zoom_icon:document.getElementById("right_card_zoom_icon"),left_name:document.getElementById("left_name"),right_name:document.getElementById("right_name"),left_score:document.getElementById("left_score"),right_score:document.getElementById("right_score"),left_command:document.getElementById("left_command"),right_command:document.getElementById("right_command"),left_value:document.getElementById("left_value"),text_image_left:document.getElementById("text_image_left"),youtubeEmbedContainer_left:document.getElementById("youtubeEmbedContainer_left"),youtubeEmbed_left:document.getElementById("youtubeEmbed_left"),spotifyEmbedContainer_left:document.getElementById("spotifyEmbedContainer_left"),spotifyEmbed_left:document.getElementById("spotifyEmbed_left"),twitchClipsEmbed_left:document.getElementById("twitchClipsEmbed_left"),videoEmbed_left:document.getElementById("videoEmbed_left"),right_value:document.getElementById("right_value"),text_image_right:document.getElementById("text_image_right"),youtubeEmbedContainer_right:document.getElementById("youtubeEmbedContainer_right"),youtubeEmbed_right:document.getElementById("youtubeEmbed_right"),spotifyEmbedContainer_right:document.getElementById("spotifyEmbedContainer_right"),spotifyEmbed_right:document.getElementById("spotifyEmbed_right"),twitchClipsEmbed_right:document.getElementById("twitchClipsEmbed_right"),videoEmbed_right:document.getElementById("videoEmbed_right"),left_info:document.getElementById("left_info"),right_info:document.getElementById("right_info"),quitBracket:document.getElementById("quitBracket"),settings:document.getElementById("settings"),restart:document.getElementById("restart"),hideScore:document.getElementById("hideScore"),hideScoreIcon:document.getElementById("hideScoreIcon"),enableVoting:document.getElementById("enableVoting"),pickWinner:document.getElementById("pickWinner"),enableVotingTierlist:document.getElementById("enableVotingTierlist"),tierlist:document.getElementById("tierlist"),tierlistContainer:document.getElementById("tierlistContainer"),upcoming:document.getElementById("upcoming"),upcoming_thumbnails:document.getElementById("upcoming_thumbnails"),tierlistItem:document.getElementById("tierlistItem"),tierlistItemDrag:document.getElementById("tierlistItemDrag"),tierlistLabel0:document.getElementById("tierlistLabel0"),tierlistLabel1:document.getElementById("tierlistLabel1"),tierlistLabel2:document.getElementById("tierlistLabel2"),tierlistLabel3:document.getElementById("tierlistLabel3"),tierlistLabel4:document.getElementById("tierlistLabel4"),tierlistLabel5:document.getElementById("tierlistLabel5"),tierlistLabel6:document.getElementById("tierlistLabel6"),tierlistScore0:document.getElementById("tierlistScore0"),tierlistScore1:document.getElementById("tierlistScore1"),tierlistScore2:document.getElementById("tierlistScore2"),tierlistScore3:document.getElementById("tierlistScore3"),tierlistScore4:document.getElementById("tierlistScore4"),tierlistScore5:document.getElementById("tierlistScore5"),tierlistScore6:document.getElementById("tierlistScore6"),currentTierlistItemName:document.getElementById("currentTierlistItemName"),currentTierlistItem:document.getElementById("currentTierlistItem"),pickWinnerTierlist:document.getElementById("pickWinnerTierlist"),hideScoreTierlist:document.getElementById("hideScoreTierlist"),hideScoreTierlistIcon:document.getElementById("hideScoreTierlistIcon"),text_image_tierlist:document.getElementById("text_image_tierlist"),youtubeEmbedContainer_tierlist:document.getElementById("youtubeEmbedContainer_tierlist"),youtubeEmbed_tierlist:document.getElementById("youtubeEmbed_tierlist"),spotifyEmbedContainer_tierlist:document.getElementById("spotifyEmbedContainer_tierlist"),spotifyEmbed_tierlist:document.getElementById("spotifyEmbed_tierlist"),twitchClipsEmbed_tierlist:document.getElementById("twitchClipsEmbed_tierlist"),videoEmbed_tierlist:document.getElementById("videoEmbed_tierlist")};const icons={text:'<i class="material-icons notranslate">description</i>',image:'<i class="material-icons notranslate">image</i>',youtube:'<i class="material-icons notranslate">play_arrow</i>',twitch:'<i class="material-icons notranslate">movie_creation</i>',spotify:'<i class="material-icons notranslate">audiotrack</i>',streamable:'<i class="material-icons notranslate">play_arrow</i>',"supa video/audio":'<i class="material-icons notranslate">play_arrow</i>'},spotifyURLRegex=/https?:\/\/(?:embed\.|open\.)(?:spotify\.com\/)(?:(album|track|playlist)\/|\?uri=spotify:track:)((\w|-){22})/;let client,loginButton,loginExpiredModal,deleteBracketModal,quitBracketModal,tierlistEditorModal,previewModal,generateChatModal,generateModal,communityModal,startModal,publishedModal,importModal,votePopover,votePopoverTierlist,startID,darkTheme=!0,currentBracket={},currentTierlist={},currentFormat="single",voters=[],voting_enabled=!1,currentTime=0,vote_results={left:0,right:0},USER={channel:"",twitchLogin:!1,access_token:"",userID:"",platform:""},BRACKETS={brackets:[]};function resetSettings(){return localStorage.setItem("USER",JSON.stringify({channel:"",twitchLogin:!1,access_token:"",userID:"",platform:""})),localStorage.setItem("BRACKETS",JSON.stringify({brackets:[]})),location.reload(),!1}async function refreshData(){darkTheme=elements.darkTheme.checked??!0,USER.twitchLogin||(USER.channel=validator.escape(elements.channelName.value.replace(/\s+/g,"").toLowerCase()),USER.platform="twitch"),!USER.userID&&USER.channel&&(USER.userID=await getUserID(USER.channel))}function saveSettings(){refreshData(),localStorage.setItem("USER",JSON.stringify(USER)),localStorage.setItem("BRACKETS",JSON.stringify(BRACKETS)),localStorage.setItem("darkTheme",darkTheme)}async function loadAndConnect(){load_localStorage(),refreshData();const e=new Proxy(new URLSearchParams(window.location.search),{get:(e,t)=>e.get(t)});if(e.channel&&!USER.channel&&!USER.twitchLogin&&!USER.access_token&&!USER.userID){let t=e.channel.replace(/\s+/g,"").toLowerCase();elements.channelName.value=t,USER.channel=t,window.history.replaceState({},document.title,"/")}if(USER.twitchLogin&&!await checkToken(USER.access_token))return USER.channel="",void loginExpiredModal.show();USER.channel&&connect()}function load_localStorage(){localStorage.getItem("USER")?(USER=JSON.parse(localStorage.getItem("USER")),elements.channelName.value=USER.channel):console.log("localStorage user info not found"),localStorage.getItem("BRACKETS")?(BRACKETS=JSON.parse(localStorage.getItem("BRACKETS")),loadBrackets()):console.log("localStorage brackets settings not found")}async function loadPFP(){if(!USER.channel)return void(elements.topRight.innerHTML=' <div class="btn-group" role="group" aria-label="login options">\n      <a\n        role="button"\n        id="loginButton"\n        onclick="login()"\n        class="btn btn-twitch"\n        tabindex="0"\n        data-bs-container="body"\n        data-bs-custom-class="custom-popover"\n        data-bs-placement="bottom"\n        data-bs-trigger="manual"\n        data-bs-toggle="popover"\n        data-bs-title="Not signed in"\n        data-bs-content="You need sign in first"\n        ><span class="twitch-icon"></span>Sign in with Twitch</a\n      >\n      <div class="btn-group" role="group">\n        <button\n          id="btnGroupDropLogin"\n          type="button"\n          class="btn btn-twitch dropdown-toggle"\n          data-bs-toggle="dropdown"\n          data-bs-auto-close="outside"\n          aria-label="other login option, connect manually"\n          aria-expanded="false"\n        ></button>\n        <div class="dropdown-menu dropdown-menu-end" aria-labelledby="btnGroupDropLogin">\n          <div class="p-3" style="width: 300px">\n            <label for="channelName" class="form-label">Connect to chat directly</label>\n            <div class="input-group mb-3">\n              <span class="input-group-text" id="directLoginChannel">twitch.tv/</span>\n              <input type="text" class="form-control" id="channelName" aria-describedby="directLoginChannel" />\n            </div>\n            <small class="text-body-secondary">Some features will not be available if you connect directly</small><br />\n            <button type="button" onclick="connect()" class="btn btn-primary float-end">Connect</button>\n          </div>\n        </div>\n      </div>\n    </div>');let e=await get7TVPFP(USER.userID);"/pics/donk.png"==e&&USER.access_token&&(e=await getTwitchPFP(USER.channel,USER.access_token)),elements.topRight.innerHTML=`\n    <div class="btn-group" role="group" aria-label="Button group with nested dropdown">\n    <button type="button" id="btnGroupDrop2" class="btn btn-${darkTheme?"dark":"secondary"}"><img src="${e}" alt="profile pic" style="height:2em;"></button>\n    <div class="btn-group" role="group">\n    <button id="btnGroupDrop1" type="button" class="btn btn-${darkTheme?"dark":"secondary"} dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">\n    ${USER.channel}\n    </button>\n    <ul class="dropdown-menu dropdown-menu-lg-end" aria-labelledby="btnGroupDrop1">\n    <li><a class="dropdown-item" onclick="logout()" href="#"><i class="material-icons notranslate">logout</i>Log out</a></li>\n    </ul>\n    </div>\n    </div>`}function login(){return elements.topRight.innerHTML='<div class="btn-group" role="group" aria-label="log in button group">\n      <button type="button" class="btn btn-twitch"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></button>\n      <div class="btn-group" role="group">\n          <button id="btnGroupDropLogin" type="button" class="btn btn-twitch dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">\n        </button>\n          <ul class="dropdown-menu dropdown-menu-lg-end" aria-labelledby="btnGroupDropLogin">\n              <li><a class="dropdown-item" onclick="logout()" href="#"><i class="material-icons notranslate">logout</i>Log out</a></li>\n          </ul>\n      </div>\n  </div>',window.open("/prompt.html","loginWindow","toolbar=0,status=0,scrollbars=0,width=500px,height=800px"),!1}function checkLogin(){return!!USER.channel||(loginButton.show(),setTimeout((function(){loginButton.hide()}),4e3),!1)}function logout(){elements.topRight.innerHTML='<div class="btn-group" role="group" aria-label="login options">\n    <a\n      role="button"\n      id="loginButton"\n      onclick="login()"\n      class="btn btn-twitch"\n      tabindex="0"\n      data-bs-container="body"\n      data-bs-custom-class="custom-popover"\n      data-bs-placement="bottom"\n      data-bs-trigger="manual"\n      data-bs-toggle="popover"\n      data-bs-title="Not signed in"\n      data-bs-content="You need sign in first"\n      ><span class="twitch-icon"></span>Sign in with Twitch</a\n    >\n    <div class="btn-group" role="group">\n      <button\n        id="btnGroupDropLogin"\n        type="button"\n        class="btn btn-twitch dropdown-toggle"\n        data-bs-toggle="dropdown"\n        data-bs-auto-close="outside"\n        aria-label="other login option, connect manually"\n        aria-expanded="false"\n      ></button>\n      <div class="dropdown-menu dropdown-menu-end" aria-labelledby="btnGroupDropLogin">\n        <div class="p-3" style="width: 300px">\n          <label for="channelName" class="form-label">Connect to chat directly</label>\n          <div class="input-group mb-3">\n            <span class="input-group-text" id="directLoginChannel">twitch.tv/</span>\n            <input type="text" class="form-control" id="channelName" aria-describedby="directLoginChannel" />\n          </div>\n          <small class="text-body-secondary">Some features will not be available if you connect directly</small><br />\n          <button type="button" onclick="connect()" class="btn btn-primary float-end">Connect</button>\n        </div>\n      </div>\n    </div>\n  </div>',resetSettings()}function connect(){elements.status.innerHTML='\n    <h4>\n    <span class="badge bg-warning">Connecting... \n    <div class="spinner-border" style="width:18px;height:18px;" role="status"><span class="visually-hidden">Loading...</span></div>\n    </span>\n    </h4>',elements.topRight.innerHTML='\n    <div class="btn-group" role="group" aria-label="log in button group">\n    <button type="button" class="btn btn-twitch"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></button>\n    <div class="btn-group" role="group">\n    <button id="btnGroupDropLogin" type="button" class="btn btn-twitch dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false"></button>\n    <ul class="dropdown-menu dropdown-menu-lg-end" aria-labelledby="btnGroupDrop1">\n    <li><a class="dropdown-item" onclick="logout()" href="#"><i class="material-icons notranslate">logout</i>Log out</a></li>\n    </ul>\n    </div>\n    </div>',refreshData();let e={options:{clientId:CLIENT_ID,debug:!1},connection:{secure:!0,reconnect:!0},channels:[USER.channel]};client=new tmi.client(e),client.on("message",(async(e,t,n,i)=>{let a=n.split(" ").filter(Boolean)[0].toLowerCase();if(!voting_enabled)return"single"==currentFormat&&("1"==a||"a"==a||"2"==a||"b"==a)&&(Date.now()-currentTime)/1e3>10&&(currentTime=Date.now(),votePopover.show(),setTimeout((function(){votePopover.hide()}),2e3)),void("tierlist"==currentFormat&&currentTierlistCommands.includes(a)&&(Date.now()-currentTime)/1e3>10&&(currentTime=Date.now(),votePopoverTierlist.show(),setTimeout((function(){votePopoverTierlist.hide()}),2e3)));if(!voters.includes(t["user-id"])){if("single"==currentFormat){if(a==currentCommand.left)return vote_results.left++,voters.push(t["user-id"]),void updateScores();if(a==currentCommand.right)return vote_results.right++,voters.push(t["user-id"]),void updateScores()}if("tierlist"==currentFormat&&currentTierlistCommands.includes(a)){let e=currentTierlistData.findIndex((e=>e.command===a));if(-1==e)return;return currentTierlistData[e].score+=1,voters.push(t["user-id"]),void updateScores()}}})),client.on("connected",(async(e,t)=>{console.log(`Connected to ${e}:${t}`),elements.status.innerHTML='<h4><span class="badge bg-success">Connected :)</span></h4>',saveSettings(),sendUsername("chat.vote/brackets",USER.channel,"twitch"==USER.platform?`twitch - ${USER.twitchLogin}`:"youtube"),await checkTags(USER.userID,USER.access_token)&&(elements.vtsLink.style.display=""),loadPFP()})),client.on("disconnected",(e=>{elements.status.innerHTML=`<h4><span class="badge bg-danger">Disconnected: ${e}</span></h4>`})),client.on("notice",((e,t,n)=>{elements.status.innerHTML=`<h4><span class="badge bg-danger">Disconnected: ${n}</span></h4>`})),client.connect().catch(console.error)}function switchTheme(e){document.documentElement.setAttribute("data-bs-theme",e?"dark":"light"),document.getElementById("twitchLogo").style.filter=`invert(${e?.25:.65})`,document.getElementById("btnGroupDrop1")&&document.getElementById("btnGroupDrop2")&&(document.getElementById("btnGroupDrop1").classList.remove(""+(e?"btn-secondary":"btn-dark")),document.getElementById("btnGroupDrop1").classList.add(""+(e?"btn-dark":"btn-secondary")),document.getElementById("btnGroupDrop2").classList.remove(""+(e?"btn-secondary":"btn-dark")),document.getElementById("btnGroupDrop2").classList.add(""+(e?"btn-dark":"btn-secondary")))}function addOption(e="",t="",n="",i="",a=""){let o=++document.querySelectorAll(".option-name").length,l="text";o>1&&(l=Array.from(document.getElementsByClassName("option-type")).find((e=>parseInt(e.dataset.optionId,10)===o-1)).value||"text"),t&&(l=t),elements.optionContainer.insertAdjacentHTML("beforeend",`<div class="card mb-2" data-option-id="${o}">\n      <div class="card-header">\n      Option #${o}\n      <i class="material-icons notranslate deletebtn float-end" onclick="deleteOption('${o}')">delete_forever</i>\n      </div>\n      <div class="card-body">\n        <div class="input-group mb-3">\n          <span class="input-group-text option-value-label">Value/Link</span>\n          <input type="text" class="form-control option-value" data-option-id="${o}" onchange="saveBracket(true)" value="${n}" ${"streamable"==l?`data-video="${a}"`:""} placeholder="Option Value/Link" aria-label="Option Value" />\n          <button class="btn btn-outline-secondary" onclick="previewOption(${o},this)" type="button"><i class="material-icons notranslate">preview</i>Preview</button>\n        </div>\n\n        <div class="input-group mb-3">\n          <label class="input-group-text">Type</label>\n          <select class="form-select option-type" data-option-id="${o}" onchange="saveBracket(true)">\n            <option value="text" ${"text"==l?"selected":""}>Text</option>\n            <option value="image" ${"image"==l?"selected":""}>Image</option>\n            <option value="youtube" ${"youtube"==l?"selected":""}>YouTube video</option>\n            <option value="twitch" ${"twitch"==l?"selected":""}>Twitch clip</option>\n            <option value="spotify" ${"spotify"==l?"selected":""}>Spotify song</option>\n            <option value="streamable" ${"streamable"==l?"selected":""}>Streamable video</option>\n            <option value="supa video/audio" ${"supa video/audio"==l?"selected":""}>supa video/audio file</option>\n          </select>\n        </div>\n\n        <div class="input-group mb-3">\n          <span class="input-group-text">Name</span>\n          <input type="text" class="form-control option-name" data-option-id="${o}" onchange="saveBracket(true)" value="${e}"  placeholder="Option Name" aria-label="Option Name" />\n        </div>\n\n        <div class="input-group">\n          <span class="input-group-text">Thumbnail</span>\n          <input type="text" class="form-control option-thumbnail" data-option-id="${o}" onchange="saveBracket(true)" value="${i}" placeholder="Thumbnail" aria-label="Thumbnail" />\n        </div>\n      </div>\n    </div>`)}function deleteOption(e){e=parseInt(e,10);let t=parseInt(elements.bracketTitle.dataset.bracketId,10),n=BRACKETS.brackets.findIndex((e=>e.id===t));BRACKETS.brackets[n].options.splice(e-1,1),editBracket(t),saveBracket(!0)}async function previewOption(e,t){t.innerHTML=spinner,e=parseInt(e,10);let n=document.querySelectorAll(".option-value"),i=document.querySelectorAll(".option-type"),a=document.querySelectorAll(".option-name"),o=document.querySelectorAll(".option-thumbnail"),l=Array.from(n).find((t=>t.dataset.optionId==e)),r=Array.from(i).find((t=>t.dataset.optionId==e)),s=Array.from(a).find((t=>t.dataset.optionId==e)),d=Array.from(o).find((t=>t.dataset.optionId==e)),c=parseLink(l?.value?.replace(/\s+/g,""));if(c||"image"==r.value||(r.value="text"),"text"==r.value&&(elements.previewModalBody.innerHTML=`\n    <div class="card">\n    <div class="card-body">\n    ${validator.escape(l?.value)||'<span class="text-body-secondary">Empty option</span>'}\n    </div>\n    </div>`,previewModal.show()),"image"==r.value){if(!(l?.value.match(/(http(s)?:\/\/.)?(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)/g)||null))return showToast("Invalid image URL","warning",3e3),void(t.innerHTML='<i class="material-icons notranslate">preview</i>Preview');elements.previewModalBody.innerHTML=`\n    <div class="card">\n    <div class="card-body">\n    <img src="https://proxy.donk.workers.dev/?url=${encodeURI(l.value)}" alt="${s.value}" title="${s.value}" class="option-image">\n    </div>\n    </div>`,previewModal.show()}"youtube"==c?.type&&(s.value||d.value||(c=await getRequestInfo(c),s.value=c.title,d.value=c.thumbnail),r.value="youtube",elements.previewModalBody.innerHTML=`\n    <div class="card">\n    <div class="card-body">\n    <iframe \n    type="text/html" \n    width="100%" height="480" \n    src="https://www.youtube.com/embed/${c.id}?autoplay=1&origin=${window.location.hostname}" \n    frameborder="0">\n    </iframe>\n    </div>\n    </div>`,previewModal.show()),"twitch"==c?.type&&(s.value||d.value||(c=await getRequestInfo(c),s.value=c.title,d.value=c.thumbnail),r.value="twitch",elements.previewModalBody.innerHTML=`\n      <div class="card">\n      <div class="card-body">\n      <iframe \n      src="https://clips.twitch.tv/embed?clip=${c.id}&parent=${window.location.hostname}&autoplay=true" \n      height="480" \n      width="100%" \n      preload="auto" \n      >\n      </iframe>\n      </div>\n      </div>`,previewModal.show()),"spotify"==c?.type&&(s.value||d.value||(c=await getRequestInfo(c),s.value=c.title,d.value=c.thumbnail),r.value="spotify",elements.previewModalBody.innerHTML=`\n      <div class="card">\n      <div class="card-body">\n      <iframe \n      style="border-radius:12px" src="https://open.spotify.com/embed/track/${c.id}${darkTheme?"?theme=0":""}" \n      width="100%" height="352" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; picture-in-picture">\n      </iframe>\n      </div>\n      </div>`,previewModal.show()),"streamable"==c?.type?(c=await getRequestInfo(c),s.value=c.title,d.value=c.thumbnail,r.value="streamable",l.dataset.video=c.video,elements.previewModalBody.innerHTML=`\n      <div class="card">\n      <div class="card-body">\n      <video src="${c.video}" controls autoplay height="480" width="100%"></video>\n      </div>\n      </div>`,previewModal.show()):l.dataset.video="","supa video/audio"==c?.type&&(c=await getRequestInfo(c),s.value=c.title,d.value=c.thumbnail,r.value=c.type,"image"==c.type?elements.previewModalBody.innerHTML=`\n      <div class="card">\n      <div class="card-body">\n      <img src="https://i.supa.codes/${c.id}" alt="${s.value}" title="${s.value}" class="option-image">\n      </div>\n      </div>`:elements.previewModalBody.innerHTML=`\n      <div class="card">\n      <div class="card-body">\n      <video src="https://i.supa.codes/${c.id}" controls autoplay height="480" width="100%"></video>\n      </div>\n      </div>`,previewModal.show()),t.innerHTML='<i class="material-icons notranslate">preview</i>Preview',saveBracket()}function parseLink(e){if(e.includes("twitch.tv")&&(e.includes("/clip/")||e.includes("clips.twitch.tv"))){let t=new URL(e),n="clips.twitch.tv"===t.hostname?/^\/(\w+(?:\/[A-Z]\w+)?(?:[\-\w]*))(?:\/|$)/.exec(t.pathname):/^\/\w+\/clip\/(\w+(?:\/[A-Z]\w+)?(?:[\-\w]*))(?:\/|$)/.exec(t.pathname);return n&&n[1]?{type:"twitch",id:n[1]}:null}if(e.includes("youtube.com")||e.includes("youtu.be")){const t=/(youtu.*be.*)\/(watch\?v=|embed\/|v|shorts|)(.*?((?=[&#?])|$))/gm.exec(e)||null;return 11!=t[3]?.length?null:{type:"youtube",id:t[3]}}if(e.includes("spotify.com")){const t=/https?:\/\/(?:embed\.|open\.)(?:spotify\.com\/)(?:(album|track|playlist)\/|\?uri=spotify:track:)((\w|-){22})/;let n=e.match(t);return n[2]&&"track"===n[1]?{type:"spotify",id:n[2]}:null}if(e.includes("streamable.com")){const t=e.match(/streamable\.com\/([a-zA-Z0-9]+)/);return t[1]?{type:"streamable",id:t[1]}:null}if(e.includes("i.supa.codes")||e.includes("gachi.gay")||e.includes("kappa.lol")||e.includes("femboy.beauty")){const t=e.match(/\/([0-9a-zA-Z_-]{5,})(?:[?/.].*)?$/);return console.log(t),t[1]?{type:"supa video/audio",id:t[1]}:null}return null}async function getRequestInfo(e){if("twitch"==e.type)try{let t=await fetch(`https://helper.donk.workers.dev/twitch/clips?id=${e.id}`,GETrequestOptions),n=await t.json();console.log(n),e.title=n.data[0].title||"(untitled)",e.channel=n.data[0].broadcaster_name||"(unknown)",e.thumbnail=n.data[0].thumbnail_url,e.duration=n.data[0].duration,e.views=n.data[0].view_count}catch(e){return showToast("Could not get clip info","warning",3e3),void console.log("getRequestInfo twitch clip error",e)}if("spotify"==e.type)try{let t=await fetch(`https://helper.donk.workers.dev/spotify/tracks?ids=${e.id}`,GETrequestOptions),n=await t.json();if(console.log(n),e.title=n.tracks[0].name||"(untitled)",e.channel=n.tracks[0].artists[0].name||"(unknown)",e.thumbnail=n.tracks[0].album.images[0].url,e.duration=n.tracks[0].duration_ms/1e3,!n.tracks[0].is_playable)return void showToast("This song is not playable","warning",3e3)}catch(e){return showToast("Could not get song info","warning",3e3),void console.log("getRequestInfo spotify error",e)}if("youtube"==e.type)try{let t=await fetch(`https://helper.donk.workers.dev/youtube/videos?id=${e.id}`,GETrequestOptions),n=await t.json();if(console.log(n),e.title=n.items[0].snippet.title||"(untitled)",e.channel=n.items[0].snippet.channelTitle||"(unknown)",e.thumbnail=n.items[0].snippet.thumbnails.medium.url,e.duration=ISO8601ToSeconds(n.items[0].contentDetails.duration),e.views=n.items[0].statistics.viewCount,"ytAgeRestricted"==n.items[0].contentDetails?.contentRating?.ytRating||!n.items[0].status?.embeddable)return void showToast("This video is age restricted or not embeddable","warning",3e3)}catch(e){return showToast("Could not get video info","warning",3e3),void console.log("getRequestInfo youtube error",e)}if("streamable"==e.type)try{let t=await fetch(`https://helper.donk.workers.dev/streamable/videos?id=${e.id}`,GETrequestOptions),n=await t.json();console.log(n),e.title=n.title||"(untitled)",e.channel="(unknown)",e.thumbnail=n.thumbnail_url.startsWith("//")?`https:${n.thumbnail_url}`:n.thumbnail_url,e.duration=n.files.mp4.duration,e.video=n.files.mp4.url}catch(e){return showToast("Could not get video info","warning",3e3),void console.log("getRequestInfo streamable error",e)}if("supa video/audio"==e.type)try{let t=await fetch(`https://helper.donk.workers.dev/supa/info?id=${e.id}`,GETrequestOptions),n=await t.json();if(console.log(n),!n.type.startsWith("audio")&&!n.type.startsWith("video")&&!n.type.startsWith("image"))return void showToast("Link is not of a video or audio file","warning",3e3);e.title=n?.name?.split(".")[0]||"(untitled)",await checkImage(`https://i.supa.codes/t/${e.id}`)?e.thumbnail=`https://i.supa.codes/t/${e.id}`:e.thumbnail="https://chat.vote/pics/nothumbnail.png",n.type.startsWith("image")&&(e.type="image"),e.duration=n?.mediainfo?.duration||0}catch(e){return showToast("Could not get video info","warning",3e3),void console.log("getRequestInfo supa error",e)}return e}function createBracket(e=!1,t="single"){let n=0;0!==BRACKETS?.brackets?.length&&(n=BRACKETS.brackets.reduce(((e,t)=>e.id>t.id?e:t)).id),BRACKETS.brackets.push({id:++n,title:"",description:"",options:[],generated:e,published:!1,defaultFormat:"tiermaker"==t?"tierlist":"single",time:Date.now()}),editBracket(n),saveBracket()}function saveBracket(e=!1){let t=parseInt(elements.bracketTitle.dataset.bracketId,10),n=BRACKETS.brackets.find((e=>e.id===t));n.title=elements.bracketTitle.value||"Untitled bracket",n.description=elements.bracketDescription.value||"No description",e&&(n.generated=!1,n.published=!1);let i=document.querySelectorAll(".option-name"),a=document.querySelectorAll(".option-type"),o=document.querySelectorAll(".option-value"),l=document.querySelectorAll(".option-thumbnail");n.options=[];for(let e=0;e<i.length;e++){let t=parseLink(o[e].value?.replace(/\s+/g,""));switch(t?.type){case"youtube":case"twitch":case"spotify":case"supa video/audio":n.options.push({value:o[e].value,type:a[e].value,name:i[e].value,thumbnail:l[e].value,id:t.id});break;case"streamable":n.options.push({value:o[e].value,type:a[e].value,name:i[e].value,thumbnail:l[e].value,id:t.id,video:o[e].dataset?.video||""});break;default:n.options.push({value:o[e].value,type:a[e].value,name:i[e].value,thumbnail:l[e].value});break}}loadBrackets(),saveSettings()}function showStartModal(e){startID=e;let t=parseInt(startID,10),n=BRACKETS.brackets.find((e=>e.id===t));"tierlist"==n?.defaultFormat?(elements.formatSelect.value="tierlist",elements.bracketSettings.style.display="none",elements.tierlistSettings.style.display=""):(elements.formatSelect.value="single",elements.bracketSettings.style.display="",elements.tierlistSettings.style.display="none"),n.options.length<2?showToast("Bracket must have 2 options at least","warning",3e3):(n.options.flatMap((e=>e.type)).includes("spotify")?elements.spotifyWarning.style.display="":elements.spotifyWarning.style.display="none",startModal.show())}function startBracket(){if(!checkLogin())return;let e=parseInt(startID,10),t=structuredClone(BRACKETS.brackets.find((t=>t.id===e)));if(t.options.length<2)return void showToast("Bracket must have 2 options at least","warning",3e3);let n=elements.formatSelect.value||"single",i=parseInt(elements.optionLimit.value,10)||0;if(i>0)for(;t.options.length>i;)t.options.splice(Math.floor(Math.random()*t.options.length),1);switch(n){case"single":currentFormat="single",startSingleElimination(t);break;case"tierlist":currentFormat="tierlist",startTierlist(t);break;default:return void showToast("Unknown format","warning",3e3)}changeSiteLinkTarget("_blank")}function startSingleElimination(e){let t=Math.ceil(Math.log2(e.options.length)),n=e.options.length;if(0!=(n&n-1)){let e=1;for(;e<n;)e<<=1;n=e}currentBracket={},currentBracket.round1=[...e.options],shuffleArray(currentBracket.round1);let i=0;for(;currentBracket.round1.length<n;)currentBracket.round1.splice(currentBracket.round1.length-2*i,0,null),i++;for(let e=1;e<=t;e++)currentBracket[`round${e+1}`]=[...Array(currentBracket[`round${e}`].length/2)];elements.brackets_editor.style.display="none",elements.bracket.style.display="",elements.title.innerText=e.title,elements.winner.innerHTML=`Winner of ${validator.escape(e.title)}<br>`,elements.pickWinner.innerHTML='<i class="material-icons notranslate">navigate_next</i>Next match',console.log(currentBracket),currentRound=1,currentOption=0,currentScores={left:0,right:0},currentCommand={left:"a",right:"b"},elements.settings.disabled=!1,elements.restart.disabled=!1,elements.hideScore.disabled=!1,elements.enableVoting.disabled=!1,elements.pickWinner.disabled=!1,elements.left_card_header.style.display="",elements.right_card_header.style.display="",elements.winnerTitle.style.display="none",nextMatch()}function startTierlist(e){console.log(e),elements.tierlistContainer.innerHTML="",elements.upcoming_thumbnails.innerHTML="",shuffleArray(e.options);for(let t=0;t<e.options.length;t++){let n=e.options[t].thumbnail?`https://proxy.donk.workers.dev/?url=${encodeURI(e.options[t].thumbnail)}`:"/pics/nothumbnail.png";elements.upcoming_thumbnails.insertAdjacentHTML("beforeend",`<a\n      href="${getItemLink(e.options[t].type,e.options[t].id)}"\n      target="_blank"\n      rel="noopener noreferrer"><img class="border rounded tierlist-item me-1" alt="${e.options[t].name}" title="${e.options[t].name}" loading="lazy" src="${n}" /></a>`)}addTier("S","s","#de0b0b"),addTier("A","a","#d9740f"),addTier("B","b","#dea216"),addTier("C","c","#f7e51b"),addTier("D","d","#64f71b"),addTier("F","f","#08cc12"),addTier("¯\\_(ツ)_/¯","idk","#0fd9cb"),updateScores(),elements.brackets_editor.style.display="none",elements.tierlist.style.display="",elements.tierlistItem.style.display="",elements.upcoming.style.display="",currentTierlist={},currentTierlist=structuredClone(e),currentTierlistCommands=currentTierlistData.map((e=>e.command)),nextTierlistItem()}let currentRound=1,currentOption=0,currentScores={left:0,right:0},currentCommand={left:"a",right:"b"};function nextMatch(){currentOption==currentBracket[`round${currentRound}`].length&&(currentRound++,currentOption=0);let e="";switch(currentBracket[`round${currentRound}`].length){case 2:e="Finals";break;case 4:e="Semifinals";break;case 8:e="Quarterfinals";break;default:e=`Round of ${currentBracket[`round${currentRound}`].length}`;break}if(elements.round.innerHTML=`${e} • ${currentOption/2+1}/${currentBracket[`round${currentRound}`].length/2}`,Object.keys(currentBracket).length==currentRound)return void showWinner(currentBracket[`round${currentRound}`],currentBracket["round"+(currentRound-1)]);Object.keys(currentBracket).length-1==currentRound&&(elements.pickWinner.innerHTML='<i class="material-icons notranslate">emoji_events</i>Reveal winner');let t=currentBracket[`round${currentRound}`][currentOption++],n=currentBracket[`round${currentRound}`][currentOption++];if(null!==t)if(null!==n){resetPlayers(),showOption("left",t),showOption("right",n);for(let e of document.getElementsByClassName("streamer-vote"))e.style.visibility="visible";resetScores(),elements.keepVotingEnabled.checked||disableVoteButton(),elements.centerTitle.style="",elements.left_card.style="",elements.right_card.style="",elements.left_title.style="",elements.right_title.style="",elements.changeCommand.checked?"a"==currentCommand.left?(currentCommand.left="1",currentCommand.right="2"):(currentCommand.left="a",currentCommand.right="b"):(currentCommand.left="1",currentCommand.right="2"),elements.left_command.innerHTML=currentCommand.left,elements.right_command.innerHTML=currentCommand.right,elements.disableAnimations.checked||(anime({targets:"#centerTitle",translateY:["-200px",0]}),anime({targets:"#left_title",translateX:["-100%",0]}),anime({targets:"#left_card",translateX:["-100%",0]}),anime({targets:"#right_title",translateX:["200%",0]}),anime({targets:"#right_card",translateX:["200%",0]}),elements.changeCommand.checked&&anime({targets:["#left_command","#right_command"],keyframes:[{fontSize:"+=20px"},{fontSize:"-=20px"}],delay:2e3,duration:500}))}else promoteOption(t);else promoteOption(n)}let tierlist_player,currentTierlistItem,currentItem=1,currentTierlistData=[{name:"s",command:"s",score:0,weight:5},{name:"a",command:"a",score:0,weight:4},{name:"b",command:"b",score:0,weight:3},{name:"c",command:"c",score:0,weight:2},{name:"d",command:"d",score:0,weight:1},{name:"f",command:"f",score:0,weight:0},{name:"idk",command:"idk",score:0}],currentTierlistCommands=[];async function nextTierlistItem(){resetPlayers();let e=currentTierlist.options.shift();if(e){if(currentTierlistItem=e,elements.upcoming_thumbnails.firstElementChild.remove(),elements.upcoming_thumbnails.firstElementChild||(elements.upcoming.style.display="none"),elements.currentTierlistItemName.innerText=e.name||"Untitled item",!e?.id&&("youtube"==e.type||"twitch"==e.type||"spotify"==e.type)){let t=parseLink(e.value?.replace(/\s+/g,""));t?e.id=t.id:showToast("Could not load video","warning",3e3)}if("text"==e.type&&(elements.text_image_tierlist.style.display="",elements.text_image_tierlist.innerHTML=validator.escape(e.value)||'<span class="text-body-secondary">Empty option</span>'),"image"==e.type){if(elements.text_image_tierlist.style.display="",!(e?.value.match(/(http(s)?:\/\/.)?(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)/g)||null))return void(elements.text_image_tierlist.innerHTML="Invalid image URL");elements.text_image_tierlist.innerHTML=`<img src="https://proxy.donk.workers.dev/?url=${encodeURI(e.value)}" alt="${e.name}" title="${e.name}" class="tierlist-image">`}if("youtube"==e.type&&(elements.youtubeEmbedContainer_tierlist.style.display="",youtubePlayer_tierlist.loadVideoById(e.id)),"twitch"==e.type&&(elements.twitchClipsEmbed_tierlist.style.display="",elements.twitchClipsEmbed_tierlist.innerHTML=`<iframe src="https://clips.twitch.tv/embed?clip=${e.id}&parent=${window.location.hostname}&autoplay=true&muted=false" preload="auto" height="100%" width="100%" allowfullscreen></iframe>`),"spotify"==e.type&&(elements.spotifyEmbedContainer_tierlist.style.display="",spotifyPlayer_tierlist.loadUri(`spotify:track:${e.id}`),spotifyPlayer_tierlist.play()),"streamable"==e.type){let t=e?.video;if(t){const e=new URL(t).searchParams;1e3*parseInt(e.get("Expires"),10)<Date.now()&&(t=null)}if(!t){t=(await getRequestInfo(e)).video}elements.videoEmbed_tierlist.style.display="",elements.videoEmbed_tierlist.src=t}"supa video/audio"==e.type&&(elements.videoEmbed_tierlist.style.display="",elements.videoEmbed_tierlist.src=`https://i.supa.codes/${e.id}`),resetScores(),elements.keepVotingEnabled.checked||disableVoteButton()}else endTierlist()}function endTierlist(){elements.tierlistItem.style.display="none",elements.upcoming.style.display="none"}function streamerVote(e){vote_results[e]++,voters.push(USER.userID),updateScores();for(let e of document.getElementsByClassName("streamer-vote"))e.style.visibility="hidden"}function pickWinner(e=null){let t=currentBracket[`round${currentRound}`][currentOption-2],n=currentBracket[`round${currentRound}`][currentOption-1],i=e;if(null==i&&(i=vote_results.left>vote_results.right?"left":"right"),vote_results.left!=vote_results.right||e){if(e=e?"left"==e?t:n:vote_results.left>vote_results.right?t:n,Object.keys(currentBracket).length==currentRound+1){let t=currentBracket[`round${currentRound+1}`].findIndex((e=>void 0===e));return currentBracket[`round${currentRound+1}`][t]=e,void nextMatch()}promoteOption(e,i)}else showToast("Options are tied, can't pick a winner","warning",3e3)}function pickWinnerTierlist(){if(elements.averageTier.checked){for(let e=0;e<7;e++)if(elements[`tierlistScore${e}`].innerHTML.includes("⭐"))return void placeTierlistItem(currentTierlistData[e]);showToast("Could not pick winner","warning",4e3)}else{let e=[...currentTierlistData].sort(((e,t)=>t.score-e.score));if(e[0].score==e[1].score)return void showToast("Top 2 tiers are tied, unable to place item","warning",4e3);placeTierlistItem(e[0])}}function restartMatch(){resetScores();for(let e of document.getElementsByClassName("streamer-vote"))e.style.visibility="visible"}function resetScores(){voters=[],vote_results={left:0,right:0};for(let e=0;e<currentTierlistData.length;e++)currentTierlistData[e].score=0;updateScores()}function promoteOption(e,t=null){let n=currentBracket[`round${currentRound+1}`].findIndex((e=>void 0===e));currentBracket[`round${currentRound+1}`][n]=e,t&&!elements.disableAnimations.checked?(anime({targets:"#centerTitle",translateY:"-200px",duration:1e3}),anime({targets:`#${"right"==t?"left":"right"}_title`,translateY:"2000px",scale:"0.8",duration:1e3}),anime({targets:`#${"right"==t?"left":"right"}_card`,translateY:"2000px",scale:"0.8",duration:1e3}),anime({targets:`#${t}_title`,translateX:[{value:("right"==t?"-":"+")+"110%",duration:500}],translateY:[{value:"-50%",duration:500},{value:"-200%",duration:500}],scale:[{value:"1.2",duration:500}]}),anime({targets:`#${t}_card`,translateX:[{value:("right"==t?"-":"+")+"50%",duration:500}],translateY:[{value:"50%",duration:500}],scale:[{value:"1.2",duration:500}],translateY:[{value:"-2000px",duration:500,delay:500}],complete:function(e){nextMatch()}})):nextMatch()}function placeTierlistItem(e){let t=`item${Date.now()}`,n=currentTierlistItem.thumbnail?`https://proxy.donk.workers.dev/?url=${encodeURI(currentTierlistItem.thumbnail)}`:"/pics/nothumbnail.png";document.querySelector(`[data-tier="${e.command}"]`).innerHTML+=`\n  <a\n  id="${t}"\n  href="${getItemLink(currentTierlistItem.type,currentTierlistItem.id)}"\n  target="_blank"\n  rel="noopener noreferrer"><img class="border rounded tierlist-item me-1" alt="${elements.currentTierlistItemName.innerHTML}" title="${elements.currentTierlistItemName.innerHTML}" loading="lazy" src="${n}" /></a>`;let i=elements.currentTierlistItem.getBoundingClientRect(),a=document.getElementById(t).getBoundingClientRect();elements.disableAnimations.checked||anime({targets:`#${t}`,translateY:[i.top-a.top,0],translateX:[i.left-a.left,0],height:["20vh","10vh"]}),nextTierlistItem()}async function showOption(e,t){if(!t?.id&&("youtube"==t.type||"twitch"==t.type||"spotify"==t.type)){let e=parseLink(t.value?.replace(/\s+/g,""));e?t.id=e.id:showToast("Could not load video","warning",3e3)}if(elements[`${e}_name`].innerHTML=validator.escape(t.name)||'<span class="text-body-secondary">Untitled option</span>',"text"==t.type&&(elements[`text_image_${e}`].style.display="",elements[`text_image_${e}`].innerHTML=validator.escape(t.value)||'<span class="text-body-secondary">Empty option</span>'),"image"==t.type){if(elements[`text_image_${e}`].style.display="",!(t?.value.match(/(http(s)?:\/\/.)?(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)/g)||null))return void(elements[`text_image_${e}`].innerHTML="Invalid image URL");elements[`text_image_${e}`].innerHTML=`<img src="https://proxy.donk.workers.dev/?url=${encodeURI(t.value)}" alt="${t.name}" title="${t.name}" class="option-image">`}if("youtube"==t.type&&(elements[`youtubeEmbedContainer_${e}`].style.display="","left"==e?youtubePlayer_left.loadVideoById(t.id):youtubePlayer_right.cueVideoById(t.id)),"twitch"==t.type&&(elements[`twitchClipsEmbed_${e}`].style.display="",elements[`twitchClipsEmbed_${e}`].innerHTML=`<iframe src="https://clips.twitch.tv/embed?clip=${t.id}&parent=${window.location.hostname}&autoplay=${"left"==e?"true":"false"}&muted=false" preload="auto" height="100%" width="100%" allowfullscreen></iframe>`),"spotify"==t.type&&(elements[`spotifyEmbedContainer_${e}`].style.display="","left"==e?(spotifyPlayer_left.loadUri(`spotify:track:${t.id}`),spotifyPlayer_left.play()):spotifyPlayer_right.loadUri(`spotify:track:${t.id}`)),"streamable"==t.type){let n=t?.video;if(n){const e=new URL(n).searchParams;1e3*parseInt(e.get("Expires"),10)<Date.now()&&(n=null)}if(!n){n=(await getRequestInfo(t)).video}elements[`videoEmbed_${e}`].style.display="",elements[`videoEmbed_${e}`].src=n}"supa video/audio"==t.type&&(elements[`videoEmbed_${e}`].style.display="",elements[`videoEmbed_${e}`].src=`https://i.supa.codes/${t.id}`)}function updateScores(){if("single"==currentFormat&&(scoreHidden?(elements.left_score.innerHTML='<span class="text-body-secondary">Score hidden</span>',elements.right_score.innerHTML='<span class="text-body-secondary">Score hidden</span>'):(elements.left_score.innerHTML=`${vote_results.left.toLocaleString()} ${1==vote_results.left?"vote":"votes"} \n      (${Math.round(vote_results.left/(vote_results.left+vote_results.right)*100)||0}%)`,elements.right_score.innerHTML=`${vote_results.right.toLocaleString()} ${1==vote_results.right?"vote":"votes"} \n      (${Math.round(vote_results.right/(vote_results.left+vote_results.right)*100)||0}%)`)),"tierlist"==currentFormat)if(scoreHidden)for(let e=0;e<7;e++)elements[`tierlistScore${e}`].innerHTML="🙈<br />";else{let e=0,t=0;for(let n=0;n<7;n++)e+=currentTierlistData[n].score,currentTierlistData[n].score>currentTierlistData[t].score&&(t=n);if(elements.averageTier.checked){let t=0;for(let e=0;e<6;e++)t+=currentTierlistData[e].score*currentTierlistData[e].weight;let n=Math.round(t/(e-currentTierlistData[6].score));for(let t=0;t<7;t++)elements[`tierlistScore${t}`].innerHTML=`${currentTierlistData[t].score} (${Math.round(currentTierlistData[t].score/e*100)||0}%) ${currentTierlistData[t].weight==n?"⭐":""}<br />`;isNaN(n)&&e&&(elements.tierlistScore6.innerHTML=`${currentTierlistData[6].score} (${Math.round(currentTierlistData[6].score/e*100)||0}%) ⭐<br />`)}else for(let n=0;n<7;n++)elements[`tierlistScore${n}`].innerHTML=`${currentTierlistData[n].score} (${Math.round(currentTierlistData[n].score/e*100)||0}%) ${n==t?"⭐":""}<br />`}}function showWinner(e,t){elements.winner.innerHTML+=`<strong>${validator.escape(e[0].name)}</strong>`,elements.settings.disabled=!0,elements.restart.disabled=!0,elements.hideScore.disabled=!0,elements.enableVoting.disabled=!0,elements.pickWinner.disabled=!0,elements.disableAnimations.checked?(elements.left_card_header.style.display="none",elements.right_card_header.style.display="none",elements.left_title.style.display="none",elements.right_title.style.display="none",elements.centerTitle.style.display="none",elements.winnerTitle.style.display=""):(anime({targets:"#centerTitle",translateY:[0,"-200px"],duration:500,complete:function(e){elements.centerTitle.style.display="none",elements.left_card_header.style.display="none",elements.right_card_header.style.display="none",elements.winnerTitle.style.display="",anime({targets:"#winnerTitle",translateY:["-200px",0],duration:1e3})}}),anime({targets:"#left_title",translateX:[0,"-200%"],duration:1e3,complete:function(e){elements.left_title.style.display="none"}}),anime({targets:"#right_title",translateX:[0,"200%"],duration:2e3,complete:function(e){elements.right_title.style.display="none"}})),e[0].value==t[0].value?(resetPlayers(!1,!0),elements.disableAnimations.checked?(elements.right_card.style.display="none",elements.left_card.style="transform: translateX(50%) translateY(5%) scale(1.3);"):(anime({targets:"#right_card",translateX:"2000px",scale:"0.8",duration:1e3,complete:function(e){elements.right_card.style.display="none"}}),anime({targets:"#left_card",translateX:"50%",translateY:"5%",scale:"1.3",duration:2e3}))):(resetPlayers(!0,!1),elements.disableAnimations.checked?(elements.left_card.style.display="none",elements.right_card.style="transform: translateX(-50%) translateY(5%) scale(1.3);"):(anime({targets:"#left_card",translateX:"2000px",scale:"0.8",duration:1e3,complete:function(e){elements.left_card.style.display="none"}}),anime({targets:"#right_card",translateX:"-50%",translateY:"5%",scale:"1.3",duration:2e3})))}function toggleVoting(){voting_enabled?disableVoteButton():enableVoteButton()}function enableVoteButton(){elements.enableVoting.classList.remove("btn-success"),elements.enableVoting.classList.add("btn-danger"),elements.enableVoting.innerText="Stop Voting",elements.enableVotingTierlist.classList.remove("btn-success"),elements.enableVotingTierlist.classList.add("btn-danger"),elements.enableVotingTierlist.innerText="Stop Voting",voting_enabled=!0}function disableVoteButton(){elements.enableVoting.classList.remove("btn-danger"),elements.enableVoting.classList.add("btn-success"),elements.enableVoting.innerText="Start Voting",elements.enableVotingTierlist.classList.remove("btn-danger"),elements.enableVotingTierlist.classList.add("btn-success"),elements.enableVotingTierlist.innerText="Start Voting",voting_enabled=!1}function quitBracket(){elements.bracket.style.display="none",elements.tierlist.style.display="none",elements.brackets_editor.style.display="",resetPlayers(),disableVoteButton(),changeSiteLinkTarget("_self")}function showQuitBracketModal(){quitBracketModal.show()}function editBracket(e){elements.bracketEditor.style.display="",elements.optionContainer.innerHTML="",e=parseInt(e,10);let t=BRACKETS.brackets.find((t=>t.id===e));t&&(elements.bracketTitle.value=t.title,elements.bracketTitle.dataset.bracketId=e,elements.bracketDescription.value=t.description),elements.bracketEditorHeader.innerHTML=`ID${e}`;for(let e=0;e<t.options.length;e++)addOption(t.options[e].name,t.options[e].type,t.options[e].value,t.options[e].thumbnail,t.options[e]?.video)}function deleteBracket(e){e=parseInt(e,10);let t=BRACKETS.brackets.find((t=>t.id===e));elements.deleteBracketModalBody.innerText=`Delete "${t.title}"?`,elements.deleteBracketButton.dataset.bracketId=e,deleteBracketModal.show()}function loadBrackets(){if(!BRACKETS?.brackets?.length)return void(elements.myBrackets.innerHTML='<span class="text-body-secondary">Nothing here</span>');let e="";for(let t=BRACKETS.brackets.length-1;t>=0;t--){let n=BRACKETS.brackets[t].options.some((e=>!e.value))?'<i class="material-icons notranslate text-danger cursor-pointer" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Some of the options have no value">warning</i>':"";n+=BRACKETS.brackets[t].options.some((e=>!e.thumbnail))?'<i class="material-icons notranslate text-warning cursor-pointer" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Some of the options have no thumbnail">warning</i>':"",e+=`<div class="card mb-3">\n    <div class="card-header">\n      ${validator.escape(BRACKETS.brackets[t].title)||"Untitled bracket"} ${n}\n      <div class="btn-group btn-group-sm float-end" role="group" aria-label="bracket controls">\n        <button type="button" class="btn btn-success" onclick="showStartModal(${BRACKETS.brackets[t].id})">\n          <i class="material-icons notranslate">play_arrow</i> Start bracket\n        </button>\n        <button type="button" class="btn btn-secondary" ${BRACKETS.brackets[t]?.generated||BRACKETS.brackets[t]?.published?'style="display: none"':""}\n        data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Publish bracket" onclick="publishBracket(${BRACKETS.brackets[t].id},this)">\n         <i class="material-icons notranslate">cloud_upload</i>\n       </button>\n        <button type="button" class="btn btn-primary"\n         data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Edit bracket" onclick="editBracket(${BRACKETS.brackets[t].id})">\n        <i class="material-icons notranslate">edit</i>\n        </button>\n        <button type="button" class="btn btn-danger"\n         data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Delete bracket" onclick="deleteBracket(${BRACKETS.brackets[t].id})">\n          <i class="material-icons notranslate">delete_forever</i>\n        </button>\n      </div>\n    </div>\n    <div class="card-body my-bracket-body">\n      <h5 class="card-title">${BRACKETS.brackets[t].description||"No description"}</h5>\n      <p class="card-text">${BRACKETS.brackets[t].options.map((e=>`${icons[e.type]} ${validator.escape(e.name)}`)).join(" • ")||"No options"}</p>\n    </div>\n  </div>`}elements.myBrackets.innerHTML=e,enableTooltips()}function closeEditor(){saveBracket(),elements.bracketEditor.style.display="none"}function shuffleArray(e){for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}}let importPreviewedBracket,previewedBracket=[],previewedBracketTitle="",previewedBracketDescription="";async function previewSpotifyPlaylist(){let e=elements.spotifyPlaylistLink.value?.replace(/\s+/g,"").match(spotifyURLRegex);if(e[2])try{elements.spotifyPlaylistPreview.innerHTML=spinner;let t={method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"},redirect:"follow"},n=await fetch(`https://helper.donk.workers.dev/spotify/playlist?id=${e[2]}`,t),i=await n.json(),a=[...i[0].tracks.items];for(let e=1;e<i.length;e++)a.push(...i[e].items);previewedBracketTitle=i[0].name||"Untitled playlist",previewedBracketDescription=`${i[0].description||"No description"} - Generated from ${elements.spotifyPlaylistLink.value}`,previewedBracket=[];let o='<ul class="list-group">';console.log(a);for(let e=0;e<a.length;e++)a[e].track.is_playable&&(previewedBracket.push({name:`${a[e].track.name} - ${a[e].track.artists.map((e=>e.name)).join(", ")}`,type:"spotify",id:a[e].track.id,value:a[e].track.external_urls.spotify,thumbnail:a[e].track.album.images[0].url}),o+=`\n      <li class="list-group-item">\n      <a target="_blank" rel="noopener noreferrer" href="${a[e].track.preview_url}">${validator.escape(a[e].track.name)} - ${a[e].track.artists.map((e=>e.name)).join(", ")}</a>\n      </li>`);o+="</ul>",elements.spotifyPlaylistPreview.innerHTML=`<p>${validator.escape(i[0].name)||"Untitled playlist"} - ${validator.escape(i[0].description)||"No description"} - ${0==previewedBracket.length?"Playlist has no tracks":`${previewedBracket.length} ${1==previewedBracket.length?"track":"tracks"}`} </p>${o}`}catch(e){return console.log(e),void showToast("Could not load playlist","warning",3e3)}else showToast("Invalid playlist URL provided","warning",3e3)}async function previewTiermaker(){let e=elements.tiermakerLink.value?.replace(/\s+/g,"")?.toLowerCase()||null,t=e.match(/\/([^\/?]+)(?:\?.*)?$/)[1],n=t.slice(t.lastIndexOf("-")+1);if(!t)return void showToast("Could not find the provided tier list","warning",3e3);try{elements.tiermakerPreview.innerHTML=spinner;let i={method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"},redirect:"follow"},a=await fetch(`https://helper.donk.workers.dev/tiermaker?id=${t}`,i),o=await a.json();previewedBracketTitle="Generated TierMaker bracket",previewedBracketDescription=`Generated from ${e}`,previewedBracket=[];let l=JSON.parse(o),r=await testImage(`https://tiermaker.com/images/chart/chart/${t}/${l[1]}`,1);if(!r&&(r=await testImage(`https://tiermaker.com/images/template_images/2022/${n}/${t}/${l[1]}`,2),!r))return void showToast("Could not load tier list :(","warning",3e3);let s='<ul class="list-group">';for(let e=1;e<l.length;e++){let i=l[e].replace("png","").replace("jpg","").replace(".","").replaceAll("-"," "),a=1==r?`https://tiermaker.com/images/chart/chart/${t}/${l[e]}`:`https://tiermaker.com/images/template_images/2022/${n}/${t}/${l[e]}`;previewedBracket.push({name:i,type:"image",value:a,thumbnail:a}),s+=`\n        <li class="list-group-item">\n        <a target="_blank" rel="noopener noreferrer" href="https://proxy.donk.workers.dev/?url=${encodeURI(a)}">\n        ${validator.escape(i)||"Untitled option"}\n        </a>\n        </li>`}s+="</ul>",elements.tiermakerPreview.innerHTML=`<p>${l.length-1} images</p> <p class="text-warning">Make sure the images load by testing one of the links below</p>${s}`}catch(e){return console.log(e),void showToast("Could not find the provided tier list","warning",3e3)}}async function previewClips(){let e=elements.clipsChannel.value?.replace(/\s+/g,"");if(!e)return void showToast("No channel provided","warning",3e3);let t=await getUserID(e);try{elements.clipsPreview.innerHTML=spinner;let n={method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"},redirect:"follow"},i=await fetch(`https://helper.donk.workers.dev/twitch/clips?broadcaster_id=${t}`,n),a=(await i.json()).data;if(0==a)return void showToast("Could not load clips","warning",3e3);previewedBracketTitle=`Top ${e} clips`,previewedBracketDescription=`Bracket with ${a.length} ${e} clips`,previewedBracket=[];let o='<ul class="list-group">';for(let e=0;e<a.length;e++)previewedBracket.push({name:a[e].title,id:a[e].id,type:"twitch",value:a[e].url,thumbnail:a[e].thumbnail_url}),o+=`\n      <li class="list-group-item">\n      <a target="_blank" rel="noopener noreferrer" href="${a[e].url}">\n      ${validator.escape(a[e].title)} - ${a[e].view_count.toLocaleString()} ${1==a[e].view_count?"view":"views"}\n      </a>\n      </li>`;o+="</ul>",elements.clipsPreview.innerHTML=`<p>${a.length} ${1==a.length?"clip":"clips"} </p>${o}`}catch(e){return console.log(e),void showToast("Could not load clips","warning",3e3)}}async function previewEmotes(){let e=elements.emotesChannel.value?.replace(/\s+/g,"")?.toLowerCase()||null;if(e)try{elements.emotesPreview.innerHTML=spinner;let t=await getChannelTwitchEmotes(e,!0);previewedBracketTitle=`Best ${e} emote`,previewedBracketDescription=`Bracket with ${t.length} ${e} emotes`,previewedBracket=[];let n='<ul class="list-group">';console.log(t);for(let e=0;e<t.length;e++)previewedBracket.push({name:t[e].name,type:"image",value:t[e].url,thumbnail:t[e].url}),n+=`\n      <li class="list-group-item">\n      <a target="_blank" rel="noopener noreferrer" href="${t[e].url}">${t[e].name}</a>\n      </li>`;n+="</ul>",elements.emotesPreview.innerHTML=`<p>${0==t.length?"Channel has no emotes":`${t.length} ${1==t.length?"emote":"emotes"}`} </p>${n}`}catch(e){return console.log(e),void showToast("Could not load emotes for the provided channel","warning",3e3)}else showToast("No channel provided","warning",3e3)}async function previewUwufufu(){let e=elements.uwufufuLink.value?.replace(/\s+/g,"")?.toLowerCase()||null;if(!e)return void showToast("No link provided","warning",3e3);let t=0,n=0;try{let i=e.match(/\/quiz\/worldcup\/(.+?)(\/rank)?(\?.*)?$/)[1];if(24!==i.length)return void showToast("Could not find the provided bracket","warning",3e3);elements.uwufufuPreview.innerHTML=spinner;let a={method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"},redirect:"follow"},o=await fetch(`https://helper.donk.workers.dev/uwufufu?id=${i}`,a),l=await o.json();previewedBracketTitle=l.title||"Generated UwUFUFU bracket",previewedBracketDescription=`Generated from ${e}`,previewedBracket=[];for(let e=0;e<l.list.length;e++)l.list[e].isVideo&&!l.list[e].videoUrl||(l.list[e].isVideo||l.list[e].resourceUrl)&&previewedBracket.push({name:l.list[e].name,type:l.list[e].isVideo?"youtube":"image",value:l.list[e].isVideo?l.list[e].videoUrl:l.list[e].resourceUrl,thumbnail:l.list[e].thumbnailUrl});let r='<ul class="list-group">';for(let e=0;e<previewedBracket.length;e++)"youtube"==previewedBracket[e].type?(r+=`\n        <li class="list-group-item">\n        <a target="_blank" rel="noopener noreferrer" href="${previewedBracket[e].value}">${previewedBracket[e].name||"Untitled option"}</a>\n        </li>`,t++):(r+=`\n        <li class="list-group-item">\n        <a target="_blank" rel="noopener noreferrer" href="https://proxy.donk.workers.dev/?url=${encodeURI(previewedBracket[e].value)}">\n        ${validator.escape(previewedBracket[e].name)||"Untitled option"}\n        </a>\n        </li>`,n++);r+="</ul>",elements.uwufufuPreview.innerHTML=`<p>${t>0?`${t} videos`:""} ${n>0?`${n} images`:""}</p>${r}`}catch(e){return console.log(e),void showToast("Could not find the provided bracket","warning",3e3)}}async function previewYTChannel(){let e=elements.ytchannelLink.value?.replace(/\s+/g,"");if(!e)return void showToast("No channel provided","warning",3e3);let t=await getYTChannelID(e);if(t?.items[0]?.id?.channelId){t=t.items[0].id.channelId;try{elements.ytchannelPreview.innerHTML=spinner;let n=await getYTChannelVideos(t);n=n.flatMap((e=>e.items)),previewedBracketTitle=`Top ${e} videos`;let i=0;previewedBracket=[];let a='<ul class="list-group">';console.log(n);for(let e=0;e<n.length;e++)"upcoming"!=n[e].snippet?.liveBroadcastContent&&"youtube#channel"!=n[e].snippet?.id?.kind&&(i++,previewedBracket.push({name:n[e].snippet.title,id:n[e].id.videoId,type:"youtube",value:`https://www.youtube.com/watch?v=${n[e].id.videoId}`,thumbnail:n[e].snippet.thumbnails.high.url}),a+=`\n      <li class="list-group-item">\n      <a target="_blank" rel="noopener noreferrer" href="https://www.youtube.com/watch?v=${n[e].id.videoId}">\n      ${validator.escape(n[e].snippet.title)}\n      </a>\n      </li>`);previewedBracketDescription=`Bracket with the top ${i} ${e} videos`,a+="</ul>",elements.ytchannelPreview.innerHTML=`<p>${i} ${1==i?"video":"videos"} </p>${a}`}catch(e){return console.log(e),void showToast("Could not channel videos","warning",3e3)}}else showToast("Could not find channel","warning",3e3)}async function previewYTPlaylist(){let e=elements.ytplaylistLink.value?.replace(/\s+/g,"");if(!e)return void showToast("No playlist link provided","warning",3e3);let t=e.match(/^.*(youtu.be\/|list=)([^#\&\?]*).*/);if(t[2]&&34===t[2].length)try{elements.ytplaylistPreview.innerHTML=spinner;let n=await getYTPlaylist(t[2]),i=await getYTPlaylistInfo(t[2]);n=n.flatMap((e=>e.items)),previewedBracketTitle=i?.items[0]?.snippet?.title||"YouTube playlist generated bracket",previewedBracketDescription=`Generated from YouTube playlist ${e}`,previewedBracket=[];let a='<ul class="list-group">';console.log(n);for(let e=0;e<n.length;e++)previewedBracket.push({name:n[e].snippet.title,id:n[e].snippet.resourceId.videoId,type:"youtube",value:`https://www.youtube.com/watch?v=${n[e].snippet.resourceId.videoId}`,thumbnail:n[e].snippet.thumbnails.high.url}),a+=`\n      <li class="list-group-item">\n      <a target="_blank" rel="noopener noreferrer" href="https://www.youtube.com/watch?v=${n[e].snippet.resourceId.videoId}">\n      ${validator.escape(n[e].snippet.title)}\n      </a>\n      </li>`;a+="</ul>",elements.ytplaylistPreview.innerHTML=`<p>${n.length} ${1==n.length?"video":"videos"} </p>${a}`}catch(e){return console.log(e),void showToast("Could not load playlist","warning",3e3)}else showToast("Invalid playlist link provided","warning",3e3)}async function generateBracket(){let e=elements.generateBracketType.value?.replace(/\s+/g,"")?.toLowerCase()||null;if(e)if(0!=previewedBracket.length){createBracket(!0,e),elements.bracketTitle.value=previewedBracketTitle,elements.bracketDescription.value=previewedBracketDescription;for(let e=0;e<previewedBracket.length;e++)addOption(previewedBracket[e].name,previewedBracket[e].type,previewedBracket[e].value,previewedBracket[e].thumbnail,previewedBracket[e]?.video);saveBracket(),generateModal.hide()}else showToast('You must <button type="button" class="btn btn-info" ><i class="material-icons notranslate">file_download</i> Load</button> the bracket first',"warning",3e3);else showToast("No bracket type selected","warning",3e3)}async function publishBracket(e,t){t.innerHTML='<div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div>';bootstrap.Tooltip.getInstance(t).dispose(),e=parseInt(e,10);const n=BRACKETS.brackets.findIndex((t=>t.id===e));if(BRACKETS.brackets[n].options.length<2)return showToast("Bracket must have 2 options at least","warning",3e3),void(t.innerHTML='<i class="material-icons notranslate">cloud_upload</i>');let i={method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({userid:USER.userID,username:USER.channel,access_token:USER.access_token,bracket:BRACKETS.brackets[n]}),redirect:"follow"};try{let e=await fetch("https://brackets.donk.workers.dev/publish",i),a=await e.json();console.log(a),showToast(a.message,"info",3e3),200==e.status&&(BRACKETS.brackets[n].published=!0,elements.bracketCode.innerHTML=a.id,elements.bracketLink.innerHTML=`https://chat.vote/brackets#${a.id}`,publishedModal.show(),saveSettings(),loadBrackets()),t.innerHTML='<i class="material-icons notranslate">cloud_upload</i>'}catch(e){showToast("Could not publish bracket","danger",3e3),t.innerHTML='<i class="material-icons notranslate">cloud_upload</i>',console.log("publishBracket error",e)}}async function importCode(e=""){elements.importModalBody.innerHTML=spinner;let t=elements.shareCode.value?.trim();if(e&&(t=e),t&&4==t.length){elements.shareCode.value="",communityModal.hide(),importModal.show();try{let e=await fetch(`https://brackets.donk.workers.dev/id/${t}`,GETrequestOptions);if(200!==e.status)return void(elements.importModalBody.innerHTML="Bracket not found :(");let n=await e.json();if(console.log(n),importPreviewedBracket=n,n.blacklisted)return void(elements.importModalBody.innerHTML=`<span class="text-danger">This bracket is blacklisted (${n.reason})</span>`);let i=`\n    <div class="card">\n    <div class="card-header">${validator.escape(n.bracket.title)} <span class="text-body-secondary">by @${n.username}</span></div>\n    <div class="card-body">\n    <p class="card-text">${validator.escape(n.bracket.description)}</p>\n    Options (${n.bracket.options.length}):\n    <ul class="list-group" style="max-height: 400px; overflow: auto">`;for(let e=0;e<n.bracket.options.length;e++)i+=`<li class="list-group-item">${validator.escape(n.bracket.options[e].name)} - ${validator.escape(n.bracket.options[e].value)}</li>`;i+='\n    </ul>\n    </div>\n    </div>\n    <span class="text-warning">Import brackets from users you trust only</span><br>\n    <button type="button" class="btn btn-danger mt-3" data-bs-dismiss="modal" onclick="importPreviewed()">\n    <i class="material-icons notranslate">cloud_download</i> Import\n    </button>',elements.importModalBody.innerHTML=i}catch(e){elements.importModalBody.innerHTML="Could not import bracket :(",console.log("importCode error",e)}}else showToast("Invalid bracket code","warning",3e3)}function importPreviewed(){createBracket(!0),elements.bracketTitle.value=importPreviewedBracket.bracket.title,elements.bracketDescription.value=`${importPreviewedBracket.bracket.description} - Bracket by @${importPreviewedBracket.username} - bracket ID: ${importPreviewedBracket.id}`;for(let e=0;e<importPreviewedBracket.bracket.options.length;e++)addOption(importPreviewedBracket.bracket.options[e].name,importPreviewedBracket.bracket.options[e].type,importPreviewedBracket.bracket.options[e].value,importPreviewedBracket.bracket.options[e].thumbnail,importPreviewedBracket.bracket.options[e]?.video);saveBracket(),importModal.hide()}async function importApproved(e){let t=approvedBrackets.find((t=>t.id===e));createBracket(!0),elements.bracketTitle.value=t.bracket.title,elements.bracketDescription.value=`${t.bracket.description} - Bracket by @${t.username} - bracket ID: ${t.id}`;for(let e=0;e<t.bracket.options.length;e++)addOption(t.bracket.options[e].name,t.bracket.options[e].type,t.bracket.options[e].value,t.bracket.options[e].thumbnail,t.bracket.options[e]?.video);saveBracket(),communityModal.hide()}let chatBracket=[];function loadPlaylist(){let e=JSON.parse(localStorage.getItem("PLAYLIST_REQUESTS"),reviver);if(!e||e.size<2)return void(elements.playlist.innerHTML='<span class="text-warning">Playlist needs to have at least 2 videos</span>');let t=0;chatBracket=[];let n='<ul class="list-group">';for(let[i,a]of e){let e=a.type;if("twitch stream"==e||"twitch vod"==e)continue;if(!a.title||!a.id||!a.type||!a.thumbnail||"streamable"==a.type&&!a.video)continue;"youtube short"==e&&(e="youtube"),"twitch clip"==e&&(e="twitch"),"supa video"!=e&&"supa audio"!=e||(e="supa video/audio"),t++;let i=getItemLink(e,a.id);chatBracket.push({name:a.title,id:a.id,type:e,value:i,thumbnail:a.thumbnail,video:a?.video}),n+=`\n  <li class="list-group-item">\n  <a target="_blank" rel="noopener noreferrer" href="${i}">\n  ${validator.escape(a.title)}\n  </a>\n  </li>`}n+="</ul>";let i=e.length-t;elements.playlist.innerHTML=`\n  Playlist has ${t} videos ${i?` (${i} unsupported/broken ${1==i?"video":"videos"} skipped)`:""}\n  ${n}`,communityModal.hide(),console.log(e)}function generateChatBracket(){if(0!=chatBracket.length){createBracket(!0),elements.bracketTitle.value="Chat bracket",elements.bracketDescription.value="Bracket with chat's requests";for(let e=0;e<chatBracket.length;e++)addOption(chatBracket[e].name,chatBracket[e].type,chatBracket[e].value,chatBracket[e].thumbnail,chatBracket[e]?.video);saveBracket(),generateChatModal.hide()}else showToast('You must <button type="button" class="btn btn-success" ><i class="material-icons notranslate">file_download</i> Load</button> the playlist first',"warning",3e3)}function zoomCard(e){elements[e].classList.toggle("zoomed"),elements[`${e}_zoom_icon`].innerHTML=elements[e].classList.contains("zoomed")?"zoom_out":"zoom_in",elements[e].classList.contains("zoomed")?anime({targets:`#${e}`,translateX:""+("left_card"==e?"+=50%":"-=50%"),scale:"+=0.4"}):anime({targets:`#${e}`,translateX:""+("left_card"==e?"-=50%":"+=50%"),scale:"-=0.4"})}let scoreHidden=!1;function hideScore(){if(scoreHidden=!scoreHidden,elements.hideScoreIcon.innerHTML=scoreHidden?"visibility_off":"visibility",elements.hideScoreTierlistIcon.innerHTML=scoreHidden?"visibility_off":"visibility",scoreHidden)updateScores();else{if("single"==currentFormat){let e={left:0,right:0};anime({targets:e,left:vote_results.left,right:vote_results.right,round:1,easing:"easeInOutExpo",update:function(){elements.left_score.innerHTML=`${e.left.toLocaleString()} ${1==e.left?"vote":"votes"}`,elements.right_score.innerHTML=`${e.right.toLocaleString()} ${1==e.right?"vote":"votes"}`}})}"tierlist"==currentFormat&&updateScores()}}function loadTierlistEditor(){let e=document.querySelectorAll(".tierlist-label"),t="";for(let n=0;n<e.length;n++)t+=`<div class="input-group mb-3">\n    <span class="input-group-text">Tier name:</span>\n    <input type="text" class="form-control tier-name" placeholder="name" aria-label="Tier name" value="${e[n].textContent}" onchange="updateTierlist()" />\n    <span class="input-group-text">Voting command:</span>\n    <input type="text" class="form-control tier-command" placeholder="command" aria-label="Voting command" value="${e[n].textContent}" onchange="updateTierlist()" />\n    <span class="input-group-text">Color:</span>\n    <input type="color" class="form-control tier-color" value="${rgba2hex(e[n].style.backgroundColor)}" aria-label="Tier color" onchange="updateTierlist()" />\n    <button class="btn btn-outline-secondary" type="button" id="button-addon2"><i class="material-icons notranslate" style="cursor: pointer">delete_forever</i></button>\n    </div>`;elements.tierlistEditor.innerHTML=t}function addTier(e,t,n){let i=document.querySelectorAll(".tierlist-label");"name"==e&&(e=`Tier#${i.length+1}`,t=`Tier#${i.length+1}`),elements.tierlistContainer.insertAdjacentHTML("beforeend",`<div class="card mb-1 tierlist-tier">\n    <div class="row g-0">\n    <div class="col-auto rounded-start tierlist-label" contenteditable="true" spellcheck="false" style="background-color: ${n}">${e}</div>\n    <div class="col">\n    <div class="card-body p-1" data-tier="${t}"></div>\n    </div>\n    </div>\n    </div>`),loadTierlistEditor()}function updateTierlist(){}const rgba2hex=e=>`#${e.match(/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+\.{0,1}\d*))?\)$/).slice(1).map(((e,t)=>(3===t?Math.round(255*parseFloat(e)):parseFloat(e)).toString(16).padStart(2,"0").replace("NaN",""))).join("")}`;async function getYTPlaylist(e){let t={method:"GET",redirect:"follow"};try{let n=await fetch(`https://helper.donk.workers.dev/youtube/playlist?id=${encodeURIComponent(e)}`,t);return await n.json()}catch(e){return console.log("getYTPlaylist error",e),!1}}async function getYTChannelVideos(e,t=1){let n={method:"GET",redirect:"follow"};try{let i=await fetch(`https://helper.donk.workers.dev/youtube/channelvideos?id=${encodeURIComponent(e)}&length=${t}`,n);return await i.json()}catch(e){return console.log("getYTChannelVideos error",e),!1}}async function getYTPlaylistInfo(e){let t={method:"GET",redirect:"follow"};try{let n=await fetch(`https://helper.donk.workers.dev/youtube/playlistinfo?id=${encodeURIComponent(e)}`,t);return await n.json()}catch(e){return console.log("getYTPlaylistInfo error",e),!1}}async function getYTChannelID(e){let t={method:"GET",redirect:"follow"};try{let n=await fetch(`https://helper.donk.workers.dev/youtube/id?handle=${encodeURIComponent(e)}`,t);return await n.json()}catch(e){return console.log("getYTChannelID error",e),!1}}function dragElement(){let e=0,t=0,n=0,i=0;function a(a){(a=a||window.event).preventDefault(),e=n-a.clientX,t=i-a.clientY,n=a.clientX,i=a.clientY,elements.tierlistItem.style.top=elements.tierlistItem.offsetTop-t+"px",elements.tierlistItem.style.left=elements.tierlistItem.offsetLeft-e+"px"}function o(){document.onmouseup=null,document.onmousemove=null}elements.tierlistItemDrag.onmousedown=function(e){(e=e||window.event).preventDefault(),n=e.clientX,i=e.clientY,document.onmouseup=o,document.onmousemove=a}}async function testImage(e,t){try{const n=await fetch(`https://helper.donk.workers.dev/cors/?${e}`);if((await n.blob()).type.startsWith("image/"))return t}catch(e){return 0}}function resetPlayers(e=!0,t=!0){e&&(elements.text_image_left.style.display="none",elements.youtubeEmbedContainer_left.style.display="none",elements.spotifyEmbedContainer_left.style.display="none",elements.twitchClipsEmbed_left.style.display="none",elements.videoEmbed_left.style.display="none",youtubePlayer_left.loadVideoById(""),spotifyPlayer_left.pause(),elements.twitchClipsEmbed_left.innerHTML="",elements.videoEmbed_left.src=""),t&&(elements.text_image_right.style.display="none",elements.youtubeEmbedContainer_right.style.display="none",elements.spotifyEmbedContainer_right.style.display="none",elements.twitchClipsEmbed_right.style.display="none",elements.videoEmbed_right.style.display="none",youtubePlayer_right.loadVideoById(""),spotifyPlayer_right.pause(),elements.twitchClipsEmbed_right.innerHTML="",elements.videoEmbed_right.src=""),elements.text_image_tierlist.style.display="none",elements.youtubeEmbedContainer_tierlist.style.display="none",elements.spotifyEmbedContainer_tierlist.style.display="none",elements.twitchClipsEmbed_tierlist.style.display="none",elements.videoEmbed_tierlist.style.display="none",youtubePlayer_tierlist.loadVideoById(""),spotifyPlayer_tierlist.pause(),elements.twitchClipsEmbed_tierlist.innerHTML="",elements.videoEmbed_tierlist.src=""}function getItemLink(e,t){switch(e){case"youtube":return`https://youtu.be/${t}`;case"spotify":return`https://open.spotify.com/track/${t}`;case"twitch":return`https://clips.twitch.tv/${t}`;case"streamable":return`https://streamable.com/${t}`;case"supa video/audio":return`https://i.supa.codes/${t}`;default:return""}}let youtubePlayer_left,youtubePlayer_right,youtubePlayer_tierlist,spotifyPlayer_left,spotifyPlayer_right,spotifyPlayer_tierlist;function onYouTubeIframeAPIReady(){elements.left_value.addEventListener("mouseover",(e=>{try{youtubePlayer_left.getPlayerState()>=1&&youtubePlayer_right.getPlayerState()>=1&&(youtubePlayer_right.mute(),youtubePlayer_left.unMute())}catch(e){}})),elements.right_value.addEventListener("mouseover",(e=>{try{youtubePlayer_left.getPlayerState()>=1&&youtubePlayer_right.getPlayerState()>=1&&(youtubePlayer_left.mute(),youtubePlayer_right.unMute())}catch(e){}})),console.log("onYouTubeIframeAPIReady"),youtubePlayer_left=new YT.Player("youtubeEmbed_left",{height:"100%",width:"100%",playerVars:{autoplay:1,enablejsapi:1,playsinline:1,rel:0,origin:"chat.vote"},events:{onError:youtubePlayerOnError,onAutoplayBlocked:youtubePlayerOnAutoplayBlocked}}),youtubePlayer_right=new YT.Player("youtubeEmbed_right",{height:"100%",width:"100%",playerVars:{autoplay:0,enablejsapi:1,playsinline:1,rel:0,origin:"chat.vote"},events:{onError:youtubePlayerOnError,onAutoplayBlocked:youtubePlayerOnAutoplayBlocked}}),youtubePlayer_tierlist=new YT.Player("youtubeEmbed_tierlist",{height:"100%",width:"100%",playerVars:{autoplay:1,enablejsapi:1,playsinline:1,rel:0,origin:"chat.vote"},events:{onError:youtubePlayerOnError,onAutoplayBlocked:youtubePlayerOnAutoplayBlocked}})}function youtubePlayerOnError(e){console.log(e)}function youtubePlayerOnAutoplayBlocked(e){console.log(e)}window.onload=async function(){darkTheme="true"===(localStorage.getItem("darkTheme")||"true"),elements.darkTheme.checked=darkTheme??!0,switchTheme(elements.darkTheme.checked),loadAndConnect(),USER.channel||(loginButton=new bootstrap.Popover(elements.loginButton)),enableTooltips(),enablePopovers(),document.addEventListener("click",(e=>{!elements.left_card.contains(e.target)&&elements.left_card.classList.contains("zoomed")&&(elements.left_card.classList.remove("zoomed"),elements.left_card_zoom_icon.innerHTML="zoom_in",anime({targets:"#left_card",translateX:"-=50%",scale:"-=0.4"})),!elements.right_card.contains(e.target)&&elements.right_card.classList.contains("zoomed")&&(elements.right_card.classList.remove("zoomed"),elements.right_card_zoom_icon.innerHTML="zoom_in",anime({targets:"#right_card",translateX:"+=50%",scale:"-=0.4"}))})),votePopover=new bootstrap.Popover(elements.enableVoting),votePopoverTierlist=new bootstrap.Popover(elements.enableVotingTierlist),loginExpiredModal=new bootstrap.Modal(elements.loginExpiredModal),deleteBracketModal=new bootstrap.Modal(elements.deleteBracketModal),quitBracketModal=new bootstrap.Modal(elements.quitBracketModal),tierlistEditorModal=new bootstrap.Modal(elements.tierlistEditorModal),previewModal=new bootstrap.Modal(elements.previewModal),generateChatModal=new bootstrap.Modal(elements.generateChatModal),generateModal=new bootstrap.Modal(elements.generateModal),communityModal=new bootstrap.Modal(elements.communityModal),startModal=new bootstrap.Modal(elements.startModal),publishedModal=new bootstrap.Modal(elements.publishedModal),importModal=new bootstrap.Modal(elements.importModal),elements.tierlistEditorModal.addEventListener("show.bs.modal",(e=>{loadTierlistEditor()})),elements.previewModal.addEventListener("hidden.bs.modal",(e=>{elements.previewModalBody.innerHTML=""})),elements.generateModal.addEventListener("hidden.bs.modal",(e=>{previewedBracket=[],previewedBracketDescription="",previewedBracketTitle="";for(let e of document.getElementsByClassName("generate-type"))e.style.display="none";for(let e of document.getElementsByClassName("generate-value"))e.value="";for(let e of document.getElementsByClassName("generate-preview"))e.innerHTML=""})),elements.channelName.addEventListener("keydown",(e=>{"Enter"===e.key&&connect()})),elements.darkTheme.onchange=function(){switchTheme(this.checked),saveSettings()},elements.generateBracketType.onchange=function(){for(let e of document.getElementsByClassName("generate-type"))e.style.display="none";elements[`${this.value}Settings`].style.display=""},elements.formatSelect.onchange=function(){"tierlist"==this.value?(elements.bracketSettings.style.display="none",elements.tierlistSettings.style.display=""):(elements.bracketSettings.style.display="",elements.tierlistSettings.style.display="none")},elements.hideScore.addEventListener("click",(function(){bootstrap.Tooltip.getInstance("#hideScore").setContent({".tooltip-inner":scoreHidden?"Hide score":"Show score"}),hideScore()})),elements.hideScoreTierlist.addEventListener("click",(function(){bootstrap.Tooltip.getInstance("#hideScoreTierlist").setContent({".tooltip-inner":scoreHidden?"Hide score":"Show score"}),hideScore()})),elements.importBracket.addEventListener("click",(function(){previewedBracket=[],previewedBracketDescription="",previewedBracketTitle="";for(let e of document.getElementsByClassName("generate-type"))e.style.display="none";for(let e of document.getElementsByClassName("generate-value"))e.value="";for(let e of document.getElementsByClassName("generate-preview"))e.innerHTML="";generateModal.show()})),elements.addOption.addEventListener("click",(function(){addOption(),saveBracket(!0)})),elements.deleteBracketButton.addEventListener("click",(function(){let e=parseInt(this.dataset.bracketId,10);BRACKETS.brackets.splice(BRACKETS.brackets.findIndex((t=>t.id===e)),1),loadBrackets(),saveSettings(),elements.bracketEditor.style.display="none",deleteBracketModal.hide(),enableTooltips()})),dragElement();let e=location.hash?.replace("#","")?.trim();4==e.length&&(importCode(e),history.replaceState(void 0,void 0,"#"))},window.onSpotifyIframeApiReady=e=>{console.log("onSpotifyIframeApiReady");e.createController(elements.spotifyEmbed_left,{},(e=>{spotifyPlayer_left=e})),e.createController(elements.spotifyEmbed_right,{},(e=>{spotifyPlayer_right=e})),e.createController(elements.spotifyEmbed_tierlist,{},(e=>{spotifyPlayer_tierlist=e}))};