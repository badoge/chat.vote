const USERNAME="forsen",pfp="https://static-cdn.jtvnw.net/jtv_user_pictures/forsen-profile_image-48b43e1e4f54b5c8-600x600.png",userid=22484632,raffle_command1="!join",raffle_command2="!ticket";let client,raffle_open,restartRaffleModal,restartTier3RaffleModal,fancyRaffleModal,tickSound,revealSound,elements={restartRaffleModal:document.getElementById("restartRaffleModal"),restartTier3RaffleModal:document.getElementById("restartTier3RaffleModal"),fancyRaffleModal:document.getElementById("fancyRaffleModal"),slot:document.getElementById("slot"),claw:document.getElementById("claw"),gameWinner:document.getElementById("gameWinner"),status:document.getElementById("status"),topRight:document.getElementById("topRight"),raffleUsers:document.getElementById("raffleUsers"),raffleUsersTier3:document.getElementById("raffleUsersTier3"),entrants:document.getElementById("entrants"),entrantsTier3:document.getElementById("entrantsTier3"),raffleOutput:document.getElementById("raffleOutput"),raffleOutputTier3:document.getElementById("raffleOutputTier3"),emotes:document.getElementById("emotes"),animationSelect:document.getElementById("animationSelect")},raffle_users=[],raffle_users_tier3=[],tier3Emotes=[],n=0,n2=0,n3=0,color="",currentTime=0,winner="",raffleWinners=[],winnerTier3="",raffleWinnersTier3=[],thirdPartyEmotes=[],paused=!1;function restartRaffle(){raffle_users=[],winner="",raffleWinners=[],elements.raffleUsers.innerHTML="",elements.raffleOutput.innerHTML="",elements.entrants.innerHTML="Entrants: 0"}function restartTier3Raffle(){raffle_users_tier3=[],winnerTier3="",raffleWinnersTier3=[],elements.raffleUsersTier3.innerHTML="",elements.raffleOutputTier3.innerHTML="",elements.entrantsTier3.innerHTML="Entrants: 0"}function connect(){elements.status.innerHTML='\n  <h4>\n  <span class="badge bg-warning">Connecting... \n  <div class="spinner-border" style="width:18px;height:18px;" role="status"><span class="visually-hidden">Loading...</span></div>\n  </span>\n  </h4>',elements.topRight.innerHTML='\n  <div class="btn-group" role="group" aria-label="log in button group">\n  <button type="button" class="btn btn-twitch"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></button>\n  <div class="btn-group" role="group">\n  <button id="btnGroupDropLogin" type="button" class="btn btn-twitch dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false"></button>\n  <ul class="dropdown-menu dropdown-menu-lg-end" aria-labelledby="btnGroupDropLogin">\n  <li><a class="dropdown-item" onclick="logout()" href="#"><i class="material-icons notranslate">logout</i>Log out</a></li>\n  </ul>\n  </div>\n  </div>',getEmotes(),loadBadges("forsen");let e={options:{clientId:CLIENT_ID,debug:!1},connection:{secure:!0,reconnect:!0},channels:["forsen"]};client=new tmi.client(e),client.on("message",(async(e,t,n,a)=>{if(!t.subscriber||paused)return;let s=n.split(" ").filter(Boolean)[0].toLowerCase();if("!join"!=s&&"!ticket"!=s){if(t.username==winner&&raffleWinnerChat(t,n,!1),t.username==winnerTier3&&raffleWinnerChat(t,n,!0),t?.emotes)for(let e=0;e<tier3Emotes.length;e++)if(Object.hasOwn(t.emotes,tier3Emotes[e])){if(!raffle_users_tier3.some((e=>e.username===t.username))&&!raffleWinnersTier3.includes(t.username)){addUserToRaffleTier3({id:t["user-id"],username:t.username,displayname:t["display-name"],tickets:1,color:t.color,firstmsg:t["first-msg"],badges:t.badges,msg:n})}return}}else if(!raffle_users.some((e=>e.username===t.username))&&!raffleWinners.includes(t.username)){addUserToRaffle({id:t["user-id"],username:t.username,displayname:t["display-name"],tickets:1,color:t.color,firstmsg:t["first-msg"],badges:t.badges,msg:n})}})),client.on("timeout",((e,t,n,a,s)=>{if(t==winner){elements.raffleOutput.lastChild.innerHTML='<small class="text-body-secondary">Message deleted</small>'}})),client.on("connected",((e,t)=>{console.log(`Connected to ${e}:${t}`),elements.status.innerHTML='<h4><span class="badge bg-success">Connected :)</span></h4>',loadPFP()})),client.on("disconnected",(e=>{elements.status.innerHTML=`<h4><span class="badge bg-danger">Disconnected: ${e}</span></h4>`})),client.on("notice",((e,t,n)=>{elements.status.innerHTML=`<h4><span class="badge bg-danger">Disconnected: ${n}</span></h4>`})),client.connect().catch(console.error)}async function loadPFP(){elements.topRight.innerHTML=`\n  <div class="btn-group" role="group" aria-label="Button group with nested dropdown">\n  <button type="button" class="btn btn-dark"><img src="${pfp}" alt="profile pic" style="height:2em;"></button>\n  <div class="btn-group" role="group">\n  <button id="btnGroupDrop1" type="button" class="btn btn-dark dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">\n  forsen\n  </button>\n  <ul class="dropdown-menu dropdown-menu-lg-end" aria-labelledby="btnGroupDrop1">\n  <li><a class="dropdown-item" onclick="logout()" href="#"><i class="material-icons notranslate">logout</i>Log out</a></li>\n  </ul>\n  </div>\n  </div>`}async function addUserToRaffle(e){raffle_users.push(e);let t=e.username==e.displayname.toLowerCase()?`${e.displayname}`:`${e.displayname} (${e.username})`,n=e.color?e.color:"#FFFFFF",a=addBadges(e.badges,e.id,e.firstmsg);elements.raffleUsers.insertAdjacentHTML("afterbegin",`<li id="${e.username}_raffle" class="list-group-item">\n    ${a}<span style="color:${n};"> ${t}</span>: 1 ticket\n    <i class="material-icons notranslate deletebtn float-end" onclick="removeFromRaffle('${e.username}')">highlight_off</i>\n    </li>`),elements.entrants.innerHTML=`Entrants: ${raffle_users.length}`}async function addUserToRaffleTier3(e){raffle_users_tier3.push(e);let t=e.username==e.displayname.toLowerCase()?`${e.displayname}`:`${e.displayname} (${e.username})`,n=e.color?e.color:"#FFFFFF",a=addBadges(e.badges,e.id,e.firstmsg);elements.raffleUsersTier3.insertAdjacentHTML("afterbegin",`<li id="${e.username}_raffle_tier3" class="list-group-item">\n    ${a}<span style="color:${n};"> ${t}</span>: 1 ticket\n    <i class="material-icons notranslate deletebtn float-end" onclick="removeFromRaffleTier3('${e.username}')">highlight_off</i>\n    </li>`),elements.entrantsTier3.innerHTML=`Entrants: ${raffle_users_tier3.length}`}async function drawRaffleWinner(){if(raffle_users.length<2){let e=document.createElement("p");return e.innerHTML="Less than 2 users in raffle.",void elements.raffleOutput.append(e)}if(paused=!0,"on"==elements.animationSelect.value||"pfp"==elements.animationSelect.value)drawRaffleWinnerFancy();else{let e=[];for(let t=0,n=raffle_users.length;t<n;t++)for(let n=raffle_users[t].tickets;n>0;n--)e.push(raffle_users[t].username);winner=e[Math.floor(Math.random()*e.length)],raffleWinners.push(winner);let t=raffle_users.find((e=>e.username==winner)),n=document.createElement("p");n.classList.add("h2"),n.innerHTML=`\n    Winner #${raffleWinners.length}: \n    <a class="link-success cursorPointer" onclick=window.open("https://www.twitch.tv/popout/forsen/viewercard/${winner}?popout=","_blank","width=340,height=800")>\n    ${winner}\n    </a>`,elements.raffleOutput.append(n),removeFromRaffle(winner),raffleWinnerChat({"user-id":t.id,username:t.username,"display-name":t.displayname,color:t.color,badges:t.badges,emotes:t.emotes,time:t.time},t.msg,!1),paused=!1}}async function drawRaffleWinnerTier3(){if(raffle_users_tier3.length<2){let e=document.createElement("p");return e.innerHTML="Less than 2 users in raffle.",void elements.raffleOutputTier3.append(e)}if(paused=!0,"on"==elements.animationSelect.value||"pfp"==elements.animationSelect.value)drawRaffleWinnerFancyTier3(!0);else{let e=[];for(let t=0,n=raffle_users_tier3.length;t<n;t++)for(let n=raffle_users_tier3[t].tickets;n>0;n--)e.push(raffle_users_tier3[t].username);winnerTier3=e[Math.floor(Math.random()*e.length)],raffleWinnersTier3.push(winnerTier3);let t=raffle_users_tier3.find((e=>e.username==winnerTier3)),n=document.createElement("p");n.classList.add("h2"),n.innerHTML=`\n    Winner #${raffleWinners.length}: \n    <a class="link-success cursorPointer" onclick=window.open("https://www.twitch.tv/popout/forsen/viewercard/${winnerTier3}?popout=","_blank","width=340,height=800")>\n    ${winnerTier3}\n    </a>`,elements.raffleOutput.append(n),removeFromRaffleTier3(winnerTier3),raffleWinnerChat({"user-id":t.id,username:t.username,"display-name":t.displayname,color:t.color,badges:t.badges,emotes:t.emotes,time:t.time},t.msg,!0),paused=!1}}class Slot{constructor(e,t,n){this.username=e,this.pfp=t||"/pics/donk.png",this.color=n||"#ffffff",this.measureUnit="px",this.ordinal=0,this.left=0,this.div=document.createElement("div"),this.div.classList.add("slot-element"),"pfp"==elements.animationSelect.value?this.div.innerHTML=`<span style="color:${this.color};"> ${this.username} </span>\n        <div style="height: 310px; width: 300px; border-bottom: 10px solid transparent; background: radial-gradient(circle, rgba(255,255,255,1) 0%, ${this.color} 100%);">\n          <img\n            style="background: linear-gradient(0deg, ${this.color} 1%, rgba(100,100,100,1) 40%); height: 300px; width: 300px;"\n            src="${this.pfp}"\n            alt="${this.username}"\n            title="${this.username}"\n          />\n        </div>`:this.div.innerHTML=`<span style="color:${this.color};"> ${this.username} </span>\n      <div style="height: 310px; width: 300px; border-bottom: 10px solid transparent; background: radial-gradient(circle, rgba(255,255,255,1) 0%, ${this.color} 100%);">\n        <img style="background: ${this.color}; height: 300px; width: 300px;" src="${this.pfp}" alt="${this.username}" title="${this.username}" />\n      </div>`,this.div.innerHTML=`\n    <span style="color:${this.color};"> ${this.username} </span>\n    <div style="height: 310px; width: 300px; border-bottom: 10px solid transparent; background: radial-gradient(circle, rgba(255,255,255,1) 0%, ${this.color} 100%);">\n    <img style="background: ${this.color}; height: 300px; width: 300px;" src="${this.pfp}" alt="${this.username}" title="${this.username}" />\n    </div>`}init(e=0){this.ordinal=-e}resetPosition(e=0){this.left=e,this.setPositionDOM(0)}scroll(e=0){this.left-=e,this.left<(this.ordinal-2)*app.animation.constants.ELEMENT_WIDTH&&(tickSound.play(),this.left+=app.slotOptions.length*app.animation.constants.ELEMENT_WIDTH),this.setPositionDOM(this.left)}setPositionDOM(e=0){this.div.style.left=e+this.measureUnit}checkEquatorPosition(){if(!this.div.parentNode)return void console.warn("Div is not attached to anything! Cannot calculate position!",this);const e=this.div.parentNode.getBoundingClientRect(),t=e.x+e.width/2,n=this.div.getBoundingClientRect(),a=[n.x,n.x+n.width];return a[0]<=t&&a[1]>=t}cloneSelf(){return new Slot(this.username,this.pfp,this.color)}destroy(){this.div.parentNode&&this.div.parentNode.removeChild(this.div)}}const detectWinner=function(){revealSound.play();let e=null;for(let t=0,n=app.slotOptions.length;t<n;t++)app.slotOptions[t].checkEquatorPosition()&&(e=app.slotOptions[t]);if(e){const t=e.cloneSelf();elements.gameWinner.appendChild(t.div),app.spinStarted=!1,raffleWinners.push(e.username),winner=e.username,removeFromRaffle(e.username);let n=document.createElement("p");n.classList.add("h2"),n.innerHTML=`Winner #${raffleWinners.length}: <a class="link-success cursorPointer" onclick=window.open("https://www.twitch.tv/popout/forsen/viewercard/${e.username}?popout=","_blank","width=340,height=800")>${e.username}</a>`,elements.raffleOutput.append(n),setTimeout((()=>{fancyRaffleModal.hide(),elements.gameWinner.innerHTML="",elements.slot.innerHTML='<div class="spinner-border" style="width: 10rem; height: 10rem; margin-left: auto; margin-right: auto; display:block;" role="status"><span class="visually-hidden">Loading...</span></div>'}),2e3)}else window.alert("Could not determine winner FeelsDonkMan");paused=!1},detectWinnerTier3=function(){revealSound.play();let e=null;for(let t=0,n=app.slotOptions.length;t<n;t++)app.slotOptions[t].checkEquatorPosition()&&(e=app.slotOptions[t]);if(e){const t=e.cloneSelf();elements.gameWinner.appendChild(t.div),app.spinStarted=!1,raffleWinnersTier3.push(e.username),winnerTier3=e.username,removeFromRaffleTier3(e.username);let n=document.createElement("p");n.classList.add("h2"),n.innerHTML=`Winner #${raffleWinnersTier3.length}: <a class="link-success cursorPointer" onclick=window.open("https://www.twitch.tv/popout/forsen/viewercard/${e.username}?popout=","_blank","width=340,height=800")>${e.username}</a>`,elements.raffleOutputTier3.append(n),setTimeout((()=>{fancyRaffleModal.hide(),elements.gameWinner.innerHTML="",elements.slot.innerHTML='<div class="spinner-border" style="width: 10rem; height: 10rem; margin-left: auto; margin-right: auto; display:block;" role="status"><span class="visually-hidden">Loading...</span></div>'}),2e3)}else window.alert("Could not determine winner FeelsDonkMan");paused=!1},animateRoll=function(){if(app.animation.speed+=app.animation.acceleration,app.animation.speed<0)app.animation.speed=0,app.animation.acceleration=0,setTimeout(detectWinner,1e3);else{for(let e=0,t=app.slotOptions.length;e<t;e++)app.slotOptions[e].scroll(app.animation.speed);window.requestAnimationFrame(animateRoll)}},animateRollTier3=function(){if(app.animation.speed+=app.animation.acceleration,app.animation.speed<0)app.animation.speed=0,app.animation.acceleration=0,setTimeout(detectWinnerTier3,1e3);else{for(let e=0,t=app.slotOptions.length;e<t;e++)app.slotOptions[e].scroll(app.animation.speed);window.requestAnimationFrame(animateRollTier3)}};Array.prototype.shuffle=function(){for(let e=this.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[this[e],this[t]]=[this[t],this[e]]}return this};const app={slotOptions:[],animation:{constants:{ELEMENT_WIDTH:310,SLOW_DOWN:-.1,STARTING_SPEED:40},acceleration:0,speed:0,projectedFPS:0},spinStarted:!1,ready:!1};async function drawRaffleWinnerFancy(){fancyRaffleModal.show(),elements.claw.style.display="none";let e=[];for(let t=0,n=raffle_users.length;t<n;t++)for(let n=raffle_users[t].tickets;n>0;n--)e.push(raffle_users[t]);if(e=e.shuffle().slice(0,100),"pfp"==elements.animationSelect.value){let t=await getPFP(e.map((e=>e.username)));if(0!=t)for(let n=0,a=e.length;n<a;n++)if(t.find((t=>t.login===e[n].username))){let a=t.find((t=>t.login===e[n].username)).profile_image_url;a&&(e[n].pfp=a)}}else for(let t=0,n=e.length;t<n;t++)e[t].pfp="/pics/raffledonk.png";for(let e=0,t=app.slotOptions.length;e<t;e++)app.slotOptions[e].destroy();app.slotOptions.length=0;for(let t=0,n=e.length;t<n;t++)app.slotOptions.push(new Slot(e[t].username,e[t].pfp,e[t].color));if(app.spinStarted)return;if(app.spinStarted=!0,app.slotOptions.length<1)return app.spinStarted=!1,window.alert("Nothing to spin!");for(;app.slotOptions.length<20;)for(let e=0,t=app.slotOptions.length;e<t;e++)app.slotOptions.push(app.slotOptions[e].cloneSelf());elements.gameWinner.innerHTML="",elements.slot.innerHTML="",elements.claw.style.display="block",app.slotOptions.shuffle().forEach(((e,t)=>{e.init(t),e.resetPosition(-20),elements.slot.appendChild(e.div)})),app.animation.speed=app.animation.constants.STARTING_SPEED;const t=60/app.animation.projectedFPS;app.animation.speed*=t,setTimeout((()=>{app.animation.acceleration=app.animation.constants.SLOW_DOWN,app.animation.acceleration*=t*t}),Math.round(1500+1e3*Math.random())),animateRoll()}async function drawRaffleWinnerFancyTier3(){fancyRaffleModal.show(),elements.claw.style.display="none";let e=[];for(let t=0,n=raffle_users_tier3.length;t<n;t++)for(let n=raffle_users_tier3[t].tickets;n>0;n--)e.push(raffle_users_tier3[t]);if(e=e.shuffle().slice(0,100),"pfp"==elements.animationSelect.value){let t=await getPFP(e.map((e=>e.username)));if(0!=t)for(let n=0,a=e.length;n<a;n++)if(t.find((t=>t.login===e[n].username))){let a=t.find((t=>t.login===e[n].username)).profile_image_url;a&&(e[n].pfp=a)}}else for(let t=0,n=e.length;t<n;t++)e[t].pfp="/pics/raffledonk.png";for(let e=0,t=app.slotOptions.length;e<t;e++)app.slotOptions[e].destroy();app.slotOptions.length=0;for(let t=0,n=e.length;t<n;t++)app.slotOptions.push(new Slot(e[t].username,e[t].pfp,e[t].color));if(app.spinStarted)return;if(app.spinStarted=!0,app.slotOptions.length<1)return app.spinStarted=!1,window.alert("Nothing to spin!");for(;app.slotOptions.length<20;)for(let e=0,t=app.slotOptions.length;e<t;e++)app.slotOptions.push(app.slotOptions[e].cloneSelf());elements.gameWinner.innerHTML="",elements.slot.innerHTML="",elements.claw.style.display="block",app.slotOptions.shuffle().forEach(((e,t)=>{e.init(t),e.resetPosition(-20),elements.slot.appendChild(e.div)})),app.animation.speed=app.animation.constants.STARTING_SPEED;const t=60/app.animation.projectedFPS;app.animation.speed*=t,setTimeout((()=>{app.animation.acceleration=app.animation.constants.SLOW_DOWN,app.animation.acceleration*=t*t}),Math.round(1500+1e3*Math.random())),animateRollTier3()}async function getPFP(e){let t=[];return new Promise((async n=>{try{let a=await fetch(`https://helper.donk.workers.dev/twitch/users?login=${e.join(",")}`),s=await a.json();for(let e=0,n=s.data.length;e<n;e++)t.push(s.data[e]);return n(t)}catch(e){return console.log("getPFP",e),n(0)}}))}const fpsBenchmark=function(){let e=performance.now(),t=0,n=0,a=!0;console.log("Performance test started.");const s=function(){let i=performance.now();t+=1,n=((t-1)*n-e+i)/t,e=i,a&&window.requestAnimationFrame(s)};s(),setTimeout((()=>{a=!1,app.animation.projectedFPS=1e3/n,console.info(`Performance test ended.\n- avg frame time: ${n}\n- projected FPS: ${app.animation.projectedFPS}\n- test frames drawn: ${t} in 1 sec`)}),1e3)};function raffleWinnerChat(e,t,n){let a=escapeString(t);if(e.emotes){let n=[];for(const[a,s]of Object.entries(e.emotes))for(let e=0,i=s.length;e<i;e++){if(n.some((e=>e.id==a)))continue;let i=s[e].split("-");n.push({emote:[...t].slice(parseInt(i[0],10),parseInt(i[1],10)+1).join(""),id:a})}for(let e=0,t=n.length;e<t;e++){let t=`<img src="https://static-cdn.jtvnw.net/emoticons/v2/${n[e].id}/default/dark/1.0" title="${n[e].emote}" alt="${n[e].emote}" class="emote">`;a=a.replaceAll(n[e].emote,t)}}a=replaceEmotes(a,thirdPartyEmotes);let s=e.username==e["display-name"].toLowerCase()?`${e["display-name"]}`:`${e["display-name"]} (${e.username})`,i=e.color?e.color:"#FFFFFF",r=addBadges(e.badges,e["user-id"],e.firstmsg),l=document.createElement("p");l.innerHTML=`${r}<span style="color:${i};"> ${s}:</span> ${a}`,n?(elements.raffleOutputTier3.append(l),linkifyElementID("raffleOutputTier3",!1)):(elements.raffleOutput.append(l),linkifyElementID("raffleOutput",!1))}function removeFromRaffle(e){raffle_users=raffle_users.filter((t=>t.username!==e)),document.getElementById(e+"_raffle").remove(),elements.entrants.innerHTML=`Entrants: ${raffle_users.length}`}function removeFromRaffleTier3(e){raffle_users_tier3=raffle_users_tier3.filter((t=>t.username!==e)),document.getElementById(e+"_raffle_tier3").remove(),elements.entrantsTier3.innerHTML=`Entrants: ${raffle_users_tier3.length}`}async function getEmotes(){setTimeout((async()=>{let e=await getGlobalBTTVEmotes(),t=await getGlobalFFZEmotes(),n=await getGlobal7TVEmotes(),a=await getChannelBTTVEmotes(userid),s=await getChannelFFZEmotes(userid),i=await getChannel7TVEmotes(userid);thirdPartyEmotes=[...thirdPartyEmotes,...e,...t,...n,...a,...s,...i]}),3e3)}async function loadTier3Emotes(){try{let e=await fetch("https://helper.donk.workers.dev/twitch/chat/emotes?broadcaster_id=22484632"),t=await e.json();elements.emotes.innerHTML="";for(let e=0;e<t.data.length;e++)3e3==t.data[e].tier&&(tier3Emotes.push(t.data[e].id),elements.emotes.insertAdjacentHTML("afterbegin",`<img title="${t.data[e].name}" src="https://static-cdn.jtvnw.net/emoticons/v2/${t.data[e].id}/default/dark/1.0"> `))}catch(e){console.log(e),elements.emotes.innerHTML='<span class="text-danger">Could not load emotes</span>'}}window.onload=async function(){connect(),fpsBenchmark(),restartRaffleModal=new bootstrap.Modal(elements.restartRaffleModal),restartTier3RaffleModal=new bootstrap.Modal(elements.restartTier3RaffleModal),fancyRaffleModal=new bootstrap.Modal(elements.fancyRaffleModal),enableTooltips(),tickSound=new Howl({src:["/raffles/tick.mp3"]}),revealSound=new Howl({src:["/raffles/reveal.mp3"]}),loadTier3Emotes()},window.onbeforeunload=function(){return"Are you sure?"};