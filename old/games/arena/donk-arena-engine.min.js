const arena={params:Object.freeze(arenaSetup.params),settings:arenaSetup.settings,callbacks:arenaSetup.callbacks,units:new Set,teams:{red:{units:new Set,alive:new Set},blue:{units:new Set,alive:new Set}},summons:new Set,unitStats:new Map,player:null,groups:{killfeedDelayer:null,projectiles:null,platforms:null,neutral:null,units:null,units_red:null,units_blue:null},buttons:{},cursors:null,engine:null,source:null,particles:null,ui:{abilityIcon:null,cooldownMask:null},internals:{isTeamMode:!1,validTeams:["red","blue"],globalScale:arenaSetup.params.unitScale||1,aliveReporter:new Set,plugdj:null,randomNamePool:["Forsen clone #","Twitch viewer #","Pepega #"],notificationLastObject:{active:!1},notificationLastY:128,killFeedLastObject:{active:!1},killFeedLastY:64,HEALTHBAR_COLOR_FLAGS:{RED:16711680,GREEN:65280},KILLFEED_COLLISION_MASKS:{PADDER:8,BIGTOAST:4,TOAST:2,DYING:1},playerStub:{dead:!0}},aux:{findUnitByName:function(a){if(!a)return null;for(const e of arena.units)if(e.name===a)return e;for(const e of arena.teams.red.units)if(e.name===a)return e;for(const e of arena.teams.blue.units)if(e.name===a)return e;return console.warn(`Unit [name:${a}] not found!`),null},findUnitByGuid:function(a){if(!a)return null;for(const e of arena.units)if(e.guid===a)return e;for(const e of arena.teams.red.units)if(e.guid===a)return e;for(const e of arena.teams.blue.units)if(e.guid===a)return e;return console.warn(`Unit [guid:${a}] not found!`),null},getUnitStatsByName:function(a){for(const e of arena.unitStats)if(e.name===a)return e;return console.warn(`Stats: Unit [name:${a}] not found!`),null},getSize:()=>arena.units.size+arena.teams.blue.units.size+arena.teams.red.units.size,getTeamSize:a=>{try{return arena.teams[a].units.size}catch(e){throw console.error(e),new Error(`Team identifier [${a}] is invalid!`)}},getTotalSize:()=>arena.aux.getSize()+arena.summons.size,getCanvas:()=>arena.engine.canvas,addUnit:function(a,e,t="-",n=!1,r=""){if("waiting"!==arena.state&&!arena.settings.allowNewUnitsAfterStart)throw console.warn("The arena is not accepting new units! | Set arena.settings.allowNewUnitsAfterStart to override this behavior."),new Error("Cannot join the Arena right now!");if(!n&&arena.settings.unitLimit&&arena.settings.unitLimit<=arena.aux.getSize())throw console.warn("Unit limit reached! Cannot add new unit. | Limit = "+arena.settings.unitLimit),new Error("Too many units!");a||(a=arena.internals.randomNamePool[Math.floor(Math.random()*arena.internals.randomNamePool.length)]+String(Math.random()).slice(2,7).padStart(5,"0")),ArenaUnitFactory(t)||(t=["rogue","hunter","mage","paladin","shaman","priest"][Math.floor(6*Math.random())]);const s=new(ArenaUnitFactory(t))(arena.source,arena.params.width*(.1+.8*Math.random()),Math.random()*arena.params.height*.9,a,e,r.toLowerCase());return console.log("New unit added: ",s.name,s.class),s},addPlayer:function(a,e,t,n){if(arena.player)throw new Error("Player already exists! Restart the arena to clear the reference.");let r=arena.aux.addUnit(a,e,t,!0,n).setControllable();return arena.settings.playerCanWalkWhileFreezeTime&&r.setFrozen(!1),r},startArena:function(){if(arena.internals.isTeamMode){if(!arena.teams.blue.units.size||!arena.teams.red.units.size)throw console.warn("[team mode] Need at least 1 unit on each team to start!"),new Error("One of the teams is empty!")}else if(arena.units.size<2)throw console.warn("Need at least 2 participants to start!"),new Error("Not enough units to start Arena!");arena.source.events.emit("arena-start")},resetArena:function(){arena.source&&arena.source.events?arena.source.events.emit("arena-cleanup"):console.log("arena not ready")},toggleTeamMode:function(a){return a=void 0===a?!arena.internals.isTeamMode:Boolean(a),arena.internals.isTeamMode!==a&&(console.log("[Arena] Team mode has been toggled; will have to clear the arena."),arena.source.events.emit("arena-cleanup")),arena.internals.isTeamMode=a,arena.internals.isTeamMode}},state:"init"};arena.engine=new Phaser.Game({type:Phaser.AUTO,width:arena.params.width,height:arena.params.height,powerPreference:"high-performance",canvasStyle:arena.params.style||null,parent:"string"==typeof arena.params.parent?document.querySelector(arena.params.parent):arena.params.parent,callbacks:{postBoot:a=>{a.canvas.addEventListener("fullscreenchange",(()=>{a.canvas===document.fullscreenElement?arena.buttons.fullscreen.setTexture("fs-out"):arena.buttons.fullscreen.setTexture("fs-in")}))}},scene:{active:!0,physics:{arcade:{gravity:{y:999},friction:{x:500},enableBody:!0,debug:!1},matter:{gravity:{y:-.2},restitution:0,debug:!1}},preload:function(){Object.keys(arenaSetup.resources).forEach((a=>{Object.keys(arenaSetup.resources[a]).forEach((e=>{switch(a){case"audio":"object"==typeof arenaSetup.resources[a][e]?this.load.audioSprite(e,arenaSetup.resources[a][e]):this.load.audio(e,arenaSetup.resources[a][e]);break;default:Array.isArray(arenaSetup.resources[a][e])?this.load[a](e,...arenaSetup.resources[a][e]):this.load[a](e,arenaSetup.resources[a][e]);break}}))}))},create:function(){arena.source=this,this.sound.pauseOnBlur=!1,this.sound.getCustomExponent=arena.params.exponentialSoundLevels?()=>.045+Math.exp(-.05*(arena.units.size+arena.teams.blue.units.size+arena.teams.red.units.size)):()=>1,this.sound.add("dummy-attack"),this.sound.add("dummy-hit"),this.sound.add("rogue-attack"),this.sound.add("rogue-hit"),this.sound.add("hunter-attack"),this.sound.add("hunter-hit"),this.sound.add("mage-attack"),this.sound.add("mage-hit"),this.sound.add("paladin-attack"),this.sound.add("paladin-hit"),this.sound.add("shaman-attack"),this.sound.add("shaman-hit"),this.sound.add("priest-attack"),this.sound.add("priest-hit"),this.sound.add("unit-death"),this.sound.add("heal"),this.sound.add("blink"),this.sound.add("grenade"),this.sound.add("grenade-explode"),this.sound.add("meteor"),this.sound.add("repel"),arena.internals.plugdj=Phaser.Sound.SoundManagerCreator.create(this.game),arena.internals.plugdj.pauseOnBlur=!1,arena.internals.plugdj.addAudioSprite("arena-ost"),arena.internals.plugdj.add("arena-end"),setInterval((()=>{arena.internals.plugdj.setMute(!arena.settings.music),arena.internals.plugdj.setVolume(arena.settings.musicVolume)}),100),this.add.image(0,0,"sky").setOrigin(0,0).setDisplaySize(arena.params.width,arena.params.height),document.body.requestFullscreen&&(arena.buttons.fullscreen=this.add.image(arena.params.width-4,arena.params.height-4,"fs-in").setScale(.4).setDepth(99).setOrigin(1,1).setTintFill(16777215).setInteractive(),arena.buttons.fullscreen.on("pointerover",(()=>{arena.buttons.fullscreen.setTintFill(13421670)})),arena.buttons.fullscreen.on("pointerout",(()=>{arena.buttons.fullscreen.setTintFill(16777215)})),arena.buttons.fullscreen.on("pointerdown",(()=>{arena.engine.canvas===document.fullscreenElement?document.exitFullscreen():arena.engine.canvas.requestFullscreen()}))),this.anims.create({key:"anim-hit-melee",skipMissedFrames:!0,frames:this.anims.generateFrameNumbers("hit-melee",{start:0,end:3}),duration:100}),this.anims.create({key:"anim-hit-bullet",skipMissedFrames:!0,frames:this.anims.generateFrameNumbers("hit-bullet"),repeat:-1}),this.anims.create({key:"anim-hit-fireball",skipMissedFrames:!0,frames:this.anims.generateFrameNumbers("hit-fireball"),repeat:-1}),this.anims.create({key:"anim-hit-weakmagic",skipMissedFrames:!0,frames:this.anims.generateFrameNumbers("hit-weakmagic"),repeat:-1}),this.anims.create({key:"anim-abil-blink",skipMissedFrames:!0,frames:this.anims.generateFrameNumbers("abil-blink"),duration:222}),this.anims.create({key:"anim-abil-grenade",skipMissedFrames:!0,frames:this.anims.generateFrameNumbers("abil-grenade"),repeat:-1}),this.anims.create({key:"anim-explosion",skipMissedFrames:!0,frames:this.anims.generateFrameNumbers("explosion"),repeat:0}),this.anims.create({key:"anim-meteor",skipMissedFrames:!0,frames:this.anims.generateFrameNumbers("meteor"),repeat:-1}),this.anims.create({key:"anim-meteor-smoke",skipMissedFrames:!0,frames:this.anims.generateFrameNumbers("meteor-smoke")}),arena.particles=[this.add.particles("meteor-smoke",0),this.add.particles("meteor-smoke",1),this.add.particles("meteor-smoke",3),this.add.particles("meteor-smoke",2)],arena.groups.platforms=this.physics.add.staticGroup();let a=arena.groups.platforms.create(.5*arena.params.width,arena.params.height,"ground");a.setDisplaySize(1.2*arena.params.width,2*a.height).refreshBody(),arena.groups.platforms.create(.05*arena.params.width,.35*arena.params.height,"ground").setScale(.8,1).refreshBody(),arena.groups.platforms.create(.95*arena.params.width,.35*arena.params.height,"ground").setScale(.8,1).refreshBody(),arena.groups.platforms.create(.24*arena.params.width,.58*arena.params.height,"ground").setScale(.75,1).refreshBody(),arena.groups.platforms.create(.76*arena.params.width,.58*arena.params.height,"ground").setScale(.75,1).refreshBody(),arena.groups.platforms.create(0*arena.params.width,.77*arena.params.height,"ground").setScale(.7,1).refreshBody(),arena.groups.platforms.create(1*arena.params.width,.77*arena.params.height,"ground").setScale(.7,1).refreshBody(),arena.groups.platforms.create(.5*arena.params.width,.77*arena.params.height,"ground").setScale(.8,1).refreshBody(),arena.groups.units=this.physics.add.group(),arena.groups.units_red=this.physics.add.group(),arena.groups.units_blue=this.physics.add.group(),arena.groups.controllable=this.physics.add.group(),arena.groups.projectiles=this.physics.add.group(),arena.groups.killfeedDelayer=this.matter.add.rectangle(arena.params.width/2,-12,3*arena.params.width,24,{isStatic:!0,collisionFilter:{category:arena.internals.KILLFEED_COLLISION_MASKS.PADDER,mask:arena.internals.KILLFEED_COLLISION_MASKS.TOAST|arena.internals.KILLFEED_COLLISION_MASKS.BIGTOAST}}),arena.ui.abilityIcon=this.add.image(4,4).setOrigin(0,0).setScale(.5).setTint(6908265),arena.ui.cooldownMask=this.make.graphics(),arena.ui.cooldownMask.fillPath(),arena.cursors=this.input.keyboard.createCursorKeys(),this.events.on("arena-cleanup",(()=>{console.log("Arena: cleanup is in order, re-initializing everything."),arena.source.sound.stopAll(),arena.internals.plugdj.stopAll(),arena.internals.aliveReporter.clear(),arena.teams.blue.alive.clear(),arena.teams.red.alive.clear(),arena.unitStats.clear();for(const a of arena.units)a.destroy();for(const a of arena.teams.red.units)a.destroy();for(const a of arena.teams.blue.units)a.destroy();for(const a of arena.summons)a.destroy();delete arena.player,arena.source.scene.remove("gameover"),arena.source.physics.world.timeScale=1,arena.source.events.off("arena-finished"),arena.source.events.off("arena-top2"),arena.source.events.off("arena-top10"),arena.source.events.off("arena-last-red"),arena.source.events.off("arena-last-blue"),arena.state="waiting",arena.callbacks.arenaRestart&&arena.callbacks.arenaRestart()})),this.events.on("arena-start",(()=>{if(console.log("Arena: the fight begins!"),arena.state="started",arena.params.notify&&(new ArenaNotification).fillWithText("Trickle in!","#fff").show(arena.params.notifyDuration),arena.player){arena.player.ability.lastUsed=0,arena.player.ability.availableAt=0,Object.keys(arena.player.stats).forEach((a=>{arena.player.stats[a]=0})),arena.player.stats.lastKilledBy=null;for(const a of arena.summons)a.destroy()}[arena.units,arena.teams.red.units,arena.teams.blue.units].forEach((a=>a.forEach((a=>{a.setFrozen(!1),a.initializeBot(arena.source.time.now)})))),arena.internals.plugdj.playAudioSprite("arena-ost","ost-main-begin"),arena.internals.plugdj.queuedTrack=setTimeout((()=>{arena.internals.plugdj.playAudioSprite("arena-ost","ost-main-loop",{loop:!0})}),999*(arenaSetup.resources.audio["arena-ost"].spritemap["ost-main-begin"].end-arenaSetup.resources.audio["arena-ost"].spritemap["ost-main-begin"].start)),arena.settings.goFullscreenOnStart&&arena.engine.canvas.requestFullscreen&&arena.engine.canvas.requestFullscreen(),[arena.units,arena.teams.red.units,arena.teams.blue.units].reduce(((a,e)=>a+e.size),0)>arena.params.killFeedHardLimit&&new ArenaKillFeedNotification({name:`Kill feed will be disabled while there are more than ${arena.params.killFeedHardLimit} units!`,color:"white"}),arena.source.events.once("arena-top10",(()=>{clearTimeout(arena.internals.plugdj.queuedTrack),arena.internals.plugdj.stopAll(),arena.internals.plugdj.playAudioSprite("arena-ost","ost-suspense-begin"),arena.internals.plugdj.queuedTrack=setTimeout((()=>{arena.internals.plugdj.playAudioSprite("arena-ost","ost-suspense-loop",{loop:!0})}),999*(arenaSetup.resources.audio["arena-ost"].spritemap["ost-suspense-begin"].end-arenaSetup.resources.audio["arena-ost"].spritemap["ost-suspense-begin"].start)),arena.params.notify&&(new ArenaNotification).fillWithText("Top 10 situation!","#ff0").show(arena.params.notifyDuration)})),arena.source.events.once("arena-top2",(()=>{clearTimeout(arena.internals.plugdj.queuedTrack),arena.internals.plugdj.stopAll(),arena.internals.plugdj.playAudioSprite("arena-ost","ost-finale-begin"),arena.internals.plugdj.queuedTrack=setTimeout((()=>{arena.internals.plugdj.playAudioSprite("arena-ost","ost-finale-loop",{loop:!0})}),999*(arenaSetup.resources.audio["arena-ost"].spritemap["ost-finale-begin"].end-arenaSetup.resources.audio["arena-ost"].spritemap["ost-finale-begin"].start)),arena.params.notify&&(new ArenaNotification).fillWithText("1v1 SHOWDOWN","#f33").show(arena.params.notifyDuration)})),arena.teams.red.units.size>1&&arena.source.events.once("arena-last-red",(()=>{clearTimeout(arena.internals.plugdj.queuedTrack),arena.internals.plugdj.stopAll(),arena.internals.plugdj.playAudioSprite("arena-ost","ost-finale-begin"),arena.internals.plugdj.queuedTrack=setTimeout((()=>{arena.internals.plugdj.playAudioSprite("arena-ost","ost-finale-loop",{loop:!0})}),999*(arenaSetup.resources.audio["arena-ost"].spritemap["ost-finale-begin"].end-arenaSetup.resources.audio["arena-ost"].spritemap["ost-finale-begin"].start)),arena.params.notify&&(new ArenaNotification).fillWithText("Last man standing","#f66").show(arena.params.notifyDuration)})),arena.teams.blue.units.size>1&&arena.source.events.once("arena-last-blue",(()=>{clearTimeout(arena.internals.plugdj.queuedTrack),arena.internals.plugdj.stopAll(),arena.internals.plugdj.playAudioSprite("arena-ost","ost-finale-begin"),arena.internals.plugdj.queuedTrack=setTimeout((()=>{arena.internals.plugdj.playAudioSprite("arena-ost","ost-finale-loop",{loop:!0})}),999*(arenaSetup.resources.audio["arena-ost"].spritemap["ost-finale-begin"].end-arenaSetup.resources.audio["arena-ost"].spritemap["ost-finale-begin"].start)),arena.params.notify&&(new ArenaNotification).fillWithText("Last man standing","#6af").show(arena.params.notifyDuration)})),arena.source.events.once("arena-finished",(a=>{console.log("Arena: the war is over, and the winner is:",a),[arena.units,arena.summons,arena.teams.blue.units,arena.teams.red.units].forEach((a=>a.forEach((a=>{a.setFrozen(!0)})))),arena.source.physics.world.timeScale=5,arena.source.cameras.main.fadeOut(4444,0,0,0),clearTimeout(arena.internals.plugdj.queuedTrack),arena.internals.plugdj.stopAll(),arena.internals.plugdj.play("arena-end"),setTimeout((()=>{arena.state="finished",arena.source.events.emit("arena-show-winner",a),arena.engine.scene.add("gameover",{create:function(){this.add.rectangle(0,0,arena.params.width,arena.params.height,"black",.7).setOrigin(0,0);let e=this.add.text(.44*arena.params.width,.51*arena.params.height,a.name,{font:"bold 100px Arial",fill:a.color,boundsAlignH:"left",boundsAlignV:"bottom",textAlign:"left"}).setShadow(0,0,"#000",4).setOrigin(0,1).setScale(1.3);for(;e.displayWidth>.5*arena.params.width;)e.setScale(.9*e.scale);this.add.text(.44*arena.params.width,.17*arena.params.height,"The Champion",{font:"bold 64px Arial",fill:"#ffc",boundsAlignH:"left",boundsAlignV:"top",textAlign:"left"}).setShadow(0,0,"#cb0",4).setOrigin(0,0),this.add.image(.25*arena.params.width,.3*arena.params.height,a.class).setScale(3);const t={frag:{stats:{frag:-1}},damage:{stats:{damage:-1}},ability:{stats:{ability:-1}}};Object.keys(t).forEach((a=>{arena.unitStats.forEach((e=>{e.stats[a]>t[a].stats[a]&&(t[a]=e)}))}));let n={text:"The Proficient",textExplain:"Most abilities used: #",source:t.ability};arena.player&&arena.player.stats.lastKilledBy&&(n.text="The Stream Saver",n.textExplain="Killed the streamer!",n.source=arena.player.stats.lastKilledBy);let r=this.add.text(.13*arena.params.width,.82*arena.params.height,t.damage.name,{font:"bold 36px Arial",fill:t.damage.color,boundsAlignH:"left",boundsAlignV:"bottom",textAlign:"left"}).setShadow(0,0,"#000",4).setOrigin(0,.5).setScale(1.3);for(;r.displayWidth>.2*arena.params.width;)r.setScale(.8*r.scale);this.add.text(.13*arena.params.width,.73*arena.params.height,"The Ravager",{font:"bold 24px Arial",fill:"white",boundsAlignH:"left",boundsAlignV:"top",textAlign:"left"}).setShadow(0,0,"#ccc",4).setOrigin(0,0),this.add.text(.13*arena.params.width,.88*arena.params.height,"Most damage dealt: "+t.damage.stats.damage,{font:"bold 16px Arial",fill:"#aaa",boundsAlignH:"left",boundsAlignV:"top",textAlign:"left"}).setShadow(0,0,"#000",4).setOrigin(0,0),this.add.image(.07*arena.params.width,.8*arena.params.height,t.damage.class).setScale(1.3);let s=this.add.text(.46*arena.params.width,.82*arena.params.height,t.frag.name,{font:"bold 36px Arial",fill:t.frag.color,boundsAlignH:"left",boundsAlignV:"bottom",textAlign:"left"}).setShadow(0,0,"#000",4).setOrigin(0,.5).setScale(1.3);for(;s.displayWidth>.2*arena.params.width;)s.setScale(.8*s.scale);this.add.text(.46*arena.params.width,.73*arena.params.height,"The Killer",{font:"bold 24px Arial",fill:"white",boundsAlignH:"left",boundsAlignV:"top",textAlign:"left"}).setShadow(0,0,"#ccc",4).setOrigin(0,0),this.add.text(.46*arena.params.width,.88*arena.params.height,"Most kills: "+t.frag.stats.frag,{font:"bold 16px Arial",fill:"#aaa",boundsAlignH:"left",boundsAlignV:"top",textAlign:"left"}).setShadow(0,0,"#000",4).setOrigin(0,0),this.add.image(.4*arena.params.width,.8*arena.params.height,t.frag.class).setScale(1.3);let i=this.add.text(.79*arena.params.width,.82*arena.params.height,n.source.name,{font:"bold 36px Arial",fill:n.source.color,boundsAlignH:"left",boundsAlignV:"bottom",textAlign:"left"}).setShadow(0,0,"#000",4).setOrigin(0,.5).setScale(1.3);for(;i.displayWidth>.2*arena.params.width;)i.setScale(.8*i.scale);this.add.text(.79*arena.params.width,.73*arena.params.height,n.text,{font:"bold 24px Arial",fill:"white",boundsAlignH:"left",boundsAlignV:"top",textAlign:"left"}).setShadow(0,0,"#ccc",4).setOrigin(0,0),this.add.text(.79*arena.params.width,.88*arena.params.height,n.textExplain.replace("#",n.source.stats.ability),{font:"bold 16px Arial",fill:"#aaa",boundsAlignH:"left",boundsAlignV:"top",textAlign:"left"}).setShadow(0,0,"#000",4).setOrigin(0,0),this.add.image(.73*arena.params.width,.8*arena.params.height,n.source.class).setScale(1.3)},update:function(){}},!0),arena.source.cameras.main.resetFX()}),2222)})),arena.callbacks.arenaStart&&arena.callbacks.arenaStart()})),this.events.on("arena-show-winner",(()=>{console.log("Arena: the end-game screen is being shown."),arena.settings.exitFullscreenOnEnd&&document.exitFullscreen&&document.exitFullscreen().catch((a=>console.error(a)))})),this.events.emit("arena-cleanup"),arena.callbacks.unitDied&&arena.source.events.on("arena-unit-died",arena.callbacks.unitDied),arena.callbacks.arenaEnd&&arena.source.events.on("arena-show-winner",arena.callbacks.arenaEnd)},update:function(a,e){if(arena.units.forEach((e=>{e.drawFrame(),e.processBotAction(a)})),arena.teams.red.units.forEach((e=>{e.drawFrame(),e.processBotAction(a)})),arena.teams.blue.units.forEach((e=>{e.drawFrame(),e.processBotAction(a)})),arena.summons.forEach((e=>{e.drawFrame(),e.processBotAction(a)})),!arena.player||arena.player.dead)return;arena.player.doMove(+arena.cursors.right.isDown-arena.cursors.left.isDown),arena.cursors.up.isDown&&arena.player.doJump(),arena.cursors.space.isDown&&arena.player.doAttack(),arena.cursors.shift.isDown&&arena.player.doAbility();let t=Date.now();t=360*(arena.player.ability.availableAt>t)*(arena.player.ability.availableAt-t)/arena.player.ability.cooldown,arena.ui.cooldownMask.clear(),arena.ui.cooldownMask.slice(36,36,2*arena.ui.abilityIcon.width,Phaser.Math.DegToRad(270),Phaser.Math.DegToRad(t-90),!0),arena.ui.cooldownMask.fillPath(),arena.ui.abilityIcon.setMask(arena.ui.cooldownMask.createGeometryMask()),t||arena.ui.abilityIcon.clearTint()}}});