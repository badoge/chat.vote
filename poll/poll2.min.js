let myChart,captchaModal,reportModal,token,barChart=!0,pieChart=!1,cooldown=!1,sorted=!1,unsortedData={},darkTheme=!0,elements={captchaModal:document.getElementById("captchaModal"),reportModal:document.getElementById("reportModal"),reason:document.getElementById("reason"),reportDetails:document.getElementById("reportDetails"),reportContact:document.getElementById("reportContact"),report:document.getElementById("report"),toastContainer:document.getElementById("toastContainer"),vote:document.getElementById("vote"),unblur:document.getElementById("unblur"),mainrow:document.getElementById("mainrow"),darkTheme:document.getElementById("darkTheme")};const ckey="6LdzxrwdAAAAADyHX2t8ZS4U5QxTNLVWNrGOeNp0";function showCountdown(t){document.getElementById("countdowndiv").innerHTML='\n    <div class="card border-danger" id="countdown">\n    <div class="card-body" style="padding: 0px">\n    <div class="values" style="font-size: 3em;"></div>\n    </div>\n    </div>';let e=new easytimer.Timer;e.start({countdown:!0,startValues:{seconds:parseInt(t,10)-Date.now()/1e3}}),document.querySelector("#countdown .values").innerHTML="Poll closes in "+e.getTimeValues().toString(),e.addEventListener("secondsUpdated",(function(t){document.querySelector("#countdown .values").innerHTML="Poll closes in "+e.getTimeValues().toString()})),e.addEventListener("targetAchieved",(function(t){document.querySelector("#countdown .values").innerHTML="Poll closed",elements.vote&&(elements.vote.disabled=!0)})),parseInt(t,10)-Date.now()/1e3<0&&(document.querySelector("#countdown .values").innerHTML="Poll closed",elements.vote&&(elements.vote.disabled=!0))}function unblur(){if('<i class="material-icons notranslate">visibility</i>Show images'==elements.unblur.innerHTML){elements.unblur.innerHTML='<i class="material-icons notranslate">visibility_off</i>Hide images';let t=document.querySelectorAll(".blur");for(let e=0,a=t.length;e<a;e++)t[e].className="noblur"}else{elements.unblur.innerHTML='<i class="material-icons notranslate">visibility</i>Show images';let t=document.querySelectorAll(".noblur");for(let e=0,a=t.length;e<a;e++)t[e].className="blur"}}async function report(t){let e=parseInt(elements.reason.value,10);if(!e)return void showToast("You need to select a reason","warning",2e3);let a=elements.reportDetails.value,o=elements.reportContact.value;elements.report.disabled=!0,elements.report.innerHTML=spinner;try{if(token=await grecaptcha.execute(ckey,{action:"submit"}),!token)return reportModal.hide(),captchaModal.show(),elements.report.disabled=!1,void(elements.report.innerHTML="Submit report");let n={method:"POST",headers:{"Content-Type":"application/json"},redirect:"follow",body:JSON.stringify({id:t,reason:e,reportDetails:a,reportContact:o,captchatoken:token})},l=await fetch("https://poll.chat.vote/api/report",n),r=await l.json();if(200!=r.status)return showToast(r.message,"warning",5e3),reportModal.hide(),elements.report.disabled=!1,void(elements.report.innerHTML="Submit report");showToast(r.message,"info",3e3),reportModal.hide(),elements.report.disabled=!1,elements.report.innerHTML="Submit report"}catch(t){if(elements.report.disabled=!1,elements.report.innerHTML="Submit report",!token)return reportModal.hide(),void captchaModal.show();console.log(t)}}async function vote(){let t=[[]],e=document.querySelectorAll(".polloption"),a=e[0].type,o=new URL(window.location.href).pathname.slice(1).split("/")[0];if("radio"==a){for(let a=0,o=e.length;a<o;a++)if(e[a].checked){t[0].push(e[a].value);break}}else if("checkbox"==a)for(let a=0,o=e.length;a<o;a++)e[a].checked&&t[0].push(e[a].value);if(0!=t[0].length){try{if(token=await grecaptcha.execute(ckey,{action:"submit"}),!token)return void captchaModal.show();let e={method:"POST",headers:{"Content-Type":"application/json"},redirect:"follow",body:JSON.stringify({vote:t})},a=await fetch(`https://poll.chat.vote/api/vote/${o}/${token}`,e),n=await a.json();if(console.log(n),200!=n.status)return void showToast(n.message,"warning",5e3);if(showToast(n.message,"primary",5e3),unsortedData=structuredClone(n.data),n.data.votes){let t=n.data.votes.reduce(((t,e)=>t+e),0)||0;elements.mainrow.innerHTML=`\n      <div class="col-xl-2"></div>\n      <div class="col-xl-8">\n        <div class="card bg-dark-subtle">\n          <div class="card-body">\n            <div id="countdowndiv"></div>\n            ${"Untitled poll"==n.data.title?"":"<h1 class='display-5'>"+validator.escape(n.data.title)+"</h1>"}\n            <div id="chartdiv" class="chart-container">\n              <canvas id="chartCanvas"></canvas>\n            </div>\n            <div class="container">\n              <div class="row mt-3">\n                <div class="col">\n                  <div class="btn-group" role="group" aria-label="chart type toggles">\n                    <input class="btn-check" type="radio" name="charttype" id="barChart" autocomplete="off" checked />\n                    <label class="btn btn-outline-info" for="barChart" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Bar chart">\n                      <i style="transform: rotateZ(90deg)" class="material-icons notranslate">stacked_bar_chart</i>\n                    </label>\n                    <input class="btn-check" type="radio" name="charttype" id="pieChart" autocomplete="off" />\n                    <label class="btn btn-outline-info" for="pieChart" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Pie chart">\n                      <i class="material-icons notranslate">pie_chart</i>\n                    </label>\n                    </div>\n                    <input type="checkbox" class="btn-check" id="sortChart" autocomplete="off" ${sorted?"checked":""}/>\n                    <label class="btn btn-outline-success" for="sortChart" id="sortChartLabel" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="${sorted?"Unsort chart":"Sort chart"}"\n                      ><i class="material-icons notranslate">sort</i>\n                    </label>\n                    <div class="chartStatDiv">Total votes: <span id="totalVotes">${t}</span></div>\n                </div>\n                <div class="col">\n                <button type="button" onclick="refresh()" class="float-end btn btn-info" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Refresh score">\n                <i class="material-icons notranslate">refresh</i>\n                </button>\n                <button type="button" id="backToPoll" onclick="backToPoll()" class="float-end btn btn-secondary" data-bs-toggle="tooltip"data-bs-placement="top" data-bs-title="Back to poll">\n                <i class="material-icons notranslate">arrow_back</i>\n                </button>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n      <div class="col-xl-2"></div>`,n.data.endTime&&parseInt(n.data.endTime,10)-Date.now()/1e3>0&&showCountdown(n.data.endTime),loadChart(),document.getElementById("barChart").onchange=function(){barChart=this.checked,pieChart=!this.checked,loadChart()},document.getElementById("pieChart").onchange=function(){pieChart=this.checked,barChart=!this.checked,loadChart()},document.getElementById("sortChart").addEventListener("click",(function(){sorted=this.checked;bootstrap.Tooltip.getInstance("#sortChartLabel").setContent({".tooltip-inner":this.checked?"Unsort chart":"Sort chart"}),loadChart()}),!1)}}catch(t){if(!token)return void captchaModal.show();console.log(t)}enableTooltips(),linkifyElementID("mainrow",!0)}else showToast("You need to pick an option","warning",1500)}async function refresh(){if(!cooldown){cooldown=!0,setTimeout((()=>{cooldown=!1}),5e3);try{let t=new URL(window.location.href).pathname.slice(1).split("/")[0];if(token=await grecaptcha.execute(ckey,{action:"submit"}),!token)return void captchaModal.show();let e={method:"GET",redirect:"follow"},a=await fetch(`https://poll.chat.vote/api/results/${t}/${token}`,e),o=await a.json();if(console.log(o),showToast(o.message,"primary",5e3),unsortedData=structuredClone(o.data),o.data.scores){let t=o.data.votes.reduce(((t,e)=>t+e),0)||0;elements.mainrow.innerHTML=`\n      <div class="col-xl-2"></div>\n      <div class="col-xl-8">\n        <div class="card bg-dark-subtle">\n          <div class="card-body">\n            <div id="countdowndiv"></div>\n            ${"Untitled poll"==o.data.title?"":"<h1 class='display-5'>"+validator.escape(o.data.title)+"</h1>"}\n            <div id="chartdiv" class="chart-container">\n              <canvas id="chartCanvas"></canvas>\n            </div>\n            <div class="container">\n              <div class="row mt-3">\n                <div class="col">\n                  <div class="btn-group" role="group" aria-label="chart type toggles">\n                    <input class="btn-check" type="radio" name="charttype" id="barChart" autocomplete="off" checked />\n                    <label class="btn btn-outline-info" for="barChart" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Bar chart">\n                      <i style="transform: rotateZ(90deg)" class="material-icons notranslate">stacked_bar_chart</i>\n                    </label>\n                    <input class="btn-check" type="radio" name="charttype" id="pieChart" autocomplete="off" />\n                    <label class="btn btn-outline-info" for="pieChart" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Pie chart">\n                      <i class="material-icons notranslate">pie_chart</i>\n                    </label>\n                    </div>\n                    <input type="checkbox" class="btn-check" id="sortChart" autocomplete="off" ${sorted?"checked":""}/>\n                    <label class="btn btn-outline-success" for="sortChart" id="sortChartLabel" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="${sorted?"Unsort chart":"Sort chart"}"\n                      ><i class="material-icons notranslate">sort</i>\n                    </label>\n                    <div class="chartStatDiv">Total votes: <span id="totalVotes">${t}</span></div>\n                </div>\n                <div class="col">\n                <button type="button" onclick="refresh()" class="float-end btn btn-info" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Refresh score">\n                <i class="material-icons notranslate">refresh</i>\n                </button>\n                <button type="button" id="backToPoll" onclick="backToPoll()" class="float-end btn btn-secondary" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Back to poll">\n                <i class="material-icons notranslate">arrow_back</i>\n                </button>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n      <div class="col-xl-2"></div>`,o.data.endTime&&parseInt(o.data.endTime,10)-Date.now()/1e3>0&&showCountdown(o.data.endTime),loadChart(),document.getElementById("barChart").onchange=function(){barChart=this.checked,pieChart=!this.checked,loadChart()},document.getElementById("pieChart").onchange=function(){pieChart=this.checked,barChart=!this.checked,loadChart()},document.getElementById("sortChart").addEventListener("click",(function(){sorted=this.checked;bootstrap.Tooltip.getInstance("#sortChartLabel").setContent({".tooltip-inner":this.checked?"Unsort chart":"Sort chart"}),loadChart()}),!1)}}catch(t){if(!token)return void captchaModal.show();console.log(t)}enableTooltips(),linkifyElementID("mainrow",!0)}}function loadChart(){let t=document.getElementById("chartCanvas").getContext("2d"),e=[],a=[],o=structuredClone(unsortedData.scores),n=structuredClone(unsortedData.questions),l=o.reduce(((t,e)=>t+e),0)||0;if(sorted){let t=[];for(let e=0,a=n[0].options.length;e<a;e++)t.push({option:n[0].options[e],score:o[0][e]});t.sort((function(t,e){return t.score>e.score?-1:t.score==e.score?0:1}));for(let a=0,l=n[0].options.length;a<l;a++)e[a]=t[a].option,o[0][a]=t[a].score}else e=n[0].options;for(let t=0,r=n[0].options.length;t<r;t++){let n=o[0][t]?o[0][t]:0;a[t]=`${e[t].name} - ${n} ${1==n?"Vote":"Votes"} (${Math.round(n/l*100)||0}%)`}let r=e.map((t=>t.color));myChart&&myChart.destroy(),barChart?myChart=new Chart(t,{type:"bar",data:{labels:a,datasets:[{label:"Score",data:o[0],borderWidth:2,backgroundColor:r,borderColor:r}]},options:{indexAxis:"y",maintainAspectRatio:!1,scales:{x:{ticks:{color:"white"},beginAtZero:!0},y:{ticks:{textStrokeColor:"rgba(0,0,0,1)",textStrokeWidth:3,color:"white",mirror:!0,font:function(t){let e=n[0].options.length,a=t.chart.height;return{size:Math.round(a/14)-1.5*e}},z:1},beginAtZero:!0}},plugins:{tooltip:{enabled:!1},legend:{display:!1}}}}):pieChart&&(myChart=new Chart(t,{type:"pie",data:{labels:a,datasets:[{label:"Score",data:o[0],borderWidth:2,backgroundColor:r,borderColor:r}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,position:"right",onClick:null,labels:{color:"white",font:function(t){let e=n[0].options.length;return{size:Math.max(30-e,15)}}}}}}}))}function loadResults(){window.location.hash="results",refresh()}function backToPoll(){let t=window.location.href;t=t.replace(/#.*$/,""),window.location.href=t}function switchTheme(t){document.documentElement.setAttribute("data-bs-theme",t?"dark":"light"),document.getElementById("twitchLogo").style.filter=`invert(${t?.25:.65})`}window.onload=function(){darkTheme="true"===(localStorage.getItem("darkTheme")||"true"),elements.darkTheme.checked=darkTheme??!0,switchTheme(elements.darkTheme.checked),captchaModal=new bootstrap.Modal(elements.captchaModal),reportModal=new bootstrap.Modal(elements.reportModal),enableTooltips();let t=document.getElementById("countdowndiv").getAttribute("name");"null"!=t&&showCountdown(t);let e=location.hash.replace("#","").toLowerCase().trim();"r"!=e&&"result"!=e&&"results"!=e||refresh(),linkifyElementID("mainrow",!0),elements.darkTheme.onchange=function(){switchTheme(this.checked),darkTheme=elements.darkTheme.checked??!0,localStorage.setItem("darkTheme",darkTheme)}};