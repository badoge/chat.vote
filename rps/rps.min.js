let elements={loginButton:document.getElementById("loginButton"),topRight:document.getElementById("topRight"),darkTheme:document.getElementById("darkTheme"),loginExpiredModal:document.getElementById("loginExpiredModal"),left_rock:document.getElementById("left_rock"),left_paper:document.getElementById("left_paper"),left_scissors:document.getElementById("left_scissors"),right_rock:document.getElementById("right_rock"),right_paper:document.getElementById("right_paper"),right_scissors:document.getElementById("right_scissors"),toastContainer:document.getElementById("toastContainer"),gameLink:document.getElementById("gameLink"),copyLinkButton:document.getElementById("copyLinkButton"),bracket:document.getElementById("bracket"),start:document.getElementById("start"),next:document.getElementById("next")};const{animate:animate}=anime;let loginExpiredModal,copyLinkButton,webSocket,darkTheme=!0,USER={channel:"",twitchLogin:!1,access_token:"",userID:"",platform:""};function login(){return elements.topRight.innerHTML='<div class="btn-group" role="group" aria-label="log in button group">\n      <button type="button" class="btn btn-twitch"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></button>\n      <div class="btn-group" role="group">\n          <button id="btnGroupDropLogin" type="button" class="btn btn-twitch dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">\n        </button>\n          <ul class="dropdown-menu dropdown-menu-lg-end" aria-label="Log out">\n              <li><a class="dropdown-item" onclick="logout()" href="#"><i class="material-icons notranslate">logout</i>Log out</a></li>\n          </ul>\n      </div>\n  </div>',window.open("/prompt.html","loginWindow","toolbar=0,status=0,scrollbars=0,width=500px,height=800px"),!1}function logout(){elements.topRight.innerHTML='<a role="button" id="loginButton" onclick="login()" class="btn btn-twitch" tabindex="0"> <span class="twitch-icon"></span>Sign in with Twitch </a>',resetSettings(!0)}async function loadPFP(){if(!USER.channel)return void(elements.topRight.innerHTML='<a role="button" id="loginButton" onclick="login()" class="btn btn-twitch" tabindex="0"> <span class="twitch-icon"></span>Sign in with Twitch </a>');let e=await get7TVPFP(USER.userID);"/pics/donk.png"==e&&USER.access_token&&(e=await getTwitchPFP(USER.channel,USER.access_token)),elements.topRight.innerHTML=`\n    <div class="btn-group" role="group" aria-label="Button group with nested dropdown">\n    <button type="button" id="btnGroupDrop2" class="btn btn-${darkTheme?"dark":"secondary"}"><img src="${e}" alt="profile pic" style="height:2em;"></button>\n    <div class="btn-group" role="group">\n    <button id="btnGroupDrop1" type="button" class="btn btn-${darkTheme?"dark":"secondary"} dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">\n    ${USER.channel}\n    </button>\n    <ul class="dropdown-menu dropdown-menu-lg-end" aria-labelledby="btnGroupDrop1">\n    <li><a class="dropdown-item" onclick="logout()" href="#"><i class="material-icons notranslate">logout</i>Log out</a></li>\n    </ul>\n    </div>\n    </div>`}function resetSettings(e=!1){return e&&localStorage.setItem("USER",JSON.stringify({channel:"",twitchLogin:!1,access_token:"",userID:"",platform:""})),location.reload(),!1}async function refreshData(){darkTheme=elements.darkTheme.checked??!0}function saveSettings(){refreshData(),localStorage.setItem("darkTheme",darkTheme),localStorage.setItem("USER",JSON.stringify(USER))}function switchTheme(e){document.documentElement.setAttribute("data-bs-theme",e?"dark":"light"),document.getElementById("btnGroupDrop1")&&document.getElementById("btnGroupDrop2")&&(document.getElementById("btnGroupDrop1").classList.remove(""+(e?"btn-secondary":"btn-dark")),document.getElementById("btnGroupDrop1").classList.add(""+(e?"btn-dark":"btn-secondary")),document.getElementById("btnGroupDrop2").classList.remove(""+(e?"btn-secondary":"btn-dark")),document.getElementById("btnGroupDrop2").classList.add(""+(e?"btn-dark":"btn-secondary")))}function load_localStorage(){localStorage.getItem("USER")?USER=JSON.parse(localStorage.getItem("USER")):console.log("localStorage user info not found")}function connect(){elements.topRight.innerHTML='\n    <div class="btn-group" role="group" aria-label="log in button group">\n    <button type="button" class="btn btn-twitch"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></button>\n    <div class="btn-group" role="group">\n    <button id="btnGroupDropLogin" type="button" class="btn btn-twitch dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false"></button>\n    <ul class="dropdown-menu dropdown-menu-lg-end" aria-label="Log out">\n    <li><a class="dropdown-item" onclick="logout()" href="#"><i class="material-icons notranslate">logout</i>Log out</a></li>\n    </ul>\n    </div>\n    </div>',saveSettings(),loadBadges(USER.channel),loadPFP(),sendUsername("chat.vote/rps",USER.channel,"twitch"==USER.platform?`twitch - ${USER.twitchLogin}`:"youtube"),webSocket=new WebSocket("wss://ws.chat.vote"),webSocket.onopen=function(e){console.log(e),"open"==e.type&&showToast("Connected to server","success",1e3)},webSocket.onmessage=function(e){let t=JSON.parse(e.data);switch(t.id){case"toast":showToast(t.message,t.type,2e3);break;case"start":showToast(t.message,t.type,2e3),resetBracket();break;case"update":addUser(t.username);break;case"update_move":updateUser(t.username);break;case"first_round":showToast(t.message,t.type,2e3),createBracket(t.bracket);break;case"next_round":showToast(t.message,t.type,2e3);break;case"game_over":showToast(t.message,t.type,2e3);break;default:break}console.log(e)},webSocket.onclose=function(e){"close"==e.type&&showToast("disconnected from server","danger",2e3),console.log(e)},webSocket.onerror=function(e){console.log(e)}}function start(){elements.start.disabled=!0,setTimeout((()=>{elements.start.disabled=!1}),2e3),webSocket.send(JSON.stringify({command:"start",username:USER.channel,userid:USER.userID,access_token:USER.access_token}))}function next(){elements.next.disabled=!0,setTimeout((()=>{elements.next.disabled=!1}),2e3),webSocket.send(JSON.stringify({command:"next",username:USER.channel,userid:USER.userID,access_token:USER.access_token}))}function resetBracket(){elements.bracket.innerHTML='\n  <div class="card">\n    <div class="card-header">Players</div>\n    <div class="card-body" id="players"></div>\n  </div>'}function addUser(e){document.getElementById("players").insertAdjacentHTML("afterbegin",`<span class="badge text-bg-secondary m-2" id="${e}_badge">⏳${escapeString(e)}</span>`)}function updateUser(e){document.getElementById(`${e}_badge`).innerHTML=`✔${escapeString(e)}`}function createBracket(e){for(let t=0;t<Object.keys(e).length;t++){let n="";switch(e[`round${t}`].length){case 2:n="Finals";break;case 4:n="Semifinals";break;case 8:n="Quarterfinals";break;default:n=`Round of ${currentBracket[`round${currentRound}`].length}`;break}elements.bracket.insertAdjacentHTML("beforeend",`<div class="card">\n      <div class="card-header">${n}</div>\n      <div class="card-body" id="round${t}"></div>\n      </div>`)}}async function loadAndConnect(){if(load_localStorage(),refreshData(),USER.twitchLogin&&!await checkToken(USER.access_token))return USER.channel="",void loginExpiredModal.show();!1===USER.twitchLogin&&USER.channel?resetSettings(!0):USER.channel&&(connect(),elements.gameLink.value=`https://chat.vote/rps/play#${USER.channel||""}`)}function animateHand(e,t){elements[`${e}_rock`].style.display="",elements[`${e}_paper`].style.display="none",elements[`${e}_scissors`].style.display="none",animate(`#${e}_rock`,{rotate:"left"==e?-30:30,duration:300,alternate:!0,ease:"outElastic(1, .8)",loop:7,onComplete:function(n){elements[`${e}_rock`].style.display="none",elements[`${e}_${t}`].style.display=""}})}function randomAnimations(){let e=["rock","paper","scissors"];elements.left_rock.style.display="",elements.left_paper.style.display="none",elements.left_scissors.style.display="none",elements.right_rock.style.display="",elements.right_paper.style.display="none",elements.right_scissors.style.display="none",animateHand("left",e[Math.floor(Math.random()*e.length)]),animateHand("right",e[Math.floor(Math.random()*e.length)])}window.onload=function(){darkTheme="true"===(localStorage.getItem("darkTheme")||"true"),elements.darkTheme.checked=darkTheme??!0,switchTheme(elements.darkTheme.checked),loginExpiredModal=new bootstrap.Modal(elements.loginExpiredModal),copyLinkButton=new bootstrap.Popover(elements.copyLinkButton),loadAndConnect(),elements.darkTheme.onchange=function(){switchTheme(this.checked),saveSettings()},randomAnimations()};let randomAnimationsInterval=setInterval((()=>{randomAnimations()}),4500);function copyLink(){navigator.clipboard.writeText(`https://chat.vote/rps/play#${USER.channel||""}`),copyLinkButton.show(),setTimeout((()=>{copyLinkButton.hide()}),1e3)}