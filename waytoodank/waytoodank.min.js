const obs=new OBSWebSocket;let fft,w,mic,red,green,blue,hue,sat,myp5,sketch,elements={connect:document.getElementById("connect"),serverIP:document.getElementById("serverIP"),serverPort:document.getElementById("serverPort"),serverPassword:document.getElementById("serverPassword"),scene:document.getElementById("scene"),source:document.getElementById("source"),smoothingslider:document.getElementById("smoothingslider"),redslider:document.getElementById("redslider"),greenslider:document.getElementById("greenslider"),blueslider:document.getElementById("blueslider"),hueslider:document.getElementById("hueslider"),satslider:document.getElementById("satslider"),smoothingvalue:document.getElementById("smoothingvalue"),visualizer:document.getElementById("visualizer"),toastContainer:document.getElementById("toastContainer")},WAYTOODANK={serverIP:"localhost",serverPort:"4455",serverPassword:"",scene:"",source:"",smoothing:.8};function load_localStorage(){localStorage.getItem("WAYTOODANK")&&(WAYTOODANK=JSON.parse(localStorage.getItem("WAYTOODANK")),elements.serverIP.value=WAYTOODANK.serverIP||"localhost",elements.serverPort.value=WAYTOODANK.serverPort||"4455",elements.serverPassword.value=WAYTOODANK.serverPassword||"",elements.scene.value=WAYTOODANK.scene||"",elements.source.value=WAYTOODANK.source||"",elements.smoothingslider.value=parseFloat(WAYTOODANK.smoothing)||.8,elements.smoothingvalue.innerText=`Smoothing: ${WAYTOODANK.smoothing}`||"Smoothing: 0.8")}function saveSettings(){refreshData(),localStorage.setItem("WAYTOODANK",JSON.stringify(WAYTOODANK))}function refreshData(){WAYTOODANK.serverIP=elements.serverIP.value.replace(/\s+/g,""),WAYTOODANK.serverPort=elements.serverPort.value.replace(/\s+/g,""),WAYTOODANK.serverPassword=elements.serverPassword.value,WAYTOODANK.scene=elements.scene.value,WAYTOODANK.source=elements.source.value,WAYTOODANK.smoothing=parseFloat(elements.smoothingslider.value)}function startP5(){sketch=function(e){let t=elements.visualizer,n=t.offsetWidth,s=t.offsetHeight;e.setup=function(){e.createCanvas(n,s).parent("visualizer"),e.colorMode(e.HSB),e.angleMode(e.DEGREES),mic=new p5.AudioIn,mic.start(),fft=new p5.FFT(WAYTOODANK.smoothing,128),fft.setInput(mic),w=n/128},e.draw=function(){e.background(0);let t=fft.analyze();try{obs.call("SetSourceFilterSettings",{sourceName:WAYTOODANK.source,filterName:"Color Grading",filterSettings:{"Filter.ColorGrade.Gamma.Red":t[red]/256*1e3,"Filter.ColorGrade.Gamma.Green":t[green]/256*1e3,"Filter.ColorGrade.Gamma.Blue":t[blue]/256*1e3,"Filter.ColorGrade.Correction.Hue":t[hue]/256*180,"Filter.ColorGrade.Correction.Saturation":t[sat]/256*1e3}})}catch(e){}for(let n=0;n<t.length;n++){let r=t[n],o=e.map(r,0,256,s,0);e.fill(n,255,255),e.rect(n*w,o,w-2,s-o)}}}}async function connectOBS(){let e="";if(/^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$/.test(WAYTOODANK.serverIP)||"localhost"==WAYTOODANK.serverIP){e=`ws://${WAYTOODANK.serverIP}:${WAYTOODANK.serverPort}`;try{await obs.connect(e,WAYTOODANK.serverPassword),startP5(),myp5=new p5(sketch)}catch(e){}}else showToast("Invalid server IP","danger",3e3)}window.onload=function(){load_localStorage(),refreshData(),elements.redslider.oninput=function(){red=this.value},elements.greenslider.oninput=function(){green=this.value},elements.blueslider.oninput=function(){blue=this.value},elements.hueslider.oninput=function(){hue=this.value},elements.satslider.oninput=function(){sat=this.value},elements.smoothingslider.oninput=function(){elements.smoothingvalue.innerHTML=`Smoothing: ${this.value}`,WAYTOODANK.smoothing=this.value},elements.connect.addEventListener("click",(function(){saveSettings(),connectOBS()})),enableTooltips();let e=document.createElement("script"),t=document.createElement("script");e.src="/waytoodank/p5.min.js",t.src="/waytoodank/p5.sound.min.js",document.getElementsByTagName("head")[0].appendChild(e),setTimeout((()=>{document.getElementsByTagName("head")[0].appendChild(t)}),1e3)};