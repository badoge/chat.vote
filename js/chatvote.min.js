const CLIENT_ID="qn0wimnszbqlwfnszdz3wwfz430eqr";let mainChart,client,table,timer,votePopover,suggestPopover,loginButton,optionField,deleteAllModal,randomOptionModal,resetSettingsModal,timeOverModal,yesnoTimeOverModal,loginExpiredModal,tieModal,randomYesnoModal,settingsCollapse,basicTab,advancedTab,contactTab,enableVotingDropdown,enableSuggestionsDropdown,tableTab,chartTab,yesnoTab,elements={deleteAllModal:document.getElementById("deleteAllModal"),resetPoll:document.getElementById("resetPoll"),randomOptionModal:document.getElementById("randomOptionModal"),randomOptionWinner:document.getElementById("randomOptionWinner"),randomOptionReroll:document.getElementById("randomOptionReroll"),resetSettingsModal:document.getElementById("resetSettingsModal"),resetSettings:document.getElementById("resetSettings"),timeOverModal:document.getElementById("timeOverModal"),timeOverWinner:document.getElementById("timeOverWinner"),removeWinner:document.getElementById("removeWinner"),yesnoTimeOverModal:document.getElementById("yesnoTimeOverModal"),yesnoTimeOverWinner:document.getElementById("yesnoTimeOverWinner"),restartYesno:document.getElementById("restartYesno"),loginExpiredModal:document.getElementById("loginExpiredModal"),loginExpiredRenew:document.getElementById("loginExpiredRenew"),loginExpiredReset:document.getElementById("loginExpiredReset"),tieModal:document.getElementById("tieModal"),randomYesnoModal:document.getElementById("randomYesnoModal"),coin:document.getElementById("coin"),randomYesnoReroll:document.getElementById("randomYesnoReroll"),vtsLink:document.getElementById("vtsLink"),status:document.getElementById("status"),topRight:document.getElementById("topRight"),loginButton:document.getElementById("loginButton"),channelName:document.getElementById("channelName"),connectbtn:document.getElementById("connectbtn"),darkTheme:document.getElementById("darkTheme"),enableVoting:document.getElementById("enableVoting"),enableVotingText:document.getElementById("enableVotingText"),enableVotingDropdown:document.getElementById("enableVotingDropdown"),voteWithNumbers:document.getElementById("voteWithNumbers"),voteWithText:document.getElementById("voteWithText"),timerValueMinutes:document.getElementById("timerValueMinutes"),enableSuggestions:document.getElementById("enableSuggestions"),enableSuggestionsText:document.getElementById("enableSuggestionsText"),suggestionsCommand:document.getElementById("suggestionsCommand"),enableSuggestionsDropdown:document.getElementById("enableSuggestionsDropdown"),suggestionLimitUser:document.getElementById("suggestionLimitUser"),suggestionLimit:document.getElementById("suggestionLimit"),suggestCommandLink:document.getElementById("suggestCommandLink"),restartPoll:document.getElementById("restartPoll"),deleteAll:document.getElementById("deleteAll"),hideScore:document.getElementById("hideScore"),hideScoreIcon:document.getElementById("hideScoreIcon"),pickRandom:document.getElementById("pickRandom"),unpauseTimer:document.getElementById("unpauseTimer"),pauseTimer:document.getElementById("pauseTimer"),stopTimer:document.getElementById("stopTimer"),settingsCollapse:document.getElementById("settingsCollapse"),basicTab:document.getElementById("basicTab"),advancedTab:document.getElementById("advancedTab"),contactTab:document.getElementById("contactTab"),remove:document.getElementById("remove"),removeAndRestart:document.getElementById("removeAndRestart"),multiChoice:document.getElementById("multiChoice"),multiChoiceExample:document.getElementById("multiChoiceExample"),allowChange:document.getElementById("allowChange"),subMode:document.getElementById("subMode"),suggestionPrefix:document.getElementById("suggestionPrefix"),showChat:document.getElementById("showChat"),refreshWarningEnabled:document.getElementById("refreshWarningEnabled"),linkPreviewThumbnailsEnabled:document.getElementById("linkPreviewThumbnailsEnabled"),confettiLevel:document.getElementById("confettiLevel"),getEmotes:document.getElementById("getEmotes"),bttvGlobalEmotes:document.getElementById("bttvGlobalEmotes"),bttvChannelEmotes:document.getElementById("bttvChannelEmotes"),ffzGlobalEmotes:document.getElementById("ffzGlobalEmotes"),ffzChannelEmotes:document.getElementById("ffzChannelEmotes"),seventvGlobalEmotes:document.getElementById("seventvGlobalEmotes"),seventvChannelEmotes:document.getElementById("seventvChannelEmotes"),voters_selected:document.getElementById("voters_selected"),json_selected:document.getElementById("json_selected"),txt_selected:document.getElementById("txt_selected"),download:document.getElementById("download"),optionList:document.getElementById("optionList"),addOptionBulk:document.getElementById("addOptionBulk"),toastContainer:document.getElementById("toastContainer"),hideQuestion:document.getElementById("hideQuestion"),countdown:document.getElementById("countdown"),chartContainer:document.getElementById("chartContainer"),voteHint:document.getElementById("voteHint"),chartCanvas:document.getElementById("chartCanvas"),barChart:document.getElementById("barChart"),pieChart:document.getElementById("pieChart"),sortChart:document.getElementById("sortChart"),sortChartLabel:document.getElementById("sortChartLabel"),totalVotes:document.getElementById("totalVotes"),questionLabel:document.getElementById("questionLabel"),pollOption:document.getElementById("pollOption"),pollOptionSpan:document.getElementById("pollOptionSpan"),addOption:document.getElementById("addOption"),tableTabButton:document.getElementById("tableTabButton"),chartTabButton:document.getElementById("chartTabButton"),yesnoTabButton:document.getElementById("yesnoTabButton"),enterPollOptionCard:document.getElementById("enterPollOptionCard"),options:document.getElementById("options"),settingsAccordion:document.getElementById("settingsAccordion"),chatiframe:document.getElementById("chatiframe"),chat:document.getElementById("chat"),subOnlyAlert:document.getElementById("subOnlyAlert"),yesnoDiv:document.getElementById("yesnoDiv"),yeaPic:document.getElementById("yeaPic"),nayPic:document.getElementById("nayPic"),yeaCount:document.getElementById("yeaCount"),nayCount:document.getElementById("nayCount"),yesnoTotalVotes:document.getElementById("yesnoTotalVotes")},voters=[],voters_options=[],vote_results=[],vote_changed=[],voters_yesno=[],voters_options_yesno=[],vote_results_yesno=[],oid=0,suggestions_enabled=!1,ctx="",voting_enabled=!1,numberOfSuggestions=0,suggestionLimitReached=!1,yesNoMode=!1,scoreHidden=!1,currentTime=0,channelBadges={subscriber:[],bits:[]},globalBadges={},customBadges=[],thirdPartyEmotes=[],darkTheme=!0;const spinner='<div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>';let USER={channel:"",twitchLogin:!1,access_token:"",userID:"",platform:""},CHATVOTE={chartType:"bar",sortChart:!1,showChat:!1,multiChoice:!1,allowChange:!1,subMode:!1,questionHidden:!1,suggestion_prefix:"!suggest",votingMode:"numbers",confettiLevel:0,suggestionLimitUser:1,suggestionLimit:0,timerValueMinutes:0,refreshWarningEnabled:!1,linkPreviewThumbnailsEnabled:!1};async function refreshData(){darkTheme=elements.darkTheme.checked??!0,USER.twitchLogin||(USER.channel=validator.escape(elements.channelName.value.replace(/\s+/g,"").toLowerCase()),USER.platform="twitch"),!USER.userID&&USER.channel&&(USER.userID=await getUserID(USER.channel)),CHATVOTE.suggestion_prefix=elements.suggestionPrefix.value.replace(/\s+/g,"").toLowerCase(),CHATVOTE.votingMode=elements.voteWithText.checked?"text":"numbers",CHATVOTE.chartType=elements.pieChart.checked?"pie":"bar",CHATVOTE.sortChart=elements.sortChart.checked,CHATVOTE.suggestion_prefix||(CHATVOTE.suggestion_prefix="!suggest",elements.suggestionPrefix.value="!suggest"),CHATVOTE.showChat=elements.showChat.checked,CHATVOTE.multiChoice=elements.multiChoice.checked,CHATVOTE.allowChange=elements.allowChange.checked,CHATVOTE.subMode=elements.subMode.checked,CHATVOTE.confettiLevel=parseInt(elements.confettiLevel.value,10),CHATVOTE.suggestionLimitUser=parseInt(elements.suggestionLimitUser.value,10),CHATVOTE.suggestionLimit=parseInt(elements.suggestionLimit.value,10),CHATVOTE.timerValueMinutes=parseFloat(elements.timerValueMinutes.value),ctx=elements.chartCanvas.getContext("2d"),CHATVOTE.refreshWarningEnabled=elements.refreshWarningEnabled.checked,CHATVOTE.linkPreviewThumbnailsEnabled=elements.linkPreviewThumbnailsEnabled.checked,elements.suggestionsCommand.innerHTML=CHATVOTE.suggestion_prefix}function saveSettings(){refreshData(),localStorage.setItem("USER",JSON.stringify(USER)),localStorage.setItem("CHATVOTE",JSON.stringify(CHATVOTE)),localStorage.setItem("darkTheme",darkTheme)}function load_localStorage(){localStorage.getItem("USER")&&(USER=JSON.parse(localStorage.getItem("USER")),elements.channelName.value=USER.channel),localStorage.getItem("CHATVOTE")&&(CHATVOTE=JSON.parse(localStorage.getItem("CHATVOTE")),"numbers"!==CHATVOTE.votingMode&&"text"!==CHATVOTE.votingMode&&(CHATVOTE.votingMode="numbers"),elements.voteWithNumbers.checked="numbers"===CHATVOTE.votingMode,elements.voteWithText.checked="text"===CHATVOTE.votingMode,"bar"!==CHATVOTE.chartType&&"pie"!==CHATVOTE.chartType&&(CHATVOTE.chartType="bar"),elements.barChart.checked="bar"===CHATVOTE.chartType,elements.pieChart.checked="pie"===CHATVOTE.chartType,elements.sortChart.checked=CHATVOTE.sortChart??!1,elements.suggestionPrefix.value=CHATVOTE.suggestion_prefix||"!suggest",elements.suggestionLimitUser.value=parseInt(CHATVOTE.suggestionLimitUser,10)??1,elements.suggestionLimit.value=parseInt(CHATVOTE.suggestionLimit,10)||0,elements.timerValueMinutes.value=parseFloat(CHATVOTE.timerValueMinutes)||0,elements.showChat.checked=CHATVOTE.showChat??!1,elements.multiChoice.checked=CHATVOTE.multiChoice??!1,elements.allowChange.checked=CHATVOTE.allowChange??!1,elements.subMode.checked=CHATVOTE.subMode??!1,elements.confettiLevel.value=CHATVOTE.confettiLevel||0,elements.refreshWarningEnabled.checked=CHATVOTE.refreshWarningEnabled??!1,elements.linkPreviewThumbnailsEnabled.checked=CHATVOTE.linkPreviewThumbnailsEnabled??!1,CHATVOTE.questionHidden?(elements.hideQuestion.innerHTML="arrow_drop_down",elements.questionLabel.style.display="none"):(elements.hideQuestion.innerHTML="arrow_drop_up",elements.questionLabel.style.display="block"),"numbers"===CHATVOTE.votingMode?elements.multiChoiceExample.innerText='Example: "1 2 3"':elements.multiChoiceExample.innerText='Example: "option1 option2 option3"',CHATVOTE.subMode?elements.subOnlyAlert.style.display="":elements.subOnlyAlert.style.display="none",CHATVOTE.showChat&&showChat(),elements.sortChart.checked&&elements.sortChartLabel.setAttribute("data-bs-title","Unsort chart"))}function resetSettings(e=!1){return e&&localStorage.setItem("USER",JSON.stringify({channel:"",twitchLogin:!1,access_token:"",userID:"",platform:""})),localStorage.setItem("CHATVOTE",JSON.stringify({chartType:"bar",sortChart:!1,showChat:!1,multiChoice:!1,allowChange:!1,subMode:!1,questionHidden:!1,suggestion_prefix:"!suggest",votingMode:"numbers",confettiLevel:0,suggestionLimitUser:1,suggestionLimit:0,timerValueMinutes:0,refreshWarningEnabled:!1,linkPreviewThumbnailsEnabled:!1})),location.reload(),!1}function resetPoll(){vote_results=[],voters=[],voters_options=[],vote_changed=[],oid=0,suggestionLimitReached=!1,startingHue=360*Math.random(),elements.voteHint.innerHTML="",mainChart.destroy(),table.clear().draw(),loadChart(),disableVoteButton(),disableSuggestButton(),changeSiteLinkTarget("_self")}function resetYesno(){vote_results_yesno={yea:0,nay:0},voters_yesno=[],voters_options_yesno=[],disableVoteButton(),disableSuggestButton(),updateYesNo()}async function removeAndRestart(){if(!checkLogin()||!checkEmpty())return;if(yesNoMode)return void showToast('This feature is unavailable while <img src="/pics/yeanay.webp" alt="yea nay" style="height:1.5em;" />Mode is on',"primary",5e3);sendData("chat.vote",USER.channel,"twitch"==USER.platform?`twitch - ${USER.twitchLogin}`:"youtube",{table:table.column(2).data().toArray(),scores:table.column(4).data().toArray()});let e=Math.min(parseInt(elements.remove.value,10),vote_results.length);voters=[],voters_options=[],vote_changed=[],mainChart.destroy();let t=structuredClone(vote_results);t.sort((function(e,t){return e.score>t.score?-1:e.score==t.score?0:1})),table.clear().draw(),vote_results=[];for(let n=0;n<e;n++)pushVoteResults(t[n].id,t[n].option,t[n].option_emotes,t[n].by,0,t[n].context),await pushTable(t[n].id,t[n].option_emotes,t[n].by,0,t[n].context);loadChart(),updateChart(),enableVoteButton()}async function restartPoll(){if(startingHue=360*Math.random(),yesNoMode)return void restartYesNoMode();let e=vote_results.length;voters=[],voters_options=[],vote_changed=[],mainChart.destroy();let t=structuredClone(vote_results);table.clear().draw(),vote_results=[];for(let n=0;n<e;n++)pushVoteResults(t[n].id,t[n].option,t[n].option_emotes,t[n].by,0,t[n].context),await pushTable(t[n].id,t[n].option_emotes,t[n].by,0,t[n].context);timer&&timer.isRunning()&&timer.reset(),loadChart(),updateChart()}function restartYesNoMode(){voters_yesno=[],voters_options_yesno=[],vote_results_yesno={yea:0,nay:0},updateYesNo(),startYesNo()}async function removeWinner(){if(!checkLogin()||!checkEmpty())return;if(yesNoMode)return void showToast('This feature is unavailable while <img src="/pics/yeanay.webp" alt="yea nay" style="height:1.5em;" />Mode is on',"primary",5e3);sendData("chat.vote",USER.channel,"twitch"==USER.platform?`twitch - ${USER.twitchLogin}`:"youtube",{table:table.column(2).data().toArray(),scores:table.column(4).data().toArray()});let e=structuredClone(vote_results);e.sort((function(e,t){return e.score<t.score?-1:e.score==t.score?0:1})),voters=[],voters_options=[],vote_changed=[],mainChart.destroy();let t=vote_results.length;table.clear().draw(),vote_results=[];for(let n=0;n<t-1;n++)pushVoteResults(e[n].id,e[n].option,e[n].option_emotes,e[n].by,0,e[n].context),await pushTable(e[n].id,e[n].option_emotes,e[n].by,0,e[n].context);loadChart(),updateChart(),timeOverModal.hide(),enableVoteButton()}function pickRandomOption(){if(!checkLogin()||!checkEmpty())return;if(yesNoMode)return randomYesnoModal.show(),void pickRandomYesNo();refreshData(),randomOptionModal.show();let e=Math.floor(Math.random()*vote_results.length),t=elements.questionLabel.innerHTML;elements.randomOptionWinner.innerHTML=`<h2>${t}</h2><h3>${vote_results[e].option_emotes}</h3>`,vote_results[e].by!=USER.channel&&(elements.randomOptionWinner.innerHTML+=`<h4>Submitted by: <button class="btn btn-secondary" onclick=window.open("https://www.twitch.tv/popout/${USER.channel}/viewercard/${vote_results[e].by}?popout=","_blank","width=340,height=800")>${vote_results[e].by}</button></h4>`),linkifyElementID("randomOptionWinner",CHATVOTE.linkPreviewThumbnailsEnabled),CHATVOTE.confettiLevel>0&&showConfetti(CHATVOTE.confettiLevel)}function pickRandomYesNo(){elements.coin.className="",setTimeout((()=>{elements.coin.classList.add(Math.random()<.5?"heads":"tails")}),100)}function login(){return elements.topRight.innerHTML='<div class="btn-group" role="group" aria-label="log in button group">\n    <button type="button" class="btn btn-twitch"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></button>\n    <div class="btn-group" role="group">\n        <button id="btnGroupDropLogin" type="button" class="btn btn-twitch dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">\n      </button>\n        <ul class="dropdown-menu dropdown-menu-lg-end" aria-labelledby="btnGroupDropLogin">\n            <li><a class="dropdown-item" onclick="logout()" href="#"><i class="material-icons notranslate">logout</i>Log out</a></li>\n        </ul>\n    </div>\n</div>',window.open("/prompt.html","loginWindow","toolbar=0,status=0,scrollbars=0,width=500px,height=800px"),!1}function connect(){elements.status.innerHTML='\n  <h4>\n  <span class="badge bg-warning">Connecting... \n  <div class="spinner-border" style="width:18px;height:18px;" role="status"><span class="visually-hidden">Loading...</span></div>\n  </span>\n  </h4>',elements.topRight.innerHTML='\n  <div class="btn-group" role="group" aria-label="log in button group">\n  <button type="button" class="btn btn-twitch"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></button>\n  <div class="btn-group" role="group">\n  <button id="btnGroupDropLogin" type="button" class="btn btn-twitch dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false"></button>\n  <ul class="dropdown-menu dropdown-menu-lg-end" aria-labelledby="btnGroupDrop1">\n  <li><a class="dropdown-item" onclick="logout()" href="#"><i class="material-icons notranslate">logout</i>Log out</a></li>\n  </ul>\n  </div>\n  </div>',refreshData(),getEmotes();let e={options:{clientId:CLIENT_ID,debug:!1},connection:{secure:!0,reconnect:!0},channels:[USER.channel]};client=new tmi.client(e),client.on("message",(async(e,t,n,o)=>{let s=n.split(" ").filter(Boolean),a=s[0].toLowerCase();if("numbers"==CHATVOTE.votingMode&&voting_enabled&&!yesNoMode){if(CHATVOTE.subMode&&!t.subscriber)return;if("!vote"==s[0].toLowerCase()&&(s=s.slice(1),0==s.length))return;if(isNaN(parseInt(s[0],10)))return;if(voters.includes(t.username)){if(!CHATVOTE.allowChange||vote_changed.includes(t.username))return;let e=voters.indexOf(t.username);voters.splice(e,1);let n=voters_options[e];voters_options.splice(e,1);for(let e=0;e<n.length;e++){let t=vote_results.findIndex((t=>t.option===n[e]));vote_results[t].score-=1}vote_changed.push(t.username),updateChart()}if(CHATVOTE.multiChoice&&s[1]){let e=[],n=!1,o=[];s=[...new Set([...s])];for(let t=0,n=s.length;t<n;t++)isNaN(parseInt(s[t],10))||e.push(parseInt(s[t],10));for(let t=0,s=e.length;t<s;t++){let s=vote_results.findIndex((n=>n.id===e[t]));-1!=s&&(o.push(vote_results[s].option),vote_results[s].score+=1,n=!0)}return void(n&&(t["first-msg"]&&firstMessageWarning(t.username),voters.push(t.username),voters_options.push(o),updateChart()))}{let e=vote_results.findIndex((e=>e.id===parseInt(s[0],10)));if(-1==e)return;return t["first-msg"]&&firstMessageWarning(t.username),voters.push(t.username),voters_options.push([vote_results[e].option]),vote_results[e].score+=1,void updateChart()}}if("text"==CHATVOTE.votingMode&&voting_enabled&&!yesNoMode){if(CHATVOTE.subMode&&!t.subscriber)return;if("!vote"==s[0].toLowerCase()&&(s=s.slice(1),0==s.length))return;if(voters.includes(t.username)){if(!CHATVOTE.allowChange||vote_changed.includes(t.username))return;let e=voters.indexOf(t.username);voters.splice(e,1);let n=voters_options[e];voters_options.splice(e,1);for(let e=0;e<n.length;e++){let t=vote_results.findIndex((t=>t.option===n[e]));vote_results[t].score-=1}vote_changed.push(t.username),updateChart()}if(CHATVOTE.multiChoice&&s[1]){let e=[],n=!1,o=[];s=[...new Set([...s])];for(let t=0,n=s.length;t<n;t++)e.push(s[t].toLowerCase());for(let t=0,s=e.length;t<s;t++){let s=vote_results.findIndex((n=>n.option_clean===e[t]));-1!=s&&(o.push(vote_results[s].option),vote_results[s].score+=1,n=!0)}return void(n&&(t["first-msg"]&&firstMessageWarning(t.username),voters.push(t.username),voters_options.push(o),updateChart()))}{let e=vote_results.findIndex((e=>e.option_clean===s[0].toLowerCase()));if(-1==e)return;return t["first-msg"]&&firstMessageWarning(t.username),voters.push(t.username),voters_options.push([vote_results[e].option]),vote_results[e].score+=1,void updateChart()}}if(yesNoMode&&voting_enabled&&("voteyea"==a||"votenay"==a||"yes"==a||"no"==a)){if(CHATVOTE.subMode&&!t.subscriber)return;if(voters_yesno.includes(t.username))return;return t["first-msg"]&&firstMessageWarning(t.username),"voteyea"==a||"yes"==a?(voters_yesno.push(t.username),voters_options_yesno.push("yea"),vote_results_yesno.yea+=1,void updateYesNo()):(voters_yesno.push(t.username),voters_options_yesno.push("nay"),vote_results_yesno.nay+=1,void updateYesNo())}if(a==CHATVOTE.suggestion_prefix&&suggestions_enabled){if(CHATVOTE.subMode&&!t.subscriber)return;let e=s.slice(1).join(" "),o=validator.escape(e),a=validator.escape(e),i=a.toLowerCase().replace(/\W/g,"");if("text"==CHATVOTE.votingMode&&(i=i.replace(/[^a-zA-Z0-9]+/g,"-")),!i)return;if(t.emotes){let e=[];for(const[o,s]of Object.entries(t.emotes))for(let t=0,a=s.length;t<a;t++){if(e.some((e=>e.id==o)))continue;let a=s[t].split("-");e.push({emote:n.substring(parseInt(a[0],10),parseInt(a[1],10)+1),id:o})}for(let t=0,n=e.length;t<n;t++){let n=`<img src="https://static-cdn.jtvnw.net/emoticons/v2/${e[t].id}/default/dark/1.0" title="${e[t].emote}" alt="${e[t].emote}" style="height:1.5em;">`;o=o.replaceAll(e[t].emote,n)}}if(o=replaceEmotes(o,thirdPartyEmotes),CHATVOTE.suggestionLimitUser>0&&vote_results.reduce(((e,n)=>n.by===t.username?++e:e),0)>=CHATVOTE.suggestionLimitUser)return;if(suggestionLimitReached)return void showToast("Viewer suggestion limit reached","warning",5e3);if(vote_results.some((e=>e.option_clean===i)))return;return CHATVOTE.suggestionLimit>0&&(numberOfSuggestions++,numberOfSuggestions>=CHATVOTE.suggestionLimit&&(suggestionLimitReached=!0)),oid++,await pushTable(oid,o,t.username,0,t),pushVoteResults(oid,a,o,t.username,0,t),void updateChart()}if(a==CHATVOTE.suggestion_prefix&&!suggestions_enabled&&(Date.now()-currentTime)/1e3>10)return currentTime=Date.now(),suggestPopover.show(),void setTimeout((function(){suggestPopover.hide()}),2e3);if("!confetti"==a)return t.username==USER.channel||"badoge"==t.username?void showConfetti(s[1]):69==Math.floor(200*Math.random())&&CHATVOTE.confettiLevel>0?void showConfetti(1):void 0;if("!rig"!=a||t.username!=USER.channel)if("!restart"!=a||t.username!=USER.channel)if("!reset"!=a||t.username!=USER.channel&&"badoge"!=t.username){if(!voting_enabled&&(Date.now()-currentTime)/1e3>10){if("!vote"==s[0].toLowerCase()&&(s=s.slice(1)),"numbers"==CHATVOTE.votingMode&&isNaN(parseInt(s[0],10)))return;if("text"==CHATVOTE.votingMode){if(-1==vote_results.findIndex((e=>e.option_clean===a)))return}else{if(-1==vote_results.findIndex((e=>e.id===parseInt(s[0],10))))return}return currentTime=Date.now(),votePopover.show(),void setTimeout((function(){votePopover.hide()}),2e3)}}else resetSettings();else restartPoll();else{let e=parseInt(s[1],10),t=parseInt(s[2],10);if(!isNaN(e)&&!isNaN(t)){let n=vote_results.findIndex((t=>t.id===e));return vote_results[n].score+=t,void updateChart()}}})),client.on("timeout",((e,t,n,o,s)=>{if(!voting_enabled)for(let e=vote_results.length-1;e>=0;e--)vote_results[e].by===t&&(Date.now()-vote_results[e].time)/1e3<5&&(table.rows((function(n,o,s){return o[0]==vote_results[e].id&&s.children[2].firstChild.dataset.username==t})).remove().draw(),vote_results.splice(e,1),updateChart(),showToast(`Removed ${t}'s suggestions because they got timed out`,"warning",2e3))})),client.on("connected",(async(e,t)=>{elements.status.innerHTML='<h4><span class="badge bg-success">Connected :)</span></h4>',saveSettings(),sendUsername("chat.vote",USER.channel,"twitch"==USER.platform?`twitch - ${USER.twitchLogin}`:"youtube"),await checkTags(USER.userID,USER.access_token)&&(elements.vtsLink.style.display=""),loadPFP()})),client.on("disconnected",(e=>{elements.status.innerHTML=`<h4><span class="badge bg-danger">Disconnected: ${e}</span></h4>`})),client.on("notice",((e,t,n)=>{elements.status.innerHTML=`<h4><span class="badge bg-danger">Disconnected: ${n}</span></h4>`})),client.connect().catch(console.error)}async function loadPFP(){if(!USER.channel)return void(elements.topRight.innerHTML=' <div class="btn-group" role="group" aria-label="login options">\n    <a\n      role="button"\n      id="loginButton"\n      class="btn btn-twitch"\n      tabindex="0"\n      data-bs-container="body"\n      data-bs-custom-class="custom-popover"\n      data-bs-placement="bottom"\n      data-bs-trigger="manual"\n      data-bs-toggle="popover"\n      data-bs-title="Not signed in"\n      data-bs-content="You need sign in first before adding options or enabling voting/suggestions"\n      ><span class="twitch-icon"></span>Sign in with Twitch</a\n    >\n    <div class="btn-group" role="group">\n      <button\n        id="btnGroupDropLogin"\n        type="button"\n        class="btn btn-twitch dropdown-toggle"\n        data-bs-toggle="dropdown"\n        data-bs-auto-close="outside"\n        aria-label="other login option, connect manually"\n        aria-expanded="false"\n      ></button>\n      <div class="dropdown-menu dropdown-menu-end" aria-labelledby="btnGroupDropLogin">\n        <div class="p-3" style="width: 300px">\n          <label for="channelName" class="form-label">Connect to chat directly</label>\n          <div class="input-group mb-3">\n            <span class="input-group-text" id="directLoginChannel">twitch.tv/</span>\n            <input type="text" class="form-control" id="channelName" aria-describedby="directLoginChannel" />\n          </div>\n          <small class="text-body-secondary">Some features will not be available if you connect directly</small><br />\n          <button type="button" id="connectbtn" class="btn btn-primary float-end">Connect</button>\n        </div>\n      </div>\n    </div>\n  </div>');let e=await get7TVPFP(USER.userID);"/pics/donk.png"==e&&USER.access_token&&(e=await getTwitchPFP(USER.channel,USER.access_token)),elements.topRight.innerHTML=`\n  <div class="btn-group" role="group" aria-label="Button group with nested dropdown">\n  <button type="button" id="btnGroupDrop2" class="btn btn-${darkTheme?"dark":"secondary"}"><img src="${e}" alt="profile pic" style="height:2em;"></button>\n  <div class="btn-group" role="group">\n  <button id="btnGroupDrop1" type="button" class="btn btn-${darkTheme?"dark":"secondary"} dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">\n  ${USER.channel}\n  </button>\n  <ul class="dropdown-menu dropdown-menu-lg-end" aria-labelledby="btnGroupDrop1">\n  <li><a class="dropdown-item" onclick="logout()" href="#"><i class="material-icons notranslate">logout</i>Log out</a></li>\n  </ul>\n  </div>\n  </div>`}async function getEmotes(){setTimeout((async()=>{let e=await getGlobalBTTVEmotes(),t=await getGlobalFFZEmotes(),n=await getGlobal7TVEmotes();if(elements.bttvGlobalEmotes.innerText=e.length,elements.ffzGlobalEmotes.innerText=t.length,elements.seventvGlobalEmotes.innerText=n.length,thirdPartyEmotes=[...thirdPartyEmotes,...e,...t,...n],USER.userID){let e=await getChannelBTTVEmotes(USER.userID),t=await getChannelFFZEmotes(USER.userID),n=await getChannel7TVEmotes(USER.userID);thirdPartyEmotes=[...thirdPartyEmotes,...e,...t,...n],elements.bttvChannelEmotes.innerText=e.length,elements.ffzChannelEmotes.innerText=t.length,elements.seventvChannelEmotes.innerText=n.length}}),3e3)}async function addBadges(e,t,n){try{let o="";n&&(o+='<i class="material-icons notranslate" style="color:#f18805;" title="First-time chatter">warning_amber</i>');for(let e=0;e<customBadges.length;e++)customBadges[e].users.includes(t)&&customBadges[e].sites.includes("chat.vote")&&(o+=`<img src="${customBadges[e].url}" class="chat-badge" title="${customBadges[e].name}"/>`);for(const t in e)if("subscriber"==t&&e.subscriber&&channelBadges.subscriber.length>0){o+=`<img src="${channelBadges.subscriber.find((t=>t.id===e.subscriber)).url}" class="chat-badge" title="Subscriber"/>`}else if("bits"==t&&channelBadges.bits.length>0){o+=`<img src="${channelBadges.bits.find((t=>t.id===e.bits)).url}" class="chat-badge" title="Bits"/>`}else if(Object.keys(globalBadges).length>0){o+=`<img src="${globalBadges[t].find((n=>n.id===e[t])).image_url_4x}" class="chat-badge" title="${t}"/>`}return o}catch(e){return""}}function startYesNo(){if(!checkLogin())return;vote_results_yesno={yea:0,nay:0},enableVoteButton(),disableSuggestButton();let e=document.getElementsByClassName("yesno-warning");for(let t=0;t<e.length;t++)e[t].style.display=""}function stopYesNo(){disableVoteButton(),resetYesno();let e=document.getElementsByClassName("yesno-warning");for(let t=0;t<e.length;t++)e[t].style.display="none"}function updateYesNo(){if(scoreHidden)return elements.yeaPic.style.height="150px",elements.nayPic.style.height="150px",elements.yeaCount.innerHTML="? Votes",elements.nayCount.innerHTML="? Votes",void(elements.yesnoTotalVotes.innerHTML="?");let e=Math.min(2,Math.max(.5,(1+vote_results_yesno.yea)/(1+vote_results_yesno.nay))),t=1/e;elements.yeaPic.style.height=150*e+"px",elements.nayPic.style.height=150*t+"px",elements.yeaCount.innerHTML=`${vote_results_yesno.yea} ${1==vote_results_yesno.yea?"Vote":"Votes"} (${Math.round(vote_results_yesno.yea/voters_yesno.length*100)||0}%)`,elements.nayCount.innerHTML=`${vote_results_yesno.nay} ${1==vote_results_yesno.nay?"Vote":"Votes"} (${Math.round(vote_results_yesno.nay/voters_yesno.length*100)||0}%)`,elements.yesnoTotalVotes.innerHTML=voters_yesno.length}function checkLogin(){return!!USER.channel||(loginButton.show(),setTimeout((function(){loginButton.hide()}),4e3),!1)}function checkEmpty(){return!!yesNoMode||(!(!vote_results[0]||!vote_results[1])||(optionField.show(),setTimeout((function(){optionField.hide()}),4e3),!1))}async function addOption(){if(!checkLogin())return;refreshData();let e=elements.pollOption.value;if(e.startsWith("http"))try{let t={method:"GET",redirect:"follow"};(await fetch(`https://helper.pepega.workers.dev/cors/?${e.split(" ")[0]}`,t)).headers.get("Content-Type").startsWith("image")&&(e=`<div class='resizable'><img src="${e.split(" ")[0]}"></div> ${e.split(" ").slice(1).join("")}`)}catch(e){}let t=e.toLowerCase().replace(/\W/g,"");!vote_results.some((e=>e.option_clean===t))&&t?(oid++,await pushTable(oid,replaceEmotes(e,thirdPartyEmotes),USER.channel,0,null),pushVoteResults(oid,e.replace(/<div.*?<\/div>/,"↖ Switch to Table view to see image :)"),replaceEmotes(e,thirdPartyEmotes),USER.channel,0,null),updateChart(),elements.pollOption.value=""):(showToast("Duplicate/invalid input","warning",5e3),elements.pollOption.value="")}async function addOptionBulk(){if(!checkLogin())return;if(yesNoMode)return void showToast('This feature is unavailable while <img src="/pics/yeanay.webp" alt="yeanay" style="height:1.5em;" />Mode is on',"primary",5e3);let e=elements.optionList.value.split(/\r?\n/);elements.optionList.value="";let t=e.filter(Boolean),n=[];for(let e=0,o=t.length;e<o;e++)if(n[e]=validator.escape(t[e]),t[e].startsWith("http"))try{let o={method:"GET",redirect:"follow"};(await fetch(`https://helper.pepega.workers.dev/cors/?${t[e].split(" ")[0]}`,o)).headers.get("Content-Type").startsWith("image")&&(n[e]=`<div class='resizable'><img src="${t[e].split(" ")[0]}"></div> ${t[e].split(" ").slice(1).join("")}`)}catch(e){}for(let e=0,t=n.length;e<t;e++){let t=n[e].toLowerCase().replace(/\W/g,"");!vote_results.some((e=>e.option_clean===t))&&t?(oid++,await pushTable(oid,replaceEmotes(n[e],thirdPartyEmotes),USER.channel,0,null),pushVoteResults(oid,n[e],replaceEmotes(n[e],thirdPartyEmotes),USER.channel,0,null),updateChart()):showToast("Some of the entered options were duplicate/invalid","warning",5e3)}}async function pushTable(e,t,n,o,s){let a=e;"text"==CHATVOTE.votingMode&&(a=t=t.replace(/[^a-zA-Z0-9]+/g,"-"));let i="",l="#FFFFFF",r=n;s&&(i=await addBadges(s.badges,s["user-id"],s["first-msg"]),l=s.color||"#FFFFFF",r=s["display-name"].toLowerCase()==n.toLowerCase()?s["display-name"]:`${s["display-name"]} (${n})`),table.row.add([e,a,t,`<p class="cursorPointer" data-username="${n}" style="color:${l};" onclick='window.open("https://www.twitch.tv/popout/${USER.channel}/viewercard/${n}?popout=","_blank","width=340,height=800")'>${i}${r}</p>`,o,'<button type="button" class="removebtn btn btn-danger"><i class="material-icons notranslate">delete_forever</i></button>']).draw(!1),linkifyElementID("options",CHATVOTE.linkPreviewThumbnailsEnabled),changeSiteLinkTarget("_blank")}let startingHue=360*Math.random();function pushVoteResults(e,t,n,o,s,a){let i=`hsla(${startingHue+=60*Math.random()+20}, 100%, 50%, 0.8)`,l=`${e} • "${t}"`,r=t.toLowerCase().replace(/\W/g,"");"text"==CHATVOTE.votingMode&&(l=`"${t=t.replace(/[^a-zA-Z0-9]+/g,"-")}"`,r=t.toLowerCase().replace(/[^a-zA-Z0-9]+/g,"-")),vote_results.push({id:e,option:t,option_clean:r,option_emotes:n,score:s,by:o,label:l,color:i,context:a,time:Date.now()}),updateHint()}function updateHint(){elements.voteHint.innerHTML=`Type ${vote_results.map((e=>e.id)).join("/").substring(0,8)}${vote_results.length>3?"...":""} in chat to vote. ${CHATVOTE.multiChoice?"Multiple choices allowed (separate by a space)":""}`,"text"==CHATVOTE.votingMode&&(elements.voteHint.innerHTML=`Type ${vote_results.map((e=>e.option)).join("/").substring(0,20)}${vote_results.length>3?"...":""} in chat to vote. ${CHATVOTE.multiChoice?"Multiple choices allowed (separate by a space)":""}`)}function download(){if(yesNoMode)return void showToast("Export Data does not support Yea/Nay mode for now :(","danger",2e3);if(!checkLogin()||!checkEmpty())return;let e=elements.questionLabel.innerHTML;if(elements.json_selected.checked)if(elements.voters_selected.checked){let t=voters.reduce(((e,t,n)=>({...e,[t]:voters_options[n]})),{}),n=URL.createObjectURL(new Blob([JSON.stringify(t,null,2)],{type:"application/json"})),o=document.createElement("a");o.setAttribute("href",n);let s=e?e+"-chatvote list of voters":"chatvote list of voters";o.setAttribute("download",`${(new Date).toISOString()}-${s}-${USER.channel}.json`),document.body.appendChild(o),o.click(),setTimeout((function(){document.body.removeChild(o),URL.revokeObjectURL(n)}),1e3)}else{let t=URL.createObjectURL(new Blob([JSON.stringify(vote_results,null,2)],{type:"application/json"})),n=document.createElement("a");n.setAttribute("href",t);let o=e?e+"-chatvote poll options":"chatvote poll options";n.setAttribute("download",`${(new Date).toISOString()}-${o}-${USER.channel}.json`),document.body.appendChild(n),n.click(),setTimeout((function(){document.body.removeChild(n),URL.revokeObjectURL(t)}),1e3)}else if(elements.txt_selected.checked)if(elements.voters_selected.checked){let t=voters.reduce(((e,t,n)=>({...e,[t]:voters_options[n]})),{}),n="Username\tOption\n";for(const[e,o]of Object.entries(t))n+=`${e}\t${o}\n`;let o=URL.createObjectURL(new Blob([n],{type:"application/json"})),s=document.createElement("a");s.setAttribute("href",o);let a=e?e+"-chatvote list of voters":"chatvote list of voters";s.setAttribute("download",`${(new Date).toISOString()}-${a}-${USER.channel}.txt`),document.body.appendChild(s),s.click(),setTimeout((function(){document.body.removeChild(s),URL.revokeObjectURL(o)}),1e3)}else{let t=Object.keys(vote_results[0]),n="";for(let e=0,o=t.length;e<o;e++)n+=t[e]+"\t";n+="\n";for(let e=0,t=vote_results.length;e<t;e++){for(const[t,o]of Object.entries(vote_results[e]))n+=o+"\t";n+="\n"}let o=URL.createObjectURL(new Blob([n],{type:"application/json"})),s=document.createElement("a");s.setAttribute("href",o);let a=e?e+"-chatvote poll options":"chatvote poll options";s.setAttribute("download",`${(new Date).toISOString()}-${a}-${USER.channel}.txt`),document.body.appendChild(s),s.click(),setTimeout((function(){document.body.removeChild(s),URL.revokeObjectURL(o)}),1e3)}else;}function loadChart(){refreshData(),mainChart&&mainChart.destroy(),"bar"==CHATVOTE.chartType?mainChart=new Chart(ctx,{type:"bar",data:{labels:["Nothing here :)"],datasets:[{label:"score",data:[],borderWidth:2}]},options:{indexAxis:"y",maintainAspectRatio:!1,scales:{x:{ticks:{color:"white"},beginAtZero:!0},y:{ticks:{textStrokeColor:"rgba(0,0,0,1)",textStrokeWidth:3,color:"white",mirror:!0,font:function(e){let t=vote_results.length,n=(e.chart.height+e.chart.width)/2;return{size:Math.round(n/18)-2*t}},z:1},beginAtZero:!0}},plugins:{tooltip:{enabled:!1},legend:{display:!1}}}}):"pie"==CHATVOTE.chartType&&(mainChart=new Chart(ctx,{type:"pie",data:{labels:["Nothing here :)"],datasets:[{label:"score",data:[],borderWidth:2}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,position:"right",onClick:null,labels:{color:"white",font:function(e){let t=vote_results.length,n=(e.chart.height+e.chart.width)/2;return{size:Math.round(n/32)-2*t}}}}}}}))}function updateChart(){let e=structuredClone(vote_results),t=[],n=[],o=[],s=0;CHATVOTE.sortChart&&!scoreHidden&&e.sort((function(e,t){return e.score>t.score?-1:e.score==t.score?0:1}));for(let t=0,n=e.length;t<n;t++)s+=e[t].score;for(let a=0,i=e.length;a<i;a++)t[a]=`${e[a].label} | ${e[a].score} ${1==e[a].score?"Vote":"Votes"} (${Math.round(e[a].score/s*100)||0}%)`,n[a]=e[a].score,scoreHidden&&(n[a]=0,t[a]=`${e[a].label} - score hidden`),o[a]=e[a].color,table.cell({row:a,column:4}).data(e[a].score);mainChart.data.labels=t,mainChart.data.datasets[0].data=n,mainChart.data.datasets[0].backgroundColor=o,mainChart.data.datasets[0].borderColor=o,mainChart.update(),elements.totalVotes.innerHTML=voters.length}function removeData(e){for(let t=vote_results.length-1;t>=0;t--)vote_results[t].id===e&&vote_results.splice(t,1);0==vote_results.length&&(oid=0,changeSiteLinkTarget("_self")),updateChart()}function hideScore(){scoreHidden=!scoreHidden,elements.hideScoreIcon.innerHTML=scoreHidden?"visibility_off":"visibility",yesNoMode?updateYesNo():(table.column(4).visible(!scoreHidden),updateChart())}function firstMessageWarning(e){showToast(`<i class="material-icons notranslate">warning_amber</i>${e}'s first ever message in chat was a vote.`,"warning",3e3)}function logout(){elements.topRight.innerHTML=' <div class="btn-group" role="group" aria-label="login options">\n  <a\n    role="button"\n    id="loginButton"\n    class="btn btn-twitch"\n    tabindex="0"\n    data-bs-container="body"\n    data-bs-custom-class="custom-popover"\n    data-bs-placement="bottom"\n    data-bs-trigger="manual"\n    data-bs-toggle="popover"\n    data-bs-title="Not signed in"\n    data-bs-content="You need sign in first before adding options or enabling voting/suggestions"\n    ><span class="twitch-icon"></span>Sign in with Twitch</a\n  >\n  <div class="btn-group" role="group">\n    <button\n      id="btnGroupDropLogin"\n      type="button"\n      class="btn btn-twitch dropdown-toggle"\n      data-bs-toggle="dropdown"\n      data-bs-auto-close="outside"\n      aria-label="other login option, connect manually"\n      aria-expanded="false"\n    ></button>\n    <div class="dropdown-menu dropdown-menu-end" aria-labelledby="btnGroupDropLogin">\n      <div class="p-3" style="width: 300px">\n        <label for="channelName" class="form-label">Connect to chat directly</label>\n        <div class="input-group mb-3">\n          <span class="input-group-text" id="directLoginChannel">twitch.tv/</span>\n          <input type="text" class="form-control" id="channelName" aria-describedby="directLoginChannel" />\n        </div>\n        <small class="text-body-secondary">Some features will not be available if you connect directly</small><br />\n        <button type="button" id="connectbtn" class="btn btn-primary float-end">Connect</button>\n      </div>\n    </div>\n  </div>\n</div>',resetSettings(!0)}function showChat(){checkLogin()&&(elements.chat.innerHTML||(elements.chat.innerHTML=`<iframe \n    id="chatiframe" \n    frameborder="0" \n    scrolling="yes" \n    src="https://www.twitch.tv/embed/${USER.channel}/chat?darkpopout&parent=chat.vote" \n    >\n    </iframe>`))}function hideChat(){if(checkLogin())for(;elements.chat.firstChild;)elements.chat.removeChild(elements.chat.firstChild)}function startTimer(){let e=60*parseFloat(elements.timerValueMinutes.value);!isNaN(e)&&0!=e&&checkLogin()&&checkEmpty()&&(timer=new easytimer.Timer,timer.addEventListener("secondTenthsUpdated",(function(e){document.querySelector("#countdown .values").innerHTML="Poll ends in "+timer.getTimeValues().toString(["minutes","seconds","secondTenths"])})),timer.addEventListener("targetAchieved",(function(e){if(elements.countdown.style.display="none",elements.unpauseTimer.style.display="none",elements.pauseTimer.style.display="none",elements.stopTimer.style.display="none",timer.reset(),timer.stop(),disableVoteButton(),yesNoMode){if(vote_results_yesno.nay==vote_results_yesno.yea)return void tieModal.show();elements.yesnoTimeOverWinner.innerHTML=`\n    <h2>${elements.questionLabel.innerHTML}</h2>\n    <h3>${vote_results_yesno.nay>vote_results_yesno.yea?'<img src="/pics/nay.webp" alt="nay" style="height: 100px" />':'<img  src="/pics/yea.webp" alt="yea" style="height: 100px" />'} has won with ${Math.max(vote_results_yesno.yea,vote_results_yesno.nay)} ${1==Math.max(vote_results_yesno.yea,vote_results_yesno.nay)?"vote":"votes"}!</h3>`,yesnoTimeOverModal.show()}else{let e=structuredClone(vote_results);if(e.sort((function(e,t){return e.score>t.score?-1:e.score==t.score?0:1})),e[0].score==e[1].score)return void tieModal.show();elements.timeOverWinner.innerHTML=`\n    <h2>${elements.questionLabel.innerHTML}</h2>\n    <h3>"${e[0].option_emotes}" has won with ${e[0].score} ${1==e[0].score?"vote":"votes"}!</h3>`,e[0].by!=USER.channel&&(elements.timeOverWinner.innerHTML+=`<h4>Submitted by: <button class="btn btn-secondary" onclick=window.open("https://www.twitch.tv/popout/${USER.channel}/viewercard/${e[0].by}?popout=","_blank","width=340,height=800")>${e[0].by}</button></h4>`),linkifyElementID("timeOverWinner",CHATVOTE.linkPreviewThumbnailsEnabled),timeOverModal.show()}CHATVOTE.confettiLevel>0&&showConfetti(CHATVOTE.confettiLevel)})),document.querySelector("#countdown .values").innerHTML="Poll ends in "+timer.getTimeValues().toString(["minutes","seconds","secondTenths"]),disableSuggestButton(),elements.countdown.style.display="",elements.pauseTimer.style.display="",elements.stopTimer.style.display="",timer.start({countdown:!0,precision:"secondTenths",startValues:{seconds:e}}))}function pauseTimer(){timer.isRunning()&&(timer.pause(),disableVoteButton(),elements.pauseTimer.style.display="none",elements.unpauseTimer.style.display="")}function unpauseTimer(){timer.isPaused()&&(timer.start(),enableVoteButton(),elements.pauseTimer.style.display="",elements.unpauseTimer.style.display="none")}function stopTimer(){timer.reset(),timer.stop(),voting_enabled&&disableVoteButton(),elements.countdown.style.display="none",elements.pauseTimer.style.display="none",elements.stopTimer.style.display="none",elements.unpauseTimer.style.display="none"}function enableVoteButton(){if(!checkLogin()||!checkEmpty())return;timer?timer.isPaused()?unpauseTimer():timer.isRunning()||startTimer():startTimer();let e=!1;for(let t=0;t<vote_results.length;t++)vote_results[t].option.startsWith("↖ Switch to Table view to see image :)")&&(e=!0);e||yesNoMode||chartTab.show(),voting_enabled=!0,elements.enterPollOptionCard.style.display="none",elements.enableVoting.classList.remove("btn-success"),elements.enableVoting.classList.add("btn-danger"),elements.enableVotingDropdown.classList.remove("btn-success"),elements.enableVotingDropdown.classList.add("btn-danger"),elements.enableVotingText.innerText="Stop Voting"}function disableVoteButton(){voting_enabled=!1,timer&&timer.isRunning()&&stopTimer(),elements.enterPollOptionCard.style.display="block",elements.enableVoting.classList.remove("btn-danger"),elements.enableVoting.classList.add("btn-success"),elements.enableVotingDropdown.classList.remove("btn-danger"),elements.enableVotingDropdown.classList.add("btn-success"),elements.enableVotingText.innerText="Start Voting"}async function enableSuggestButton(){checkLogin()&&(elements.suggestionsCommand.innerHTML=spinner,0==Object.keys(globalBadges).length&&(globalBadges=await getGlobalBadges()),0==channelBadges.subscriber.length&&(channelBadges=await getChannelBadges(USER.channel)),0==customBadges.length&&(customBadges=await getCustomBadges()),suggestions_enabled=!0,elements.enableSuggestions.classList.remove("btn-success"),elements.enableSuggestions.classList.add("btn-danger"),elements.enableSuggestionsDropdown.classList.remove("btn-success"),elements.enableSuggestionsDropdown.classList.add("btn-danger"),elements.enableSuggestionsText.innerText="Disable viewer suggestions",elements.suggestionsCommand.innerText=CHATVOTE.suggestion_prefix)}function disableSuggestButton(){suggestions_enabled=!1,elements.enableSuggestions.classList.remove("btn-danger"),elements.enableSuggestions.classList.add("btn-success"),elements.enableSuggestionsDropdown.classList.remove("btn-danger"),elements.enableSuggestionsDropdown.classList.add("btn-success"),elements.enableSuggestionsText.innerText="Enable viewer suggestions",elements.suggestionsCommand.innerText=CHATVOTE.suggestion_prefix}function changeSuggestionCommand(){enableSuggestionsDropdown.hide(),settingsCollapse.show(),basicTab.show(),elements.suggestionPrefix.focus(),elements.suggestionPrefix.select(),elements.suggestionPrefix.scrollIntoView()}function switchTheme(e){document.documentElement.setAttribute("data-bs-theme",e?"dark":"light"),document.getElementById("twitchLogo").style.filter=`invert(${e?.25:.65})`,document.getElementById("twitchLogo2").style.filter=`invert(${e?.25:.65})`,document.getElementById("btnGroupDrop1")&&document.getElementById("btnGroupDrop2")&&(document.getElementById("btnGroupDrop1").classList.remove(""+(e?"btn-secondary":"btn-dark")),document.getElementById("btnGroupDrop1").classList.add(""+(e?"btn-dark":"btn-secondary")),document.getElementById("btnGroupDrop2").classList.remove(""+(e?"btn-secondary":"btn-dark")),document.getElementById("btnGroupDrop2").classList.add(""+(e?"btn-dark":"btn-secondary")))}async function loadAndConnect(){load_localStorage(),refreshData();const e=new Proxy(new URLSearchParams(window.location.search),{get:(e,t)=>e.get(t)});if(e.channel&&!USER.channel&&!USER.twitchLogin&&!USER.access_token&&!USER.userID){let t=e.channel.replace(/\s+/g,"").toLowerCase();elements.channelName.value=t,USER.channel=t,window.history.replaceState({},document.title,"/")}if(USER.twitchLogin&&!await checkToken(USER.access_token))return USER.channel="",void loginExpiredModal.show();USER.channel&&connect()}window.onload=function(){darkTheme="true"===(localStorage.getItem("darkTheme")||"true"),elements.darkTheme.checked=darkTheme??!0,switchTheme(elements.darkTheme.checked),table=$("#options").DataTable({responsive:!0,retrieve:!0,paging:!1,scrollCollapse:!0,ordering:!1,searching:!1,info:!1,columns:[{width:"0%",visible:!1},{width:"15%"},{width:"52%"},{width:"17%"},{width:"10%"},{width:"6%"}],columnDefs:[{orderable:!1,targets:5}],language:{emptyTable:'Nothing here <img src="/pics/donk.png" alt="donk" style="height:28px; width:28px;">'}}),elements.pollOption.focus(),elements.pollOption.select(),loadAndConnect(),optionField=new bootstrap.Popover(elements.pollOptionSpan),votePopover=new bootstrap.Popover(elements.enableVoting),suggestPopover=new bootstrap.Popover(elements.enableSuggestions),USER.channel||(loginButton=new bootstrap.Popover(elements.loginButton)),deleteAllModal=new bootstrap.Modal(elements.deleteAllModal),randomOptionModal=new bootstrap.Modal(elements.randomOptionModal),resetSettingsModal=new bootstrap.Modal(elements.resetSettingsModal),timeOverModal=new bootstrap.Modal(elements.timeOverModal),yesnoTimeOverModal=new bootstrap.Modal(elements.yesnoTimeOverModal),loginExpiredModal=new bootstrap.Modal(elements.loginExpiredModal),tieModal=new bootstrap.Modal(elements.tieModal),randomYesnoModal=new bootstrap.Modal(elements.randomYesnoModal),settingsCollapse=new bootstrap.Collapse(elements.settingsCollapse,{toggle:!1}),enableVotingDropdown=new bootstrap.Dropdown(elements.enableVotingDropdown),enableSuggestionsDropdown=new bootstrap.Dropdown(elements.enableSuggestionsDropdown),basicTab=new bootstrap.Tab(elements.basicTab),advancedTab=new bootstrap.Tab(elements.advancedTab),contactTab=new bootstrap.Tab(elements.contactTab),tableTab=new bootstrap.Tab(elements.tableTabButton),chartTab=new bootstrap.Tab(elements.chartTabButton),yesnoTab=new bootstrap.Tab(elements.yesnoTabButton),elements.tableTabButton.addEventListener("shown.bs.tab",(e=>{yesNoMode&&(yesNoMode=!1,stopYesNo()),elements.enterPollOptionCard.style.display="block"})),elements.chartTabButton.addEventListener("shown.bs.tab",(e=>{yesNoMode&&(yesNoMode=!1,stopYesNo()),elements.enterPollOptionCard.style.display="block"})),elements.yesnoTabButton.addEventListener("shown.bs.tab",(e=>{yesNoMode=!0,startYesNo(),elements.enterPollOptionCard.style.display="none"})),elements.settingsAccordion.addEventListener("hide.bs.collapse",(function(){saveSettings()})),enableTooltips(),enablePopovers(),elements.questionLabel.addEventListener("keydown",(e=>{"Enter"===e.key&&elements.questionLabel.blur()})),elements.enableVoting.addEventListener("click",(function(){voting_enabled?disableVoteButton():enableVoteButton()})),elements.enableSuggestions.addEventListener("click",(function(){suggestions_enabled?disableSuggestButton():enableSuggestButton()})),elements.hideQuestion.addEventListener("click",(function(){"arrow_drop_up"==elements.hideQuestion.innerHTML?(CHATVOTE.questionHidden=!0,elements.hideQuestion.innerHTML="arrow_drop_down",elements.questionLabel.style.display="none"):(CHATVOTE.questionHidden=!1,elements.hideQuestion.innerHTML="arrow_drop_up",elements.questionLabel.style.display="block"),saveSettings()})),elements.pollOption.addEventListener("keydown",(e=>{"Enter"===e.key&&addOption()})),elements.channelName.addEventListener("keydown",(e=>{"Enter"===e.key&&connect()})),elements.darkTheme.onchange=function(){switchTheme(this.checked),saveSettings()},elements.voteWithNumbers.onchange=async function(){this.checked&&(elements.multiChoiceExample.innerText='Example: "1 2 3"',CHATVOTE.votingMode="numbers"),saveSettings(),await restartPoll(),updateHint()},elements.voteWithText.onchange=async function(){this.checked&&(elements.multiChoiceExample.innerText='Example: "option1 option2 option3"',CHATVOTE.votingMode="text"),saveSettings(),await restartPoll(),updateHint()},elements.barChart.onchange=function(){saveSettings(),loadChart(),updateChart()},elements.pieChart.onchange=function(){saveSettings(),loadChart(),updateChart()},elements.sortChart.onchange=function(){bootstrap.Tooltip.getInstance("#sortChartLabel").setContent({".tooltip-inner":this.checked?"Unsort chart":"Sort chart"}),saveSettings(),loadChart(),updateChart()},elements.suggestionLimitUser.onchange=function(){saveSettings()},elements.suggestionLimit.onchange=function(){let e=parseInt(this.value,10);(e>CHATVOTE.suggestionLimit||0==e)&&(suggestionLimitReached=!1),saveSettings()},elements.suggestionPrefix.oninput=function(){elements.suggestionsCommand.innerHTML=this.value,saveSettings()},elements.timerValueMinutes.onchange=function(){saveSettings()},elements.confettiLevel.onchange=function(){CHATVOTE.confettiLevel=parseInt(this.value,10),saveSettings()},elements.refreshWarningEnabled.onchange=function(){saveSettings()},elements.linkPreviewThumbnailsEnabled.onchange=function(){saveSettings();[...document.querySelectorAll("a.linktooltip")].map((function(e){return e.setAttribute("data-bs-title",spinner),e.addEventListener("show.bs.tooltip",(function(){getLinkInfo(e,CHATVOTE.linkPreviewThumbnailsEnabled)})),new bootstrap.Tooltip(e,{animation:!1,html:!0,delay:{show:200,hide:0}})}))},elements.showChat.onchange=function(){CHATVOTE.showChat=this.checked,this.checked?showChat():hideChat(),saveSettings()},elements.multiChoice.onchange=function(){saveSettings(),updateHint()},elements.allowChange.onchange=function(){saveSettings()},elements.subMode.onchange=function(){this.checked?elements.subOnlyAlert.style.display="":elements.subOnlyAlert.style.display="none",saveSettings()},$("#options").on("click",".removebtn",(function(){let e=table.row($(this).parents("tr")).data();e[4]>0&&showToast('Someone already voted for the option you just deleted, you should <i class="material-icons notranslate">refresh</i>Restart the poll so they can vote again.',"warning",7e3),removeData(e[0]),table.row($(this).parents("tr")).remove().draw(),updateHint()})),loadChart(),elements.connectbtn.addEventListener("click",(function(){connect()})),elements.suggestCommandLink.addEventListener("click",(function(){changeSuggestionCommand()})),elements.resetPoll.addEventListener("click",(function(){resetPoll()})),elements.randomOptionReroll.addEventListener("click",(function(){pickRandomOption()})),elements.resetSettings.addEventListener("click",(function(){resetSettings()})),elements.loginExpiredRenew.addEventListener("click",(function(){login()})),elements.loginButton.addEventListener("click",(function(){login()})),elements.addOption.addEventListener("click",(function(){addOption()})),elements.deleteAll.addEventListener("click",(function(){yesNoMode?restartPoll():deleteAllModal.show()})),elements.restartPoll.addEventListener("click",(function(){restartPoll()})),elements.loginExpiredReset.addEventListener("click",(function(){resetSettings(!0)})),elements.removeWinner.addEventListener("click",(function(){removeWinner()})),elements.restartYesno.addEventListener("click",(function(){yesnoTimeOverModal.hide(),restartYesNoMode()})),elements.getEmotes.addEventListener("click",(function(){getEmotes()})),elements.download.addEventListener("click",(function(){download()})),elements.addOptionBulk.addEventListener("click",(function(){addOptionBulk()})),elements.pickRandom.addEventListener("click",(function(){timer&&timer.isRunning()&&stopTimer(),pickRandomOption()})),elements.coin.addEventListener("click",(function(){pickRandomYesNo()})),elements.randomYesnoReroll.addEventListener("click",(function(){pickRandomYesNo()})),elements.hideScore.addEventListener("click",(function(){bootstrap.Tooltip.getInstance("#hideScore").setContent({".tooltip-inner":scoreHidden?"Hide score":"Show score"}),hideScore()})),elements.removeAndRestart.addEventListener("click",(function(){removeAndRestart()})),elements.stopTimer.addEventListener("click",(function(){stopTimer()})),elements.pauseTimer.addEventListener("click",(function(){pauseTimer()})),elements.unpauseTimer.addEventListener("click",(function(){unpauseTimer()}))},window.onbeforeunload=function(){return sendData("chat.vote",USER.channel,"twitch"==USER.platform?`twitch - ${USER.twitchLogin}`:"youtube",{table:table.column(2).data().toArray(),scores:table.column(4).data().toArray()}),CHATVOTE.refreshWarningEnabled&&(vote_results.length>0||vote_results_yesno.yea>0||vote_results_yesno.nay>0)?"Close/refresh warning enabled. You can turn it off in the advanced settings tab.":null};